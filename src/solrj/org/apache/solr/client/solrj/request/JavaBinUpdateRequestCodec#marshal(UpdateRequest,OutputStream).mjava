  /**
   * Converts an UpdateRequest to a NamedList which can be serialized to the given OutputStream in the javabin format
   *
   * @param updateRequest the UpdateRequest to be written out
   * @param os            the OutputStream to which the request is to be written
   *
   * @throws IOException in case of an exception during marshalling or writing to the stream
   */
  public void marshal(UpdateRequest updateRequest, OutputStream os) throws IOException {
    JavaBinCodec codec = new JavaBinCodec();
    NamedList nl = new NamedList();
    NamedList params = solrParamsToNamedList(updateRequest.getParams());
    if (updateRequest.getCommitWithin() != -1) {
      params.add("commitWithin", updateRequest.getCommitWithin());
    }
    List<List<NamedList>> doclist = new ArrayList<List<NamedList>>();
    if (updateRequest.getDocuments() != null) {
      for (SolrInputDocument doc : updateRequest.getDocuments()) {
        doclist.add(solrInputDocumentToList(doc));
      }

    }

    nl.add("params", params);// 0: params
    nl.add("delById", updateRequest.getDeleteById());
    nl.add("delByQ", updateRequest.getDeleteQuery());
    nl.add("docs", doclist.iterator());
    codec.marshal(nl, os);
  }

