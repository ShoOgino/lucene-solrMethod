  public void testNormsRefCounting() throws IOException {
    Directory dir1 = new MockRAMDirectory();
    createIndex(dir1, false);
    
    SegmentReader reader1 = (SegmentReader) IndexReader.open(dir1);
    IndexReader modifier = IndexReader.open(dir1);
    modifier.deleteDocument(0);
    modifier.close();
    
    SegmentReader reader2 = (SegmentReader) reader1.reopen();
    modifier = IndexReader.open(dir1);
    modifier.setNorm(1, "field1", 50);
    modifier.setNorm(1, "field2", 50);
    modifier.close();
    
    SegmentReader reader3 = (SegmentReader) reader2.reopen();
    modifier = IndexReader.open(dir1);
    modifier.deleteDocument(2);
    modifier.close();

    SegmentReader reader4 = (SegmentReader) reader3.reopen();
    modifier = IndexReader.open(dir1);
    modifier.deleteDocument(3);
    modifier.close();

    SegmentReader reader5 = (SegmentReader) reader3.reopen();
    
    // Now reader2-reader5 references reader1. reader1 and reader2
    // share the same norms. reader3, reader4, reader5 also share norms.
    assertRefCountEquals(5, reader1);
    assertFalse(reader1.normsClosed());

    reader1.close();

    assertRefCountEquals(4, reader1);
    assertFalse(reader1.normsClosed());

    reader2.close();
    assertRefCountEquals(3, reader1);

    // now the norms for field1 and field2 should be closed
    assertTrue(reader1.normsClosed("field1"));
    assertTrue(reader1.normsClosed("field2"));

    // but the norms for field3 and field4 should still be open
    assertFalse(reader1.normsClosed("field3"));
    assertFalse(reader1.normsClosed("field4"));
    
    reader3.close();
    assertRefCountEquals(2, reader1);
    assertFalse(reader3.normsClosed());
    reader5.close();
    assertRefCountEquals(1, reader1);
    assertFalse(reader3.normsClosed());
    reader4.close();
    assertRefCountEquals(0, reader1);
    
    // and now all norms that reader1 used should be closed
    assertTrue(reader1.normsClosed());
    
    // now that reader3, reader4 and reader5 are closed,
    // the norms that those three readers shared should be
    // closed as well
    assertTrue(reader3.normsClosed());

    dir1.close();
  }

