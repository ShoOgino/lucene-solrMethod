  public void writeStr(String name, String val, boolean needsEscaping) throws IOException {
    // it might be more efficient to use a stringbuilder or write substrings
    // if writing chars to the stream is slow.
    if (needsEscaping) {


     /* http://www.ietf.org/internet-drafts/draft-crockford-jsonorg-json-04.txt
      All Unicode characters may be placed within
      the quotation marks except for the characters which must be
      escaped: quotation mark, reverse solidus, and the control
      characters (U+0000 through U+001F).
     */

      StringBuilder sb = new StringBuilder(val.length()+8);
      sb.append('"');

      for (int i=0; i<val.length(); i++) {
        char ch = val.charAt(i);
        switch(ch) {
          case '"':
          case '\\':
            sb.append('\\');
            sb.append(ch);
            break;
          case '\r': sb.append('\\').append('r'); break;
          case '\n': sb.append('\\').append('n'); break;
          case '\t': sb.append('\\').append('t'); break;
          case '\b': sb.append('\\').append('b'); break;
          case '\f': sb.append('\\').append('f'); break;
          // case '/':
          default: {
            if (ch <= 0x1F) {
              unicodeEscape(sb,ch);
            } else {
              sb.append(ch);
            }
          }
        }
      }

      sb.append('"');
      writer.append(sb);
    } else {
      writer.write('"');
      writer.write(val);
      writer.write('"');
    }
  }

