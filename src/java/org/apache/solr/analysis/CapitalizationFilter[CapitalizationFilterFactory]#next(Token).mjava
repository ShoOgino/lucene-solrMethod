  @Override
  public Token next(Token token) throws IOException {
    Token t = input.next(token);
    if (t != null) {

      char[] termBuffer = t.termBuffer();
      int termBufferLength = t.termLength();
      char[] backup = null;
      if (factory.maxWordCount < CapitalizationFilterFactory.DEFAULT_MAX_WORD_COUNT) {
        //make a backup in case we exceed the word count
        System.arraycopy(termBuffer, 0, backup, 0, termBufferLength);
      }
      if (termBufferLength < factory.maxTokenLength) {
        int wordCount = 0;

        int lastWordStart = 0;
        for (int i = 0; i < termBufferLength; i++) {
          char c = termBuffer[i];
          if (c <= ' ' || c == '.') {
            int len = i - lastWordStart;
            if (len > 0) {
              factory.processWord(termBuffer, lastWordStart, len, wordCount++);
              lastWordStart = i + 1;
              i++;
            }
          }
        }

        // process the last word
        if (lastWordStart < termBufferLength) {
          factory.processWord(termBuffer, lastWordStart, termBufferLength - lastWordStart, wordCount++);
        }

        if (wordCount > factory.maxWordCount) {
          t.setTermBuffer(backup, 0, termBufferLength);
        }
      }
    }
    return t;
  }

