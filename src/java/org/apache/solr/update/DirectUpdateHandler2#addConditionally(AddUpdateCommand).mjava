  protected int addConditionally(AddUpdateCommand cmd) throws IOException {
    if (cmd.id==null) {
      cmd.id=getId(cmd.doc);
    }
    synchronized(this) {
      Integer saveCount = pset.get(cmd.id);
      if (saveCount!=null && saveCount!=0) {
        // a doc with this id already exists in the pending set
        return 0;
      }
      pset.put(cmd.id, ONE);
      doAdd(cmd.doc);
      return 1;
    }
  }

