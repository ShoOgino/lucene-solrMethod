  public Query rewrite(IndexReader reader) throws IOException {
    if (!constantScoreRewrite) {
      FilteredTermEnum enumerator = getEnum(reader);
      BooleanQuery query = new BooleanQuery(true);
      try {
        do {
          Term t = enumerator.term();
          if (t != null) {
            numberOfTerms++;
            TermQuery tq = new TermQuery(t); // found a match
            tq.setBoost(getBoost() * enumerator.difference()); // set the boost
            query.add(tq, BooleanClause.Occur.SHOULD); // add to query
          }
        } while (enumerator.next());
      } finally {
        enumerator.close();
      }
      return query;
    } else {
      Query query = new ConstantScoreQuery(getFilter());
      query.setBoost(getBoost());
      return query;
    }
  }

