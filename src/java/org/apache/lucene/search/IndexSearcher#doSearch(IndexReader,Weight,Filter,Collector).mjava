  private void doSearch(IndexReader reader, Weight weight, Filter filter,
      final Collector collector) throws IOException {

    Scorer scorer = weight.scorer(reader);
    if (scorer == null)
      return;

    int docID = scorer.docID();
    assert docID == -1 || docID == DocIdSetIterator.NO_MORE_DOCS;
    
    if (filter == null) {
      scorer.score(collector);
      return;
    }

    // CHECKME: use ConjunctionScorer here?
    DocIdSetIterator filterIter = filter.getDocIdSet(reader).iterator();
    
    int filterDoc = filterIter.nextDoc();
    int scorerDoc = scorer.advance(filterDoc);
    
    collector.setScorer(scorer);
    while (true) {
      if (scorerDoc == filterDoc) {
        // Check if scorer has exhausted, only before collecting.
        if (scorerDoc == DocIdSetIterator.NO_MORE_DOCS) {
          break;
        }
        collector.collect(scorerDoc);
        filterDoc = filterIter.nextDoc();
        scorerDoc = scorer.advance(filterDoc);
      } else if (scorerDoc > filterDoc) {
        filterDoc = filterIter.advance(scorerDoc);
      } else {
        scorerDoc = scorer.advance(filterDoc);
      }
    }
  }

