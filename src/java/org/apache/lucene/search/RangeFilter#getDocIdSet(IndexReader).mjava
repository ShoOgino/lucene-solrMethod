    /**
     * Returns a DocIdSet with documents that should be
     * permitted in search results.
     */
    public DocIdSet getDocIdSet(IndexReader reader) throws IOException {
        OpenBitSet bits = new OpenBitSet(reader.maxDoc());
        
        TermEnum enumerator =
            (null != lowerTerm && collator == null
             ? reader.terms(new Term(fieldName, lowerTerm))
             : reader.terms(new Term(fieldName)));
        
        try {
            
            if (enumerator.term() == null) {
                return bits;
            }

            TermDocs termDocs = reader.termDocs();

            try {
                if (collator != null) {
                    do {
                        Term term = enumerator.term();
                        if (term != null && term.field().equals(fieldName)) {
                            if ((lowerTerm == null
                                 || (includeLower
                                     ? collator.compare(term.text(), lowerTerm) >= 0
                                     : collator.compare(term.text(), lowerTerm) > 0))
                                && (upperTerm == null
                                    || (includeUpper
                                        ? collator.compare(term.text(), upperTerm) <= 0
                                        : collator.compare(term.text(), upperTerm) < 0))) {
                                /* we have a good term, find the docs */
                                termDocs.seek(enumerator.term());
                                while (termDocs.next()) {
                                    bits.set(termDocs.doc());
                                }
                            }
                        }
                    }
                    while (enumerator.next());
                } else { // collator is null - use Unicode code point ordering
                    boolean checkLower = false;
                    if (!includeLower) // make adjustments to set to exclusive
                        checkLower = true;
        
                    do {
                        Term term = enumerator.term();
                        if (term != null && term.field().equals(fieldName)) {
                            if (!checkLower || null==lowerTerm || term.text().compareTo(lowerTerm) > 0) {
                                checkLower = false;
                                if (upperTerm != null) {
                                    int compare = upperTerm.compareTo(term.text());
                                    /* if beyond the upper term, or is exclusive and
                                     * this is equal to the upper term, break out */
                                    if ((compare < 0) ||
                                        (!includeUpper && compare==0)) {
                                        break;
                                    }
                                }
                                /* we have a good term, find the docs */
                            
                                termDocs.seek(enumerator.term());
                                while (termDocs.next()) {
                                    bits.set(termDocs.doc());
                                }
                            }
                        } else {
                            break;
                        }
                    }
                    while (enumerator.next());
                }
                
            } finally {
                termDocs.close();
            }
        } finally {
            enumerator.close();
        }

        return bits;
    }

