    /**
     * Returns a BitSet with true for documents which should be
     * permitted in search results, and false for those that should
     * not.
     */
    public BitSet bits(IndexReader reader) throws IOException {
        BitSet bits = new BitSet(reader.maxDoc());
        TermEnum enumerator = reader.terms(new Term(field, start));
        TermDocs termDocs = reader.termDocs();
        if (enumerator.term() == null) {
            return bits;
        }

        try {
            Term stop = new Term(field, end);
            while (enumerator.term().compareTo(stop) <= 0) {
                termDocs.seek(enumerator.term());
                try {
                    while (termDocs.next()) {
                        bits.set(termDocs.doc());
                    }
                } finally {
                    termDocs.close();
                }
                if (!enumerator.next()) {
                    break;
                }
            }
        } finally {
            enumerator.close();
        }
        return bits;
    }

