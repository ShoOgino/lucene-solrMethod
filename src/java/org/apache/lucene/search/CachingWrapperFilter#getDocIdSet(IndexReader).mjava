  public DocIdSet getDocIdSet(IndexReader reader) throws IOException {
    if (cache == null) {
      cache = new WeakHashMap();
    }

    Object cached = null;
    synchronized (cache) {  // check cache
      cached = cache.get(reader);
    }

    if (cached != null) {
      if (cached instanceof DocIdSet)
        return (DocIdSet) cached;
      else
        return new DocIdBitSet((BitSet) cached);
    }

    final DocIdSet docIdSet = docIdSetToCache(filter.getDocIdSet(reader), reader);

    synchronized (cache) {  // update cache
      cache.put(reader, docIdSet);
    }

    return docIdSet;
    
  }

