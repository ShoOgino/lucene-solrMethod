  public DocIdSet getDocIdSet(IndexReader reader) throws IOException {
    if (cache == null) {
      cache = new WeakHashMap<IndexReader, DocIdSet>();
    }

    DocIdSet cached = null;
    synchronized (cache) {  // check cache
      cached = cache.get(reader);
    }

    if (cached != null) {
      return cached;
    }

    final DocIdSet docIdSet = docIdSetToCache(filter.getDocIdSet(reader), reader);

    if (docIdSet != null) {
      synchronized (cache) {  // update cache
        cache.put(reader, docIdSet);
      }
    }

    return docIdSet;
  }

