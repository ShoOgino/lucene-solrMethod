  public boolean equals(Object obj) {
    if (obj == this) {
      return true;
    }

    if (obj instanceof AttributeSource) {
      AttributeSource other = (AttributeSource) obj;  
    
      if (hasAttributes()) {
        if (!other.hasAttributes()) {
          return false;
        }
        
        if (this.attributeImpls.size() != other.attributeImpls.size()) {
          return false;
        }
  
        // it is only equal if all attribute impls are the same in the same order
        Iterator thisIt = this.getAttributeImplsIterator();
        Iterator otherIt = other.getAttributeImplsIterator();
        while (thisIt.hasNext() && otherIt.hasNext()) {
          AttributeImpl thisAtt = (AttributeImpl) thisIt.next();
          AttributeImpl otherAtt = (AttributeImpl) otherIt.next();
          if (otherAtt.getClass() != thisAtt.getClass() || !otherAtt.equals(thisAtt)) {
            return false;
          }
        }
        return true;
      } else {
        return !other.hasAttributes();
      }
    } else
      return false;
  }

