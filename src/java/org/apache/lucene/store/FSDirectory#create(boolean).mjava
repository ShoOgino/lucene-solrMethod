  private synchronized void create(boolean doRemoveOldFiles) throws IOException {
    if (!directory.exists())
      if (!directory.mkdirs())
        throw new IOException("Cannot create directory: " + directory);

    if (!directory.isDirectory())
      throw new IOException(directory + " not a directory");

    if (doRemoveOldFiles) {
      String[] files = directory.list(IndexFileNameFilter.getFilter());            // clear old files
      if (files == null)
        throw new IOException("Cannot read directory " + directory.getAbsolutePath());
      for (int i = 0; i < files.length; i++) {
        File file = new File(directory, files[i]);
        if (!file.delete())
          throw new IOException("Cannot delete " + file);
      }
    }

    if (lockFactory.getLockPrefix() != null) {
      lockFactory.clearAllLocks();
    } else {
      // Lock file is stored in the index, so we just remove
      // it ourselves here:
      File lockFile = new File(directory, IndexWriter.WRITE_LOCK_NAME);
      if (lockFile.exists() && !lockFile.delete())
        throw new IOException("Cannot delete " + lockFile);
    }
  }

