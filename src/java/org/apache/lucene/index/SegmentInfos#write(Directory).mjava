  public final void write(Directory directory) throws IOException {

    // Always advance the generation on write:
    if (generation == -1) {
      generation = 1;
    } else {
      generation++;
    }

    String segmentFileName = getCurrentSegmentFileName();
    IndexOutput output = directory.createOutput(segmentFileName);

    try {
      output.writeInt(FORMAT_LOCKLESS); // write FORMAT
      output.writeLong(++version); // every write changes
                                   // the index
      output.writeInt(counter); // write counter
      output.writeInt(size()); // write infos
      for (int i = 0; i < size(); i++) {
        SegmentInfo si = info(i);
        si.write(output);
      }         
    }
    finally {
      output.close();
    }

    try {
      output = directory.createOutput(IndexFileNames.SEGMENTS_GEN);
      output.writeInt(FORMAT_LOCKLESS);
      output.writeLong(generation);
      output.writeLong(generation);
      output.close();
    } catch (IOException e) {
      // It's OK if we fail to write this file since it's
      // used only as one of the retry fallbacks.
    }
  }

