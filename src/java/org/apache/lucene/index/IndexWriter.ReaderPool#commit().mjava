    /**
     * Commit all segment reader in the pool.
     * @throws IOException
     */
    synchronized void commit() throws IOException {
      Iterator iter = readerMap.entrySet().iterator();
      while (iter.hasNext()) {
        Map.Entry ent = (Map.Entry) iter.next();

        SegmentReader sr = (SegmentReader) ent.getValue();
        if (sr.hasChanges) {
          assert infoIsLive(sr.getSegmentInfo());
          sr.startCommit();
          boolean success = false;
          try {
            sr.doCommit(null);
            success = true;
          } finally {
            if (!success) {
              sr.rollbackCommit();
            }
          }
        }
      }
    }

