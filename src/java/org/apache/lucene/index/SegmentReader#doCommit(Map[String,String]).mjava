  protected void doCommit(Map<String,String> commitUserData) throws IOException {
    if (hasChanges) {
      if (deletedDocsDirty) {               // re-write deleted
        si.advanceDelGen();

        // We can write directly to the actual name (vs to a
        // .tmp & renaming it) because the file is not live
        // until segments file is written:
        deletedDocs.write(directory(), si.getDelFileName());

        si.setDelCount(si.getDelCount()+pendingDeleteCount);
        pendingDeleteCount = 0;
        assert deletedDocs.count() == si.getDelCount(): "delete count mismatch during commit: info=" + si.getDelCount() + " vs BitVector=" + deletedDocs.count();
      } else {
        assert pendingDeleteCount == 0;
      }

      if (normsDirty) {               // re-write norms
        si.setNumFields(core.fieldInfos.size());
        Iterator it = norms.values().iterator();
        while (it.hasNext()) {
          Norm norm = (Norm) it.next();
          if (norm.dirty) {
            norm.reWrite(si);
          }
        }
      }
      deletedDocsDirty = false;
      normsDirty = false;
      hasChanges = false;
    }
  }

