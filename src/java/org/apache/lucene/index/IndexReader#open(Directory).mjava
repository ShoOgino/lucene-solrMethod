  /** Returns an IndexReader reading the index in the given Directory. */
  public static IndexReader open(final Directory directory) throws IOException{
    synchronized (directory) {			  // in- & inter-process sync
      return (IndexReader)new Lock.With(directory.makeLock("commit.lock"), IndexWriter.COMMIT_LOCK_TIMEOUT) {
          public Object doBody() throws IOException {
            IndexReader result = null;
            
            SegmentInfos infos = new SegmentInfos();
            infos.read(directory);
            if (infos.size() == 1) {		  // index is optimized
                result = new SegmentReader(infos.info(0), true);
            } else {
                SegmentReader[] readers = new SegmentReader[infos.size()];
                for (int i = 0; i < infos.size(); i++)
                  readers[i] = new SegmentReader(infos.info(i), i==infos.size()-1);
                result =  new SegmentsReader(directory, readers);
            }
        
            result.segmentInfosAge = lastModified(directory);
            return result;
          }
        }.run();
    }
  }

