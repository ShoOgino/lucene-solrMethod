  /** Incremental segment merger.  */
  private final void maybeMergeSegments() throws IOException {
    long targetMergeDocs = minMergeDocs;
    while (targetMergeDocs <= maxMergeDocs) {
      // find segments smaller than current target size
      int minSegment = segmentInfos.size() - singleDocSegmentsCount; // top 1-doc segments are taken for sure
      int mergeDocs = singleDocSegmentsCount;
      while (--minSegment >= 0) {
        SegmentInfo si = segmentInfos.info(minSegment);
        if (si.docCount >= targetMergeDocs)
          break;
        mergeDocs += si.docCount;
      }

      if (mergeDocs >= targetMergeDocs)	{	  // found a merge to do
        mergeSegments(minSegment+1);
        singleDocSegmentsCount = 0;
      } else {
        break;
      }

      targetMergeDocs *= mergeFactor;		  // increase target size
    }
  }

