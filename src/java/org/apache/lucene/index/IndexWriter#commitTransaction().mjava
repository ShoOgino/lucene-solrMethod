  /*
   * Commits the transaction.  This will write the new
   * segments file and remove and pending deletions we have
   * accumulated during the transaction
   */
  private synchronized void commitTransaction() throws IOException {

    if (infoStream != null)
      message("now commit transaction");

    // Give deleter a chance to remove files now:
    checkpoint();

    // Remove the incRef we did in startTransaction.
    deleter.decRef(localRollbackSegmentInfos);

    localRollbackSegmentInfos = null;

    assert !hasExternalSegments();

    finishAddIndexes();
  }

