  /** Returns true if the caller (IndexWriter) should now
   * flush. */
  boolean addDocument(Document doc, Analyzer analyzer)
    throws CorruptIndexException, IOException {

    // This call is synchronized but fast
    final ThreadState state = getThreadState(doc);
    boolean success = false;
    try {
      // This call is not synchronized and does all the work
      state.processDocument(analyzer);
      // This call synchronized but fast
      finishDocument(state);
      success = true;
    } finally {
      if (!success) {
        state.isIdle = true;
        abort();
      }
    }
    return state.doFlushAfter;
  }

