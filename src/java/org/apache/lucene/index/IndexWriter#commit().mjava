  public final void commit() throws CorruptIndexException, IOException {

    ensureOpen();

    // Only let one thread do the prepare/finish at a time
    waitForCommit();

    try {
      message("commit: start");

      if (autoCommit || pendingCommit == null) {
        message("commit: now prepare");
        prepareCommit(true);
      } else
        message("commit: already prepared");

      finishCommit();
    } finally {
      doneCommit();
    }
  }

