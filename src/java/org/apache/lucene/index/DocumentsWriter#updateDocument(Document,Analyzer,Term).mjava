  boolean updateDocument(Document doc, Analyzer analyzer, Term delTerm)
    throws CorruptIndexException, IOException {

    // This call is synchronized but fast
    final ThreadState state = getThreadState(doc, delTerm);
    boolean success = false;
    try {
      try {
        // This call is not synchronized and does all the work
        state.processDocument(analyzer);
      } finally {
        // This call is synchronized but fast
        finishDocument(state);
      }
      success = true;
    } finally {
      if (!success) {
        synchronized(this) {
          state.isIdle = true;
          if (state.abortOnExc)
            // Abort all buffered docs since last flush
            abort();
          else
            // Immediately mark this document as deleted
            // since likely it was partially added.  This
            // keeps indexing as "all or none" (atomic) when
            // adding a document:
            addDeleteDocID(state.docID);
          notifyAll();
        }
      }
    }

    return state.doFlushAfter || timeToFlushDeletes();
  }

