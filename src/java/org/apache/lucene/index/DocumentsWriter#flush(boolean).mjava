  /** Flush all pending docs to a new segment */
  int flush(boolean closeDocStore) throws IOException {

    assert allThreadsIdle();

    if (segment == null)
      // In case we are asked to flush an empty segment
      segment = writer.newSegmentName();

    newFiles = new ArrayList();

    docStoreOffset += numDocsInRAM;

    if (closeDocStore) {
      assert docStoreSegment != null;
      assert docStoreSegment.equals(segment);
      newFiles.addAll(files());
      closeDocStore();
    }
    
    int docCount;

    assert numDocsInRAM > 0;

    if (infoStream != null)
      infoStream.println("\nflush postings as segment " + segment + " numDocs=" + numDocsInRAM);
    
    boolean success = false;

    try {

      fieldInfos.write(directory, segment + ".fnm");

      docCount = numDocsInRAM;

      newFiles.addAll(writeSegment());

      success = true;

    } finally {
      if (!success)
        abort();
    }

    return docCount;
  }

