  /**
   * Simple test to make sure the TotalFacetCountsManager updates the
   * TotalFacetCounts array only when it is supposed to, and whether it
   * is recomputed or read from disk.
   */
  @Test
  public void testGenerationalConsistency() throws Exception {
    // Create temporary RAMDirectories
    Directory[][] dirs = FacetTestUtils.createIndexTaxonomyDirs(1);

    // Create our index/taxonomy writers
    IndexTaxonomyWriterPair[] writers = FacetTestUtils.createIndexTaxonomyWriterPair(dirs);
    DefaultFacetIndexingParams iParams = new DefaultFacetIndexingParams();

    // Add a facet to the index
    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, "a", "b");

    // Commit Changes
    writers[0].indexWriter.commit();
    writers[0].taxWriter.commit();

    // Open readers
    IndexTaxonomyReaderPair[] readers = FacetTestUtils.createIndexTaxonomyReaderPair(dirs);

    // As this is the first time we have invoked the TotalFacetCountsManager, 
    // we should expect to compute and not read from disk.
    TotalFacetCounts totalCounts = 
      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);
    int prevGen = assertRecomputed(totalCounts, 0, "after first attempt to get it!");

    // Repeating same operation should pull from the cache - not recomputed. 
    assertTrue("Should be obtained from cache at 2nd attempt",totalCounts == 
      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));

    // Repeat the same operation as above. but clear first - now should recompute again
    initCache();
    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);
    prevGen = assertRecomputed(totalCounts, prevGen, "after cache clear, 3rd attempt to get it!");
    
    //store to file
    File outputFile = _TestUtil.createTempFile("test", "tmp", TEMP_DIR);
    initCache();
    TFC.store(outputFile, readers[0].indexReader, readers[0].taxReader, iParams, null);
    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);
    prevGen = assertRecomputed(totalCounts, prevGen, "after cache clear, 4th attempt to get it!");

    //clear and load
    initCache();
    TFC.load(outputFile, readers[0].indexReader, readers[0].taxReader, iParams);
    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);
    prevGen = assertReadFromDisc(totalCounts, prevGen, "after 5th attempt to get it!");

    // Add a new facet to the index, commit and refresh readers
    addFacets(iParams, writers[0].indexWriter, writers[0].taxWriter, "c", "d");
    writers[0].indexWriter.close();
    writers[0].taxWriter.close();

    DirectoryTaxonomyReader newTaxoReader = TaxonomyReader.openIfChanged(readers[0].taxReader);
    assertNotNull(newTaxoReader);
    assertTrue("should have received more cagtegories in updated taxonomy", newTaxoReader.getSize() > readers[0].taxReader.getSize());
    readers[0].taxReader.close();
    readers[0].taxReader = newTaxoReader;
    
    DirectoryReader r2 = DirectoryReader.openIfChanged(readers[0].indexReader);
    assertNotNull(r2);
    readers[0].indexReader.close();
    readers[0].indexReader = r2;

    // now use the new reader - should recompute
    totalCounts = TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null);
    prevGen = assertRecomputed(totalCounts, prevGen, "after updating the index - 7th attempt!");

    // try again - should not recompute
    assertTrue("Should be obtained from cache at 8th attempt",totalCounts == 
      TFC.getTotalCounts(readers[0].indexReader, readers[0].taxReader, iParams, null));
    
    readers[0].close();
    outputFile.delete();
    IOUtils.close(dirs[0]);
  }

