  @BeforeClass
  public static void beforeClass() throws Exception {
    dir = newDirectory();
    taxoDir = newDirectory();
    // preparations - index, taxonomy, content
    
    TaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(taxoDir);

    // Cannot mix ints & floats in the same indexed field:
    config.setIndexFieldName("int", "$facets.int");
    config.setIndexFieldName("float", "$facets.float");

    RandomIndexWriter writer = new RandomIndexWriter(random(), dir);
    DocumentBuilder builder = new DocumentBuilder(taxoWriter, config);

    // index documents, 50% have only 'b' and all have 'a'
    for (int i = 0; i < 110; i++) {
      Document doc = new Document();
      // every 11th document is added empty, this used to cause the association
      // aggregators to go into an infinite loop
      if (i % 11 != 0) {
        doc.add(new AssociationFacetField(2, "int", "a"));
        doc.add(new AssociationFacetField(0.5f, "float", "a"));
        if (i % 2 == 0) { // 50
          doc.add(new AssociationFacetField(3, "int", "b"));
          doc.add(new AssociationFacetField(0.2f, "float", "b"));
        }
      }
      writer.addDocument(builder.build(doc));
    }
    
    taxoWriter.close();
    reader = writer.getReader();
    writer.close();
    taxoReader = new DirectoryTaxonomyReader(taxoDir);
  }

