  @BeforeClass
  public static void beforeClass() throws Exception {
    dir = newDirectory();
    taxoDir = newDirectory();
    // preparations - index, taxonomy, content
    
    TaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(taxoDir);

    IndexWriterConfig iwc = newIndexWriterConfig(TEST_VERSION_CURRENT, new MockAnalyzer(random()));
    IndexWriter writer = new FacetIndexWriter(dir, iwc, taxoWriter, new FacetsConfig());

    // index documents, 50% have only 'b' and all have 'a'
    for (int i = 0; i < 110; i++) {
      Document doc = new Document();
      // every 11th document is added empty, this used to cause the association
      // aggregators to go into an infinite loop
      if (i % 11 != 0) {
        doc.add(new AssociationFacetField(2, "int", "a"));
        doc.add(new AssociationFacetField(0.5f, "float", "a"));
        if (i % 2 == 0) { // 50
          doc.add(new AssociationFacetField(3, "int", "b"));
          doc.add(new AssociationFacetField(0.2f, "float", "b"));
        }
      }
      writer.addDocument(doc);
    }
    
    taxoWriter.close();
    reader = DirectoryReader.open(writer, true);
    writer.close();
  }

