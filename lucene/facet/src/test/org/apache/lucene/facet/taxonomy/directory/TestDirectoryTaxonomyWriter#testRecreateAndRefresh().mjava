  @Test
  public void testRecreateAndRefresh() throws Exception {
    // DirTaxoWriter lost the INDEX_CREATE_TIME property if it was opened in
    // CREATE_OR_APPEND (or commit(userData) called twice), which could lead to
    // DirTaxoReader succeeding to refresh().
    Directory dir = newDirectory();
    
    DirectoryTaxonomyWriter taxoWriter = new DirectoryTaxonomyWriter(dir, OpenMode.CREATE_OR_APPEND, new NoOpCache());
    touchTaxo(taxoWriter, new CategoryPath("a"));
    
    DirectoryTaxonomyReader taxoReader = new DirectoryTaxonomyReader(dir);

    touchTaxo(taxoWriter, new CategoryPath("b"));
    
    // this should not fail
    taxoReader.refresh();

    // now recreate the taxonomy, and check that the timestamp is preserved after opening DirTW again.
    taxoWriter.close();
    taxoWriter = new DirectoryTaxonomyWriter(dir, OpenMode.CREATE, new NoOpCache());
    touchTaxo(taxoWriter, new CategoryPath("c"));
    taxoWriter.close();
    
    taxoWriter = new DirectoryTaxonomyWriter(dir, OpenMode.CREATE_OR_APPEND, new NoOpCache());
    touchTaxo(taxoWriter, new CategoryPath("d"));
    taxoWriter.close();

    // this should fail
    try {
      taxoReader.refresh();
      fail("IconsistentTaxonomyException should have been thrown");
    } catch (InconsistentTaxonomyException e) {
      // ok, expected
    }
    
    taxoReader.close();
    dir.close();
  }

