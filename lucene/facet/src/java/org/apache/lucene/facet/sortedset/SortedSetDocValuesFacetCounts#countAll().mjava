  /** Does all the "real work" of tallying up the counts. */
  private final void countAll() throws IOException {
    //System.out.println("ssdv count");

    MultiDocValues.OrdinalMap ordinalMap;

    // TODO: is this right?  really, we need a way to
    // verify that this ordinalMap "matches" the leaves in
    // matchingDocs...
    if (dv instanceof MultiDocValues.MultiSortedSetDocValues) {
      ordinalMap = ((MultiSortedSetDocValues) dv).mapping;
    } else {
      ordinalMap = null;
    }
    
    IndexReader origReader = state.getOrigReader();

    for(LeafReaderContext context : origReader.leaves()) {

      LeafReader reader = context.reader();
      
      SortedSetDocValues segValues = reader.getSortedSetDocValues(field);
      if (segValues == null) {
        continue;
      }

      Bits liveDocs = reader.getLiveDocs();

      if (ordinalMap != null) {
        final LongValues ordMap = ordinalMap.getGlobalOrds(context.ord);

        int numSegOrds = (int) segValues.getValueCount();

        // First count in seg-ord space:
        final int[] segCounts = new int[numSegOrds];
        int docID;
        while ((docID = segValues.nextDoc()) != DocIdSetIterator.NO_MORE_DOCS) {
          if (liveDocs == null || liveDocs.get(docID)) {
            int term = (int) segValues.nextOrd();
            while (term != SortedSetDocValues.NO_MORE_ORDS) {
              segCounts[term]++;
              term = (int) segValues.nextOrd();
            }
          }
        }

        // Then, migrate to global ords:
        for(int ord=0;ord<numSegOrds;ord++) {
          int count = segCounts[ord];
          if (count != 0) {
            counts[(int) ordMap.get(ord)] += count;
          }
        }
      } else {
        // No ord mapping (e.g., single segment index):
        // just aggregate directly into counts:
        int docID;
        while ((docID = segValues.nextDoc()) != DocIdSetIterator.NO_MORE_DOCS) {
          if (liveDocs == null || liveDocs.get(docID)) {
            int term = (int) segValues.nextOrd();
            while (term != SortedSetDocValues.NO_MORE_ORDS) {
              counts[term]++;
              term = (int) segValues.nextOrd();
            }
          }
        }
      }
    }
  }

