  @Override
  public void handle(int ordinal, CategoryPath cp) throws IOException {
    super.handle(ordinal, cp);
    
    // build per-association key BytesRef
    CategoryAssociation association = associations.getAssociation(cp);
    if (association == null) {
      // it is ok to set a null association for a category - it's treated as a
      // regular category in that case.
      return;
    }
    
    BytesRef bytes = perAssociationBytes.get(association.getCategoryListID());
    if (bytes == null) {
      bytes = new BytesRef();
      perAssociationBytes.put(association.getCategoryListID(), bytes);
    }
    
    int maxBytesNeeded = 4 /* int */ + association.maxBytesNeeded();
    if (bytes.bytes.length - bytes.length < maxBytesNeeded) {
      bytes.grow(bytes.bytes.length + maxBytesNeeded);
    }
    
    // reset the output to write from bytes.length (current position) until the end
    output.reset(bytes.bytes, bytes.length, bytes.bytes.length - bytes.length);
    output.writeInt(ordinal);
    
    // encode the association bytes
    association.serialize(output);
    
    // update BytesRef
    bytes.length = output.getPosition();
  }

