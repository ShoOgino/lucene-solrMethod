  @Override
  protected Map<CategoryListParams,Iterable<CategoryPath>> createCategoryListMapping(
      Iterable<CategoryPath> categories) {
    CategoryAssociationsContainer categoryAssociations = (CategoryAssociationsContainer) categories;
    HashMap<CategoryListParams,Iterable<CategoryPath>> categoryLists = 
        new HashMap<CategoryListParams,Iterable<CategoryPath>>();
    for (CategoryPath cp : categories) {
      // each category may be indexed under a different field, so add it to the right list.
      CategoryListParams clp = indexingParams.getCategoryListParams(cp);
      CategoryAssociationsContainer clpContainer = (CategoryAssociationsContainer) categoryLists.get(clp);
      if (clpContainer == null) {
        clpContainer = new CategoryAssociationsContainer();
        categoryLists.put(clp, clpContainer);
      }
      // DrillDownStream modifies the CategoryPath by calling trim(). That means
      // that the source category, as the app ses it, is modified. While for
      // most apps this is not a problem, we need to protect against it. If
      // CategoryPath will be made immutable, we can stop cloning.
      cp = cp.clone();
      clpContainer.setAssociation(cp, categoryAssociations.getAssociation(cp));
    }
    return categoryLists;
  }

