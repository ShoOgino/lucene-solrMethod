  /**
   * Search, sorting by {@link Sort}, and computing
   * drill down and sideways counts.
   */
  public SimpleDrillSidewaysResult search(SimpleDrillDownQuery query,
                                          Filter filter, FieldDoc after, int topN, Sort sort, boolean doDocScores,
                                          boolean doMaxScore) throws IOException {
    if (filter != null) {
      query = new SimpleDrillDownQuery(config, filter, query);
    }
    if (sort != null) {
      int limit = searcher.getIndexReader().maxDoc();
      if (limit == 0) {
        limit = 1; // the collector does not alow numHits = 0
      }
      topN = Math.min(topN, limit);
      final TopFieldCollector hitCollector = TopFieldCollector.create(sort,
                                                                      topN,
                                                                      after,
                                                                      true,
                                                                      doDocScores,
                                                                      doMaxScore,
                                                                      true);
      SimpleDrillSidewaysResult r = search(query, hitCollector);
      return new SimpleDrillSidewaysResult(r.facets, hitCollector.topDocs());
    } else {
      return search(after, query, topN);
    }
  }

