  /**
   * Every returned {@link BytesRef} corresponds to a single partition (as
   * defined by {@link FacetIndexingParams#getPartitionSize()}) and the key
   * denotes the partition ID. When no partitions are defined, the returned map
   * contains only one value.
   * <p>
   * <b>NOTE:</b> the {@code ordinals} array is modified by adding parent
   * ordinals to it. Also, some encoders may sort the array and remove duplicate
   * ordinals. Therefore you may want to invoke this method after you finished
   * processing the array for other purposes.
   */
  @Override
  public Map<String,BytesRef> build(IntsRef ordinals, Iterable<CategoryPath> categories) throws IOException {
    int upto = ordinals.length; // since we add ordinals to IntsRef, iterate upto original length
    
    if (ordinalPolicy == OrdinalPolicy.ALL_PARENTS) { // add all parents too
      for (int i = 0; i < upto; i++) {
        int ordinal = ordinals.ints[i];
        int parent = taxoWriter.getParent(ordinal);
        while (parent > 0) {
          ordinals.ints[ordinals.length++] = parent;
          parent = taxoWriter.getParent(parent);
        }
      }
    }
    return ordinalsEncoder.encode(ordinals);
  }

