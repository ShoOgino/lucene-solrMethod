  private void withReader(
      Collection<Map<String, String[]>> docs, IOUtils.IOConsumer<DirectoryReader> block)
      throws IOException {
    IndexWriterConfig config = new IndexWriterConfig(analyzer);

    try (Directory directory = new ByteBuffersDirectory()) {
      IndexWriter iw = new IndexWriter(directory, config);

      int seq = 0;
      for (Map<String, String[]> fields : docs) {
        Document doc = new Document();
        doc.add(new StringField(FLD_ID, Integer.toString(seq++), Field.Store.YES));
        for (Map.Entry<String, String[]> field : fields.entrySet()) {
          for (String value : field.getValue()) {
            doc.add(toField(field.getKey(), value));
          }
        }
        iw.addDocument(doc);
        if (RandomizedTest.randomBoolean()) {
          iw.commit();
        }
      }
      iw.flush();

      try (DirectoryReader reader = DirectoryReader.open(iw)) {
        block.accept(reader);
      }
    }
  }

