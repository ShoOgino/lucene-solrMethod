  public FormatPostingsFieldsWriter(SegmentWriteState state, FieldInfos fieldInfos) throws IOException {
    super();

    dir = state.directory;
    segment = state.segmentName;
    totalNumDocs = state.numDocs;
    this.fieldInfos = fieldInfos;
    termsOut = new TermInfosWriter(dir,
                                   segment,
                                   fieldInfos,
                                   state.termIndexInterval);

    // TODO: this is a nasty abstraction violation (that we
    // peek down to find freqOut/proxOut) -- we need a
    // better abstraction here whereby these child consumers
    // can provide skip data or not
    skipListWriter = new DefaultSkipListWriter(termsOut.skipInterval,
                                               termsOut.maxSkipLevels,
                                               totalNumDocs,
                                               null,
                                               null);

    state.flushedFiles.add(state.segmentFileName(IndexFileNames.TERMS_EXTENSION));
    state.flushedFiles.add(state.segmentFileName(IndexFileNames.TERMS_INDEX_EXTENSION));

    termsWriter = new FormatPostingsTermsWriter(state, this);
  }

