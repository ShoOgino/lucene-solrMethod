  @Test
  public void testSuggestOnAllFilteredDocuments() throws Exception {
    Analyzer analyzer = new MockAnalyzer(random());
    RandomIndexWriter iw = new RandomIndexWriter(random(), dir, iwcWithSuggestField(analyzer, "suggest_field"));
    int num = Math.min(1000, atLeast(10));
    Document document = new Document();
    for (int i = 0; i < num; i++) {
      document.add(newSuggestField("suggest_field", "abc_" + i, i));
      document.add(newStringField("str_fld", "deleted", Field.Store.NO));
      iw.addDocument(document);
      document.clear();

      if (usually()) {
        iw.commit();
      }
    }

    Filter filter = new QueryWrapperFilter(new TermsQuery("str_fld", new BytesRef("non_existent")));
    DirectoryReader reader = iw.getReader();
    SuggestIndexSearcher indexSearcher = new SuggestIndexSearcher(reader, analyzer);
    // no random access required;
    // calling suggest with filter that does not match any documents should early terminate
    TopSuggestDocs suggest = indexSearcher.suggest("suggest_field", "abc_", num, filter);
    assertThat(suggest.totalHits, equalTo(0));
    reader.close();
    iw.close();
  }

