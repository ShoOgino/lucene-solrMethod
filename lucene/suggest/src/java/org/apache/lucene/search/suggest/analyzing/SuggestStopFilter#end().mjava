  @Override
  public void end() throws IOException {
    if (!ended) {
      super.end();
    } else {
      // NOTE: we already called .end() from our .next() when
      // the stream was complete, so we do not call
      // super.end() here

      if (endState != null) {
        restoreState(endState);
      }
    }
  }

