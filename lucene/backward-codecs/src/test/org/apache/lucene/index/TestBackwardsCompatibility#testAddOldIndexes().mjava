  public void testAddOldIndexes() throws IOException {
    for (String name : oldNames) {
      if (VERBOSE) {
        System.out.println("\nTEST: old index " + name);
      }
      Directory oldDir = oldIndexDirs.get(name);
      Version indexCreatedVersion = SegmentInfos.readLatestCommit(oldDir).getIndexCreatedVersion();

      Directory targetDir = newDirectory();
      // Simulate writing into an index that was created on the same version
      new SegmentInfos(indexCreatedVersion).commit(targetDir);
      IndexWriter w = new IndexWriter(targetDir, newIndexWriterConfig(new MockAnalyzer(random())));
      w.addIndexes(oldDir);
      w.close();
      targetDir.close();

      // Now check that we forbid calling addIndexes with a different version
      targetDir = newDirectory();
      IndexWriter oldWriter = new IndexWriter(targetDir, newIndexWriterConfig(new MockAnalyzer(random())));
      IllegalArgumentException e = expectThrows(IllegalArgumentException.class, () -> oldWriter.addIndexes(oldDir));
      assertTrue(e.getMessage(), e.getMessage().startsWith("Cannot use addIndexes(Directory) with indexes that have been created by a different Lucene version."));

      if (VERBOSE) {
        System.out.println("\nTEST: done adding indices; now close");
      }
      oldWriter.close();
      
      targetDir.close();
    }
  }

