  static void restore(
      TreeMap<String,String> before,
      TreeMap<String,String> after,
      Set<String> ignoredKeys) {

    // Clear anything that is present after but wasn't before.
    after.keySet().removeAll(before.keySet());
    for (String key : after.keySet()) {
      if (!ignoredKeys.contains(key))
        System.clearProperty(key);
    }

    // Restore original property values unless they are ignored (then leave).
    for (Map.Entry<String,String> e : before.entrySet()) {
      String key = e.getValue();
      if (!ignoredKeys.contains(key)) {
        if (key == null) {
          System.clearProperty(e.getKey()); // Can this happen?
        } else {
          System.setProperty(e.getKey(), key);
        }
      }
    }
  }  

