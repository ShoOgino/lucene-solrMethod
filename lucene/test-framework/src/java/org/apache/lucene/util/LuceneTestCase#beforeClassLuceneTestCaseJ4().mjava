  @BeforeClass
  static void beforeClassLuceneTestCaseJ4() {
    testClassesRun.add(getTestClass().getSimpleName());

    tempDirs.clear();
    stores = Collections.synchronizedMap(new IdentityHashMap<MockDirectoryWrapper,StackTraceElement[]>());
    
    // enable this by default, for IDE consistency with ant tests (as its the default from ant)
    // TODO: really should be in solr base classes, but some extend LTC directly.
    // we do this in beforeClass, because some tests currently disable it
    restoreProperties.put("solr.directoryFactory", System.getProperty("solr.directoryFactory"));
    if (System.getProperty("solr.directoryFactory") == null) {
      System.setProperty("solr.directoryFactory", "org.apache.solr.core.MockDirectoryFactory");
    }
    
    // enable the Lucene 3.x PreflexRW codec explicitly, to work around bugs in IBM J9 / Harmony ServiceLoader:
    try {
      final java.lang.reflect.Field spiLoaderField = Codec.class.getDeclaredField("loader");
      spiLoaderField.setAccessible(true);
      final Object spiLoader = spiLoaderField.get(null);
      final java.lang.reflect.Field modifiableServicesField = NamedSPILoader.class.getDeclaredField("modifiableServices");
      modifiableServicesField.setAccessible(true);
      @SuppressWarnings({"unchecked","rawtypes"}) final Map<String,Codec> serviceMap =
        (Map) modifiableServicesField.get(spiLoader);
      if (!(Codec.forName("Lucene3x") instanceof PreFlexRWCodec)) {
        if (Constants.JAVA_VENDOR.startsWith("IBM")) {
          // definitely a buggy version
          System.err.println("ERROR: Your VM's java.util.ServiceLoader implementation is buggy"+
            " and does not respect classpath order, please report this to the vendor.");
        } else {
          // could just be a classpath issue
          System.err.println("ERROR: fix your classpath to have tests-framework.jar before lucene-core.jar!"+
              " If you have already done this, then your VM's java.util.ServiceLoader implementation is buggy"+
              " and does not respect classpath order, please report this to the vendor.");
        }
        serviceMap.put("Lucene3x", new PreFlexRWCodec());
      }
    } catch (Exception e) {
      throw new RuntimeException("Cannot access internals of Codec and NamedSPILoader classes", e);
    }
    
    // if verbose: print some debugging stuff about which codecs are loaded
    if (VERBOSE) {
      Set<String> codecs = Codec.availableCodecs();
      for (String codec : codecs) {
        System.out.println("Loaded codec: '" + codec + "': " + Codec.forName(codec).getClass().getName());
      }
      
      Set<String> postingsFormats = PostingsFormat.availablePostingsFormats();
      for (String postingsFormat : postingsFormats) {
        System.out.println("Loaded postingsFormat: '" + postingsFormat + "': " + PostingsFormat.forName(postingsFormat).getClass().getName());
      }
    }

    savedInfoStream = InfoStream.getDefault();
    final boolean v = random().nextBoolean();
    if (INFOSTREAM) {
      InfoStream.setDefault(new PrintStreamInfoStream(System.out));
    } else {
      if (v) {
        InfoStream.setDefault(new NullInfoStream());
      }
    }

    Class<?> targetClass = RandomizedContext.current().getTargetClass();
    LuceneTestCase.useNoMemoryExpensiveCodec =
        targetClass.isAnnotationPresent(UseNoMemoryExpensiveCodec.class);
    if (useNoMemoryExpensiveCodec) {
        System.err.println("NOTE: Using no memory expensive codecs (Memory, SimpleText) for " +
            targetClass.getSimpleName() + ".");
    }

    PREFLEX_IMPERSONATION_IS_ACTIVE = false;
    savedCodec = Codec.getDefault();
    final Codec codec;
    int randomVal = random().nextInt(10);
    
    if ("Lucene3x".equals(TEST_CODEC) || ("random".equals(TEST_CODEC) && randomVal < 2)) { // preflex-only setup
      codec = Codec.forName("Lucene3x");
      assert (codec instanceof PreFlexRWCodec) : "fix your classpath to have tests-framework.jar before lucene-core.jar";
      PREFLEX_IMPERSONATION_IS_ACTIVE = true;
    } else if ("SimpleText".equals(TEST_CODEC) || ("random".equals(TEST_CODEC) && randomVal == 9)) {
      codec = new SimpleTextCodec();
    } else if ("Appending".equals(TEST_CODEC) || ("random".equals(TEST_CODEC) && randomVal == 8)) {
      codec = new AppendingCodec();
    } else if (!"random".equals(TEST_CODEC)) {
      codec = Codec.forName(TEST_CODEC);
    } else if ("random".equals(TEST_POSTINGSFORMAT)) {
      codec = new RandomCodec(random(), useNoMemoryExpensiveCodec);
    } else {
      codec = new Lucene40Codec() {
        private final PostingsFormat format = PostingsFormat.forName(TEST_POSTINGSFORMAT);
        
        @Override
        public PostingsFormat getPostingsFormatForField(String field) {
          return format;
        }

        @Override
        public String toString() {
          return super.toString() + ": " + format.toString();
        }
      };
    }

    Codec.setDefault(codec);
    
    savedLocale = Locale.getDefault();
    
    // START hack to init ICU safely before we randomize locales.
    // ICU fails during classloading when a special Java7-only locale is the default
    // see: http://bugs.icu-project.org/trac/ticket/8734
    if (!icuTested) {
      icuTested = true;
      try {
        Locale.setDefault(Locale.US);
        Class.forName("com.ibm.icu.util.ULocale");
      } catch (ClassNotFoundException cnfe) {
        // ignore if no ICU is in classpath
      }
    }
    // END hack
    
    locale = TEST_LOCALE.equals("random") ? randomLocale(random()) : localeForName(TEST_LOCALE);
    Locale.setDefault(locale);
    // TimeZone.getDefault will set user.timezone to the default timezone of the user's locale.
    // So store the original property value and restore it at end.
    restoreProperties.put("user.timezone", System.getProperty("user.timezone"));
    savedTimeZone = TimeZone.getDefault();
    timeZone = TEST_TIMEZONE.equals("random") ? randomTimeZone(random()) : TimeZone.getTimeZone(TEST_TIMEZONE);
    TimeZone.setDefault(timeZone);
    similarity = random().nextBoolean() ? new DefaultSimilarity() : new RandomSimilarityProvider(random());
    testsFailed = false;
  }

