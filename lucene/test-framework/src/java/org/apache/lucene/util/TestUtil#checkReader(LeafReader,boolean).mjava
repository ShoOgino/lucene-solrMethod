  public static void checkReader(LeafReader reader, boolean crossCheckTermVectors) throws IOException {
    ByteArrayOutputStream bos = new ByteArrayOutputStream(1024);
    PrintStream infoStream = new PrintStream(bos, false, IOUtils.UTF_8);

    reader.checkIntegrity();
    CheckIndex.testLiveDocs(reader, infoStream, true);
    CheckIndex.testFieldInfos(reader, infoStream, true);
    CheckIndex.testFieldNorms(reader, infoStream, true);
    CheckIndex.testPostings(reader, infoStream, false, true);
    CheckIndex.testStoredFields(reader, infoStream, true);
    CheckIndex.testTermVectors(reader, infoStream, false, crossCheckTermVectors, true);
    CheckIndex.testDocValues(reader, infoStream, true);
    
    if (LuceneTestCase.INFOSTREAM) {
      System.out.println(bos.toString(IOUtils.UTF_8));
    }
    
    LeafReader unwrapped = FilterLeafReader.unwrap(reader);
    if (unwrapped instanceof SegmentReader) {
      SegmentReader sr = (SegmentReader) unwrapped;
      long bytesUsed = sr.ramBytesUsed(); 
      if (sr.ramBytesUsed() < 0) {
        throw new IllegalStateException("invalid ramBytesUsed for reader: " + bytesUsed);
      }
      assert Accountables.toString(sr) != null;
    }
  }

