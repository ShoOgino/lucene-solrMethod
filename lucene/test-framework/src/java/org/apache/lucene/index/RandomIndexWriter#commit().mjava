  public long commit() throws IOException {
    LuceneTestCase.maybeChangeLiveIndexWriterConfig(r, w.getConfig());
    if (r.nextInt(10) == 0) {
      AtomicReference<Throwable> exception = new AtomicReference<>();
      Thread t = new Thread(() -> {
        try {
          flushAllBuffersSequentially();
        } catch (IOException e) {
          exception.set(e);
        }
      });
      t.start();
      long seqId = w.commit();
      try {
        t.join();
      } catch (InterruptedException e) {
        throw new AssertionError(e);
      }
      if (exception.get() != null) {
        throw new AssertionError(exception.get());
      }
      return seqId;
    }
    return w.commit();
  }

