  @Override
  public int compareBottom(int doc) throws IOException {
    currentDocs.setDocument(doc);

    int numValues = currentDocs.count();
    if (numValues == 0) {
      return Double.compare(bottom, Double.POSITIVE_INFINITY);
    }

    int cmp = -1;
    for (int i = 0; i < numValues; i++) {
      long encoded = currentDocs.valueAt(i);

      // test bounding box
      int latitudeBits = (int)(encoded >> 32);
      if (latitudeBits < minLat || latitudeBits > maxLat) {
        continue;
      }
      int longitudeBits = (int)(encoded & 0xFFFFFFFF);
      if ((longitudeBits < minLon || longitudeBits > maxLon) && (longitudeBits < minLon2)) {
        continue;
      }

      // only compute actual distance if its inside "competitive bounding box"
      double docLatitude = LatLonPoint.decodeLatitude(latitudeBits);
      double docLongitude = LatLonPoint.decodeLongitude(longitudeBits);
      cmp = Math.max(cmp, Double.compare(bottom, haversin1(latitude, longitude, docLatitude, docLongitude)));
      // once we compete in the PQ, no need to continue.
      if (cmp > 0) {
        return cmp;
      }
    }
    return cmp;
  }

