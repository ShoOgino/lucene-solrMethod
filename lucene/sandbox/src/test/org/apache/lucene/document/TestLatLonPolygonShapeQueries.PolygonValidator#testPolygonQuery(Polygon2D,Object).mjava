    @Override
    public boolean testPolygonQuery(Polygon2D query, Object shape) {
      List<Tessellator.Triangle> tessellation = Tessellator.tessellate((Polygon) shape);
      for (Tessellator.Triangle t : tessellation) {
        // we quantize the triangle for consistency with the index
        Relation r = query.relateTriangle(quantizeLon(t.getLon(0)), quantizeLat(t.getLat(0)),
            quantizeLon(t.getLon(1)), quantizeLat(t.getLat(1)),
            quantizeLon(t.getLon(2)), quantizeLat(t.getLat(2)));
        if (queryRelation == QueryRelation.DISJOINT) {
          if (r != Relation.CELL_OUTSIDE_QUERY) return false;
        } else if (queryRelation == QueryRelation.WITHIN) {
          if (r != Relation.CELL_INSIDE_QUERY) return false;
        } else {
          if (r != Relation.CELL_OUTSIDE_QUERY) return true;
        }
      }
      return queryRelation == QueryRelation.INTERSECTS ? false : true;
    }

