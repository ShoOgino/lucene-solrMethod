    @Override
    public boolean testBBoxQuery(double minLat, double maxLat, double minLon, double maxLon, Object shape) {
      Line l = (Line)shape;
      if (queryRelation == QueryRelation.WITHIN) {
        // within: bounding box of shape should be within query box
        double lMinLat = quantizeLat(l.minLat);
        double lMinLon = quantizeLon(l.minLon);
        double lMaxLat = quantizeLat(l.maxLat);
        double lMaxLon = quantizeLon(l.maxLon);

        if (minLon > maxLon) {
          // crosses dateline:
          return minLat <= lMinLat && maxLat >= lMaxLat
              && ((GeoUtils.MIN_LON_INCL <= lMinLon && maxLon >= lMaxLon)
              || (minLon <= lMinLon && GeoUtils.MAX_LON_INCL >= lMaxLon));
        }
        return minLat <= lMinLat && maxLat >= lMaxLat
            && minLon <= lMinLon && maxLon >= lMaxLon;
      }

      Line2D line = Line2D.create(quantizeLine(l));
      Relation r;
      if (minLon > maxLon) {
        // crosses dateline:
        r = line.relate(minLat, maxLat, MIN_LON_INCL, maxLon);
        if (r == Relation.CELL_OUTSIDE_QUERY) {
          r = line.relate(minLat, maxLat, minLon, MAX_LON_INCL);
        }
      } else {
        r = line.relate(minLat, maxLat, minLon, maxLon);
      }

      if (queryRelation == QueryRelation.DISJOINT) {
        return r == Relation.CELL_OUTSIDE_QUERY;
      }
      return r != Relation.CELL_OUTSIDE_QUERY;
    }

