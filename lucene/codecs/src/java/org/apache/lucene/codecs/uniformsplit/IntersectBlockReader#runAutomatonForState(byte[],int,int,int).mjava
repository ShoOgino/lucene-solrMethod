  /**
   * Run the automaton and return the final state (not necessary accepted). -1 signifies no state / no match.
   * Sets {@link #numBytesAccepted} with the offset of the first byte rejected by the automaton;
   * or (offset + length) if no byte is rejected.
   */
  protected int runAutomatonForState(byte[] s, int offset, int length, int initialState) {
    //see ByteRunAutomaton.run(); similar
    int state = initialState;
    int index = 0;
    while (index < length) {
      state = runAutomaton.step(state, s[index + offset] & 0xFF);
      if (state == -1) {
        break;
      }
      index++;
    }
    numBytesAccepted = index;
    return state;
  }

