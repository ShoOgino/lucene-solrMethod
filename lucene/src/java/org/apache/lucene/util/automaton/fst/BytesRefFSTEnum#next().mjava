  public InputOutput<T> next() throws IOException {
    //System.out.println("  enum.next");

    if (current.length == 0) {
      final T output = fst.getEmptyOutput();
      if (output != null) {
        if (!didEmpty) {
          current.length = 0;
          lastFinal = true;
          result.output = output;
          didEmpty = true;
          return result;
        } else {
          lastFinal = false;
        }
      }
      if (fst.noNodes()) {
        return null;
      }
      fst.readFirstArc(fst.getStartNode(), getArc(0));
      push();
    } else if (lastFinal) {
      lastFinal = false;
      assert current.length > 0;
      // resume pushing
      fst.readFirstArc(arcs[current.length-1].target, getArc(current.length));
      push();
    } else {
      //System.out.println("    pop/push");
      pop();
      if (current.length == 0) {
        // enum done
        return null;
      } else {
        current.length--;
        fst.readNextArc(arcs[current.length]);
        push();
      }
    }

    return result;
  }

