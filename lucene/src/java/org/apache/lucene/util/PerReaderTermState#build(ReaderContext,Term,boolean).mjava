  /**
   * Creates a {@link PerReaderTermState} from a top-level {@link ReaderContext} and the
   * given {@link Term}. This method will lookup the given term in all context's leaf readers 
   * and register each of the readers containing the term in the returned {@link PerReaderTermState}
   * using the leaf reader's ordinal.
   * <p>
   * Note: the given context must be a top-level context.
   */
  public static PerReaderTermState build(ReaderContext context, Term term, boolean cache)
      throws IOException {
    assert context != null && context.isTopLevel;
    final String field = term.field();
    final BytesRef bytes = term.bytes();
    final PerReaderTermState perReaderTermState = new PerReaderTermState(context);
    final AtomicReaderContext[] leaves = ReaderUtil.leaves(context);
    for (int i = 0; i < leaves.length; i++) {
      final Fields fields = leaves[i].reader.fields();
      if (fields != null) {
        final Terms terms = fields.terms(field);
        if (terms != null) {
          final TermsEnum termsEnum = terms.getThreadTermsEnum(); // thread-private don't share!
          if (termsEnum.seekExact(bytes, cache)) { 
            final TermState termState = termsEnum.termState();
            perReaderTermState.register(termState, leaves[i].ord, termsEnum.docFreq());
          }
        }
      }
    }
    return perReaderTermState;
  }

