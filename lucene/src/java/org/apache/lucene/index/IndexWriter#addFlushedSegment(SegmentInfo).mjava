  void addFlushedSegment(SegmentInfo newSegment) throws IOException {
    assert newSegment != null;

    setDiagnostics(newSegment, "flush");

    if (useCompoundFile(newSegment)) {
      String compoundFileName = IndexFileNames.segmentFileName(newSegment.name, "", IndexFileNames.COMPOUND_FILE_EXTENSION);
      message("creating compound file " + compoundFileName);
      // Now build compound file
      boolean success = false;
      try {
        CompoundFileWriter cfsWriter = new CompoundFileWriter(directory, compoundFileName);
        for(String fileName : newSegment.files()) {
          cfsWriter.addFile(fileName);
        }

        // Perform the merge
        cfsWriter.close();
        synchronized(this) {
          deleter.deleteNewFiles(newSegment.files());
        }

        newSegment.setUseCompoundFile(true);

        success = true;
      } finally {
        if (!success) {
          if (infoStream != null) {
            message("hit exception " +
                "reating compound file for newly flushed segment " + newSegment.name);
          }

          synchronized(this) {
            deleter.refresh(newSegment.name);
          }
        }
      }


    }

    synchronized(this) {
      segmentInfos.add(newSegment);
      checkpoint();
    }
  }

