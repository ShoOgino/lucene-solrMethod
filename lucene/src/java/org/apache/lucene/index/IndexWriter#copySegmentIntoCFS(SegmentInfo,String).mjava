  /** Copies the segment into the IndexWriter's directory, as a compound segment. */
  private void copySegmentIntoCFS(SegmentInfo info, String segName) throws IOException {
    String segFileName = IndexFileNames.segmentFileName(segName, "", IndexFileNames.COMPOUND_FILE_EXTENSION);
    Collection<String> files = info.files();
    CompoundFileWriter cfsWriter = new CompoundFileWriter(directory, segFileName);
    for (String file : files) {
      String newFileName = segName + IndexFileNames.stripSegmentName(file);
      if (!IndexFileNames.matchesExtension(file, IndexFileNames.DELETES_EXTENSION)
          && !IndexFileNames.isSeparateNormsFile(file)) {
        cfsWriter.addFile(file, info.dir);
      } else {
        assert !directory.fileExists(newFileName): "file \"" + newFileName + "\" already exists";
        info.dir.copy(directory, file, newFileName);
      }
    }
    
    // Create the .cfs
    cfsWriter.close();
    
    info.dir = directory;
    info.name = segName;
    info.setUseCompoundFile(true);
  }

