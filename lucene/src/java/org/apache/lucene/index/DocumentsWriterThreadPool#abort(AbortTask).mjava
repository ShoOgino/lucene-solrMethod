  void abort(AbortTask task) throws IOException {
    lock.lock();
    try {
      if (!aborting) {
        aborting = true;
        pauseAllThreads();
        for (ThreadState state : allThreadStates) {
          state.perThread.aborting = true;
        }

        try {
          for (ThreadState state : allThreadStates) {
            state.perThread.abort();
          }
          
          task.abort();
        } finally {
          aborting = false;
          resumeAllThreads();
        }
      }
    } finally {
      lock.unlock();
    }
  }

