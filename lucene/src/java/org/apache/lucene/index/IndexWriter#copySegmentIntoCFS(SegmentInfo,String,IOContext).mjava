  /** Copies the segment into the IndexWriter's directory, as a compound segment. */
  private void copySegmentIntoCFS(SegmentInfo info, String segName, IOContext context) throws IOException {
    String segFileName = IndexFileNames.segmentFileName(segName, "", IndexFileNames.COMPOUND_FILE_EXTENSION);
    Collection<String> files = info.files();
    final CompoundFileDirectory cfsdir = new CompoundFileDirectory(directory, segFileName, context, true);
    try {
      for (String file : files) {
        String newFileName = segName + IndexFileNames.stripSegmentName(file);
        if (!IndexFileNames.matchesExtension(file, IndexFileNames.DELETES_EXTENSION)
            && !IndexFileNames.isSeparateNormsFile(file)) {
          info.dir.copy(cfsdir, file, file, context);
        } else {
          assert !directory.fileExists(newFileName): "file \"" + newFileName + "\" already exists";
          info.dir.copy(directory, file, newFileName, context);
        }
      }
    } finally {
      IOUtils.closeSafely(false, cfsdir);
    }
    
    info.dir = directory;
    info.name = segName;
    info.setUseCompoundFile(true);
  }

