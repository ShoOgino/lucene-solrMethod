  public final <T> T executePerThread(DocumentsWriter documentsWriter, Document doc, PerThreadTask<T> task) throws IOException {
    ThreadState state = acquireThreadState(documentsWriter, doc);
    boolean success = false;
    try {
      T result = task.process(state.perThread);
      success = true;
      return result;
    } finally {
      boolean abort = false;
      if (!success && state.perThread.aborting) {
        abort = true;
      }

      returnDocumentsWriterPerThread(state, task.doClearThreadBindings());
      
      if (!aborting && abort) {
        documentsWriter.abort();
      }
    }
  }

