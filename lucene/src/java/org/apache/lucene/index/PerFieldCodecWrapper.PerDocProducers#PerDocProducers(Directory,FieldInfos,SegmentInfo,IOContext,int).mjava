    public PerDocProducers(Directory dir, FieldInfos fieldInfos, SegmentInfo si,
        IOContext context, int indexDivisor) throws IOException {
      final Map<Codec, PerDocValues> producers = new HashMap<Codec, PerDocValues>();
      boolean success = false;
      try {
        for (FieldInfo fi : fieldInfos) {
          if (fi.hasDocValues()) { 
            assert fi.getCodecId() != FieldInfo.UNASSIGNED_CODEC_ID;
            Codec codec = segmentCodecs.codecs[fi.getCodecId()];
            if (!producers.containsKey(codec)) {
              producers.put(codec, codec.docsProducer(new SegmentReadState(dir,
                si, fieldInfos, context, indexDivisor, fi.getCodecId())));
            }
            codecs.put(fi.name, producers.get(codec));
          }
        }
        success = true;
      } finally {
        if (!success) {
          IOUtils.closeWhileHandlingException(producers.values());
        }
      }
    }

