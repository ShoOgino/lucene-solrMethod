  /** Returns a single {@link Fields} instance for this
   *  reader, merging fields/terms/docs/positions on the
   *  fly.  This method will return null if the reader 
   *  has no postings.
   *
   *  <p><b>NOTE</b>: this is a slow way to access postings.
   *  It's better to get the sub-readers (using {@link
   *  Gather}) and iterate through them
   *  yourself. */
  public static Fields getFields(IndexReader r) throws IOException {
    if (r instanceof AtomicIndexReader) {
      // already an atomic reader
      return ((AtomicIndexReader) r).fields();
    }
    assert r instanceof CompositeIndexReader;
    final IndexReader[] subs = ((CompositeIndexReader) r).getSequentialSubReaders();
    if (subs.length == 0) {
      // no fields
      return null;
    } else {
      final List<Fields> fields = new ArrayList<Fields>();
      final List<ReaderUtil.Slice> slices = new ArrayList<ReaderUtil.Slice>();

      new ReaderUtil.Gather(r) {
        @Override
        protected void add(int base, AtomicIndexReader r) throws IOException {
          final Fields f = r.fields();
          if (f != null) {
            fields.add(f);
            slices.add(new ReaderUtil.Slice(base, r.maxDoc(), fields.size()-1));
          }
        }
      }.run();

      if (fields.isEmpty()) {
        return null;
      } else if (fields.size() == 1) {
        return fields.get(0);
      } else {
        return new MultiFields(fields.toArray(Fields.EMPTY_ARRAY),
                                       slices.toArray(ReaderUtil.Slice.EMPTY_ARRAY));
      }
    }
  }

