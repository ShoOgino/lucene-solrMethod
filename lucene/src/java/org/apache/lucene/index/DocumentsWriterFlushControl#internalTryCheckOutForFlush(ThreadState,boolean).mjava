  private DocumentsWriterPerThread internalTryCheckOutForFlush(
      ThreadState perThread, boolean setPending) {
    if (setPending && !perThread.flushPending) {
      setFlushPending(perThread);
    }
    if (perThread.flushPending) {
      // we are pending so all memory is already moved to flushBytes
      if (perThread.tryLock()) {
        try {
          if (perThread.isActive()) {
            assert perThread.isHeldByCurrentThread();
            final DocumentsWriterPerThread dwpt;
            final long bytes = perThread.perThreadBytes; // do that before
                                                         // replace!
            dwpt = perThreadPool.replaceForFlush(perThread, closed);
            assert !flushingWriters.containsKey(dwpt) : "DWPT is already flushing";
            // record the flushing DWPT to reduce flushBytes in doAfterFlush
            flushingWriters.put(dwpt, Long.valueOf(bytes));
            numPending--; // write access synced
            numFlushing++;
            return dwpt;
          }
        } finally {
          perThread.unlock();
        }
      }
    }
    return null;
  }

