    public FieldsReader(final SegmentReadState readState) throws IOException {

      // Read _X.per and init each format:
      boolean success = false;
      try {
        new VisitPerFieldFile(readState.dir, readState.segmentInfo.name, readState.segmentSuffix) {
          @Override
          protected void visitOneFormat(String segmentSuffix, PostingsFormat postingsFormat) throws IOException {
            formats.put(postingsFormat, postingsFormat.fieldsProducer(new SegmentReadState(readState, segmentSuffix)));
          }

          @Override
          protected void visitOneField(String fieldName, PostingsFormat postingsFormat) throws IOException {
            assert formats.containsKey(postingsFormat);
            fields.put(fieldName, formats.get(postingsFormat));
          }
        };
        success = true;
      } finally {
        if (!success) {
          IOUtils.closeWhileHandlingException(formats.values());
        }
      }
    }

