    @Override
    public int nextDoc() {
      while (posPending > 0) {
        nextPosition();
      }
      while(true) {
        if (VERBOSE) System.out.println("  nextDoc cycle docUpto=" + docUpto + " numDocs=" + numDocs + " fp=" + in.getPosition() + " this=" + this);
        if (docUpto == numDocs) {
          if (VERBOSE) System.out.println("    END");
          return docID = NO_MORE_DOCS;
        }
        docUpto++;

        final int code = in.readVInt();
        docID += code >>> 1;
        if ((code & 1) != 0) {
          freq = 1;
        } else {
          freq = in.readVInt();
          assert freq > 0;
        }

        if (liveDocs == null || liveDocs.get(docID)) {
          pos = 0;
          posPending = freq;
          if (VERBOSE) System.out.println("    return docID=" + docID + " freq=" + freq);
          return docID;
        }

        // Skip positions
        for(int posUpto=0;posUpto<freq;posUpto++) {
          if (!storePayloads) {
            in.readVInt();
          } else {
            final int codeSkip = in.readVInt();
            if ((codeSkip & 1) != 0) {
              payloadLength = in.readVInt();
              if (VERBOSE) System.out.println("    new payloadLen=" + payloadLength);
            }
            in.skipBytes(payloadLength);
          }
        }
      }
    }

