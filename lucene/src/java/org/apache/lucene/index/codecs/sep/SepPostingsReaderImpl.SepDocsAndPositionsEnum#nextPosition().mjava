    @Override
    public int nextPosition() throws IOException {
      if (posSeekPending) {
        posIndex.seek(posReader);
        payloadIn.seek(payloadOffset);
        posSeekPending = false;
      }

      // scan over any docs that were iterated without their
      // positions
      while (pendingPosCount > freq) {
        final int code = posReader.next();
        if (storePayloads && (code & 1) != 0) {
          // Payload length has changed
          payloadLength = posReader.next();
          assert payloadLength >= 0;
        }
        pendingPosCount--;
        payloadPending = true;
        position = 0;
        pendingPayloadBytes += payloadLength;
      }

      final int code = posReader.next();
      if (storePayloads) {
        if ((code & 1) != 0) {
          // Payload length has changed
          payloadLength = posReader.next();
          assert payloadLength >= 0;
        }
        position += code >> 1;
      } else {
        position += code;
      }
    
      pendingPayloadBytes += payloadLength;
      payloadPending = payloadLength > 0;
      pendingPosCount--;
      payloadPending = true;
      assert pendingPosCount >= 0;
      return position;
    }

