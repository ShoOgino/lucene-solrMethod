  private final ThreadState acquireThreadState(DocumentsWriter documentsWriter, Document doc) {
    lock.lock();
    try {
      ThreadState threadState = selectThreadState(Thread.currentThread(), documentsWriter, doc);

      try {
        while (!threadState.isIdle || globalLock || aborting || threadState.perThread.aborting) {
          threadStateAvailable.await();
        }
      } catch (InterruptedException ie) {
        throw new ThreadInterruptedException(ie);
      }

      assert threadState.isIdle;

      threadState.isIdle = false;
      threadState.start();

      return threadState;

    } finally {
      lock.unlock();
    }
  }

