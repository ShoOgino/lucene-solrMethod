  @Override
  protected ThreadState selectThreadState(Thread requestingThread, DocumentsWriter documentsWriter, Document doc) {
    AffinityThreadState threadState = threadBindings.get(requestingThread);
    // First, find a thread state.  If this thread already
    // has affinity to a specific ThreadState, use that one
    // again.
    if (threadState == null) {
      AffinityThreadState minThreadState = null;
      for(int i=0;i<allThreadStates.length;i++) {
        AffinityThreadState ts = (AffinityThreadState) allThreadStates[i];
        if (minThreadState == null || ts.numAssignedThreads < minThreadState.numAssignedThreads)
          minThreadState = ts;
      }
      if (minThreadState != null && (minThreadState.numAssignedThreads == 0 || allThreadStates.length >= maxNumThreadStates)) {
        threadState = minThreadState;
      } else {
        threadState = addNewThreadState(documentsWriter, new AffinityThreadState());
      }
      threadBindings.put(requestingThread, threadState);
    }
    threadState.numAssignedThreads++;
    
    return threadState;
  }

