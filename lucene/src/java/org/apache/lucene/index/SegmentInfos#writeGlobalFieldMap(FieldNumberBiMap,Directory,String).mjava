  private final long writeGlobalFieldMap(FieldNumberBiMap map, Directory dir, String name) throws IOException {
    final IndexOutput output = dir.createOutput(name, IOContext.READONCE);
    boolean success = false;
    long version;
    try {
      version = map.write(output);
      success = true;
    } finally {
      try {
        output.close();
      } catch (Throwable t) {
        // throw orig excp
      }
      if (!success) {
        try {
          dir.deleteFile(name);
        } catch (Throwable t) {
          // throw orig excp
        }
      } else {
        // we must sync here explicitly since during a commit
        // IW will not sync the global field map. 
        dir.sync(Collections.singleton(name));
      }
    }
    return version;
  }

