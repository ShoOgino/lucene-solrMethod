  // TODO: remove deletions from SR
  private synchronized void commitChanges() throws IOException {
    si.advanceDelGen();

    assert liveDocs.length() == si.docCount;

    // We can write directly to the actual name (vs to a
    // .tmp & renaming it) because the file is not live
    // until segments file is written:
    final String delFileName = si.getDelFileName();
    boolean success = false;
    try {
      liveDocs.write(directory(), delFileName, IOContext.DEFAULT);
      success = true;
    } finally {
      if (!success) {
        try {
          directory().deleteFile(delFileName);
        } catch (Throwable t) {
          // suppress this so we keep throwing the
          // original exception
        }
      }
    }
    si.setDelCount(si.getDelCount()+pendingDeleteCount);
    pendingDeleteCount = 0;
    assert (maxDoc()-liveDocs.count()) == si.getDelCount(): "delete count mismatch during commit: info=" + si.getDelCount() + " vs BitVector=" + (maxDoc()-liveDocs.count());
    hasChanges = false;
  }

