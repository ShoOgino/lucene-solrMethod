  public void addDocument(Document doc, Analyzer analyzer) throws IOException {
    docState.doc = doc;
    docState.analyzer = analyzer;
    docState.docID = numDocsInRAM;
    initSegmentName(false);
  
    final DocWriter perDoc;
    
    boolean success = false;
    try {
      perDoc = consumer.processDocument();
      
      success = true;
    } finally {
      if (!success) {
        if (!aborting) {
          // mark document as deleted
          commitDocument(-1);
        }
      }
    }

    success = false;
    try {
      if (perDoc != null) {
        perDoc.finish();
      }
      
      success = true;
    } finally {
      if (!success) {
        setAborting();
      }
    }

  }

