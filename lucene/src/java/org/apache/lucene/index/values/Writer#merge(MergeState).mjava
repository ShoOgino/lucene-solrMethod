  @Override
  protected void merge(MergeState state) throws IOException {
    // This enables bulk copies in subclasses per MergeState, subclasses can
    // simply override this and decide if they want to merge
    // segments using this generic implementation or if a bulk merge is possible
    // / feasible.
    final ValuesEnum valEnum = state.reader.getEnum();
    assert valEnum != null;
    try {
      setNextEnum(valEnum); // set the current enum we are working on - the
      // impl. will get the correct reference for the type
      // it supports
      int docID = state.docBase;
      final Bits bits = state.bits;
      final int docCount = state.docCount;
      int currentDocId;
      if ((currentDocId = valEnum.advance(0)) != ValuesEnum.NO_MORE_DOCS) {
        for (int i = 0; i < docCount; i++) {
          if (bits == null || !bits.get(i)) {
            if (currentDocId < i) {
              if ((currentDocId = valEnum.advance(i)) == ValuesEnum.NO_MORE_DOCS) {
                break; // advance can jump over default values
              }
            }
            if (currentDocId == i) { // we are on the doc to merge
              add(docID);
            }
            ++docID;
          }
        }
      }
    } finally {
      valEnum.close();
    }
  }

