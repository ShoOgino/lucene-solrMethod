    @Override
    public void finish(int docCount) throws IOException {
      boolean success = false;
      try {
        if (!merge) {
          // indexing path - no disk IO until here
          assert datOut == null;
          datOut = getDataOut();
          if (size == -1) {
            datOut.writeInt(0);
          } else {
            datOut.writeInt(size);
            pool.writePool(datOut);
          }
          if (lastDocID + 1 < docCount) {
            fill(datOut, docCount);
          }
        } else {
          // merge path - datOut should be initialized
          assert datOut != null;
          if (size == -1) {// no data added
            datOut.writeInt(0);
          } else {
            fill(datOut, docCount);
          }
        }
        success = true;
      } finally {
        pool.dropBuffersAndReset();
        IOUtils.closeSafely(!success, datOut);
      }
    }

