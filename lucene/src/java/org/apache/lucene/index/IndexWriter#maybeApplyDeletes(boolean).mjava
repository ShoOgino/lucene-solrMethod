  final synchronized void maybeApplyDeletes(boolean applyAllDeletes) throws IOException {
    if (!applyAllDeletes) {
      // nocommit -- shouldn't this move into the default
      // flush policy?
      // If deletes alone are consuming > 1/2 our RAM
      // buffer, force them all to apply now. This is to
      // prevent too-frequent flushing of a long tail of
      // tiny segments:
      if ((config.getRAMBufferSizeMB() != IndexWriterConfig.DISABLE_AUTO_FLUSH &&
           bufferedDeletesStream.bytesUsed() > (1024*1024*config.getRAMBufferSizeMB()/2))) {
        applyAllDeletes = true;
        if (infoStream != null) {
          message("force apply deletes bytesUsed=" + bufferedDeletesStream.bytesUsed() + " vs ramBuffer=" + (1024*1024*config.getRAMBufferSizeMB()));
        }
      }
    }

    if (applyAllDeletes) {
      if (infoStream != null) {
        message("apply all deletes during flush");
      }
      applyAllDeletes();
    } else if (infoStream != null) {
      message("don't apply deletes now delTermCount=" + bufferedDeletesStream.numTerms() + " bytesUsed=" + bufferedDeletesStream.bytesUsed());
    }

  }

