  synchronized DocumentsWriterPerThread doAfterDocument(ThreadState perThread,
      boolean isUpdate) {
    commitPerThreadBytes(perThread);
    if (!perThread.flushPending) {
      if (isUpdate) {
        flushPolicy.onUpdate(this, perThread);
      } else {
        flushPolicy.onInsert(this, perThread);
      }
      if (!perThread.flushPending && perThread.perThreadBytes > maxBytesPerDWPT) {
        // safety check to prevent a single DWPT exceeding its RAM limit. This
        // is super
        // important since we can not address more than 2048 MB per DWPT
        setFlushPending(perThread);
      }
    }
    final DocumentsWriterPerThread flushingDWPT = getFlushIfPending(perThread);
    healthiness.updateStalled(this);
    return flushingDWPT;
  }

