  /**
   * Closes all resources and writes the entry table
   * 
   * @throws IllegalStateException
   *           if close() had been called before or if no file has been added to
   *           this object
   */
  void close() throws IOException {
    if (closed) {
      throw new IllegalStateException("already closed");
    }
    IOException priorException = null;
    IndexOutput entryTableOut = null;
    try {
      if (entries.isEmpty()) {
        throw new IllegalStateException("CFS has no entries");
      }
      
      if (!pendingEntries.isEmpty() || outputTaken.get()) {
        throw new IllegalStateException("CFS has pending open files");
      }
      closed = true;
      // open the compound stream
      assert dataOut != null;
      long finalLength = dataOut.getFilePointer();
      assert assertFileLength(finalLength, dataOut);
      entryTableOut = directory.createOutput(entryTableName, IOContext.DEFAULT);
      writeEntryTable(entries.values(), entryTableOut);
    } catch (IOException e) {
      priorException = e;
    } finally {
      IOUtils.closeSafely(priorException, dataOut, entryTableOut);
    }
  }

