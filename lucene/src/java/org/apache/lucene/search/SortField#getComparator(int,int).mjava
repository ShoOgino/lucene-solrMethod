  /** Returns the {@link FieldComparator} to use for
   * sorting.
   *
   * @lucene.experimental
   *
   * @param numHits number of top hits the queue will store
   * @param sortPos position of this SortField within {@link
   *   Sort}.  The comparator is primary if sortPos==0,
   *   secondary if sortPos==1, etc.  Some comparators can
   *   optimize themselves when they are the primary sort.
   * @return {@link FieldComparator} to use when sorting
   */
  public FieldComparator getComparator(final int numHits, final int sortPos) throws IOException {

    switch (type) {
    case SCORE:
      return new FieldComparator.RelevanceComparator(numHits);

    case DOC:
      return new FieldComparator.DocComparator(numHits);

    case INT:
      if (useIndexValues) {
        return new FieldComparator.IntDocValuesComparator(numHits, field);
      } else {
        return new FieldComparator.IntComparator(numHits, field, parser, (Integer) missingValue);
      }

    case FLOAT:
      if (useIndexValues) {
        return new FieldComparator.FloatDocValuesComparator(numHits, field);
      } else {
        return new FieldComparator.FloatComparator(numHits, field, parser, (Float) missingValue);
      }

    case LONG:
      return new FieldComparator.LongComparator(numHits, field, parser, (Long) missingValue);

    case DOUBLE:
      return new FieldComparator.DoubleComparator(numHits, field, parser, (Double) missingValue);

    case BYTE:
      return new FieldComparator.ByteComparator(numHits, field, parser, (Byte) missingValue);

    case SHORT:
      return new FieldComparator.ShortComparator(numHits, field, parser, (Short) missingValue);

    case CUSTOM:
      assert comparatorSource != null;
      return comparatorSource.newComparator(field, numHits, sortPos, reverse);

    case STRING:
      if (useIndexValues) {
        return new FieldComparator.TermOrdValDocValuesComparator(numHits, field);
      } else {
        return new FieldComparator.TermOrdValComparator(numHits, field);
      }

    case STRING_VAL:
      if (useIndexValues) {
        return new FieldComparator.TermValDocValuesComparator(numHits, field);
      } else {
        return new FieldComparator.TermValComparator(numHits, field);
      }

    case REWRITEABLE:
      throw new IllegalStateException("SortField needs to be rewritten through Sort.rewrite(..) and SortField.rewrite(..)");
        
    default:
      throw new IllegalStateException("Illegal sort type: " + type);
    }
  }

