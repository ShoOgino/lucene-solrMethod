  @Override
  public DocIdSet getDocIdSet(AtomicReaderContext context, final Bits acceptDocs) throws IOException {
    final IndexReader reader = context.reader;
    final Object coreKey = reader.getCoreCacheKey();

    // Only cache if incoming acceptDocs is == live docs;
    // if Lucene passes in more interesting acceptDocs in
    // the future we don't want to over-cache:
    final boolean doCacheSubAcceptDocs = recacheDeletes && acceptDocs == reader.getLiveDocs();

    final Bits subAcceptDocs;
    if (doCacheSubAcceptDocs) {
      subAcceptDocs = acceptDocs;
    } else {
      subAcceptDocs = null;
    }

    DocIdSet docIdSet = cache.get(reader, coreKey, subAcceptDocs);
    if (docIdSet != null) {
      hitCount++;
    } else {
      missCount++;
      docIdSet = docIdSetToCache(filter.getDocIdSet(context, subAcceptDocs), reader);
      cache.put(coreKey, subAcceptDocs, docIdSet);
    }

    if (doCacheSubAcceptDocs) {
      return docIdSet;
    } else {
      return BitsFilteredDocIdSet.wrap(docIdSet, acceptDocs);
    }
  }

