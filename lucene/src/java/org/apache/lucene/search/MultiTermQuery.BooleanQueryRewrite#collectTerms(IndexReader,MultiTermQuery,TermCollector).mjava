    protected final int collectTerms(IndexReader reader, MultiTermQuery query, TermCollector collector) throws IOException {

      if (query.field == null) {
        throw new NullPointerException("If you implement getTermsEnum(), you must specify a non-null field in the constructor of MultiTermQuery.");
      }

      final Fields fields = MultiFields.getFields(reader);
      if (fields == null) {
        // reader has no fields
        return 0;
      }

      final Terms terms = fields.terms(query.field);
      if (terms == null) {
        // field does not exist
        return 0;
      }

      final TermsEnum termsEnum = query.getTermsEnum(reader);
      assert termsEnum != null;

      if (termsEnum == TermsEnum.EMPTY)
        return 0;
      final BoostAttribute boostAtt =
        termsEnum.attributes().addAttribute(BoostAttribute.class);
      collector.boostAtt = boostAtt;
      int count = 0;
      BytesRef term;
      final Term placeholderTerm = new Term(query.field);
      while ((term = termsEnum.next()) != null) {
        if (collector.collect(placeholderTerm.createTerm(term.utf8ToString()), boostAtt.getBoost())) {
          count++;
        } else {
          break;
        }
      }
      collector.boostAtt = null;
      return count;
    }

