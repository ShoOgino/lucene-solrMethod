  @Override
  public void files(final Directory dir, final SegmentInfo info, String segmentSuffix, final Set<String> files)
      throws IOException {

    final String mapFileName = IndexFileNames.segmentFileName(info.name, segmentSuffix, PER_FIELD_EXTENSION);
    files.add(mapFileName);

    try {
      new VisitPerFieldFile(dir, info.name, segmentSuffix) {
        @Override
        protected void visitOneFormat(String segmentSuffix, PostingsFormat format) throws IOException {
          format.files(dir, info, segmentSuffix, files);
        }

        @Override
          protected void visitOneField(String field, PostingsFormat format) {
        }
      };
    } catch (FileNotFoundException fnfe) {
      // TODO: this is somewhat shady... if we can't open
      // the .per file then most likely someone is calling
      // .files() after this segment was deleted, so, they
      // wouldn't be able to do anything with the files even
      // if we could return them, so we don't add any files
      // in this case.
    }
  }

