  /**
   * Replace last child of <code>state</code> with an already registered state
   * or register the last child state.
   */
  private void replaceOrRegister(State state) {
    final State child = state.lastChild();
    
    if (child.hasChildren()) replaceOrRegister(child);
    
    final State registered = register.get(child);
    if (registered != null) {
      state.replaceLastChild(registered);
    } else {
      register.put(child, child);
    }
  }

