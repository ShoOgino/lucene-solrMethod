  /**
   * Updates a document.
   * @see IndexWriter#updateDocument(Term, Document)
   */
  public void updateDocument(final Term t, final Document doc) throws IOException {
    if (doDocValues) {
      randomPerDocFieldValues(r, doc);
    }
    
    if (r.nextInt(5) == 3) {
      w.updateDocuments(t, new Iterable<Document>() {

        // @Override -- not until Java 1.6
        public Iterator<Document> iterator() {
          return new Iterator<Document>() {
            boolean done;
            
            // @Override -- not until Java 1.6
            public boolean hasNext() {
              return !done;
            }

            // @Override -- not until Java 1.6
            public void remove() {
              throw new UnsupportedOperationException();
            }

            // @Override -- not until Java 1.6
            public Document next() {
              if (done) {
                throw new IllegalStateException();
              }
              done = true;
              return doc;
            }
          };
        }
        });
    } else {
      w.updateDocument(t, doc);
    }
    maybeCommit();
  }

