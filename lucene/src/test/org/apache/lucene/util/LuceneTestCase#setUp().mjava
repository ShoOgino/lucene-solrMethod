  @Override
  protected void setUp() throws Exception {
    super.setUp();
    assertFalse("ensure your tearDown() calls super.tearDown()!!!", setup);
    setup = true;
    savedUncaughtExceptionHandler = Thread.getDefaultUncaughtExceptionHandler();
    Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {
      public void uncaughtException(Thread t, Throwable e) {
        uncaughtExceptions.add(new UncaughtExceptionEntry(t, e));
        if (savedUncaughtExceptionHandler != null)
          savedUncaughtExceptionHandler.uncaughtException(t, e);
      }
    });
    
    ConcurrentMergeScheduler.setTestMode();
    savedBoolMaxClauseCount = BooleanQuery.getMaxClauseCount();
    savedDefaultCodec = CodecProvider.getDefaultCodec();

    codec = _TestUtil.getTestCodec();
    if (codec.equals("random"))
      codec = CodecProvider.CORE_CODECS[seedRnd.nextInt(CodecProvider.CORE_CODECS.length)];

    // If we're running w/ PreFlex codec we must swap in the
    // test-only PreFlexRW codec (since core PreFlex can
    // only read segments):
    if (codec.equals("PreFlex")) {
      preFlexSav = LuceneTestCaseJ4.installPreFlexRW();
    } 
    CodecProvider.setDefaultCodec(codec);
  }

