  @Override
  public FieldsProducer fieldsProducer(SegmentReadState state) throws IOException {

    // Whenever IW opens readers, eg for merging, we have to
    // keep terms order in UTF16:

    boolean unicodeSortOrder;
    if (termSortOrder == null) {
      unicodeSortOrder = true;

      StackTraceElement[] trace = new Exception().getStackTrace();
      for (int i = 0; i < trace.length; i++) {
        //System.out.println(trace[i].getClassName());
        if ("org.apache.lucene.index.IndexWriter".equals(trace[i].getClassName())) {
          unicodeSortOrder = false;
          break;
        }
      }
      //System.out.println("PRW: " + unicodeSortOrder);
    } else {
      unicodeSortOrder = termSortOrder.equals("codepoint");
    }

    return new PreFlexFields(state.dir, state.fieldInfos, state.segmentInfo, state.readBufferSize, state.termsIndexDivisor, unicodeSortOrder);
  }

