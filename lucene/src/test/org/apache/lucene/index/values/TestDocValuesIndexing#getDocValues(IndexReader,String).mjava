  private IndexDocValues getDocValues(IndexReader reader, String field)
      throws IOException {
    boolean optimized = reader.isOptimized();
    PerDocValues perDoc = optimized ? reader.getSequentialSubReaders()[0].perDocValues()
        : MultiPerDocValues.getPerDocs(reader);
    switch (random.nextInt(optimized ? 3 : 2)) { // case 2 only if optimized
    case 0:
      return perDoc.docValues(field);
    case 1:
      IndexDocValues docValues = perDoc.docValues(field);
      if (docValues != null) {
        return docValues;
      }
      throw new RuntimeException("no such field " + field);
    case 2:// this only works if we are on an optimized index!
      return reader.getSequentialSubReaders()[0].docValues(field);
    }
    throw new RuntimeException();
  }

