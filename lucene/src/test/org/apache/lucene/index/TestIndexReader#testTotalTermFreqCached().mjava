  // Make sure totalTermFreq works correctly in the terms
  // dict cache
  public void testTotalTermFreqCached() throws Exception {
    Directory dir = newDirectory();
    IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig(TEST_VERSION_CURRENT, new MockAnalyzer(random)));
    Document d = new Document();
    d.add(newField("f", "a a b", TextField.TYPE_UNSTORED));
    writer.addDocument(d);
    IndexReader r = writer.getReader();
    writer.close();
    Terms terms = MultiFields.getTerms(r, "f");
    try {
      // Make sure codec impls totalTermFreq (eg PreFlex doesn't)
      Assume.assumeTrue(terms.totalTermFreq(new BytesRef("b")) != -1);
      assertEquals(1, terms.totalTermFreq(new BytesRef("b")));
      assertEquals(2, terms.totalTermFreq(new BytesRef("a")));
      assertEquals(1, terms.totalTermFreq(new BytesRef("b")));
    } finally {
      r.close();
      dir.close();
    }
  }

