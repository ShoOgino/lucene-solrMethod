  @Test
  public void testAllCommitsRemain() throws Exception {
    Directory dir = new RAMDirectory();
    IndexWriter writer = new IndexWriter(dir, new IndexWriterConfig(
        TEST_VERSION_CURRENT, new WhitespaceAnalyzer(TEST_VERSION_CURRENT))
        .setIndexDeletionPolicy(NoDeletionPolicy.INSTANCE));
    for (int i = 0; i < 10; i++) {
      Document doc = new Document();
      doc.add(new Field("c", "a" + i, Store.YES, Index.ANALYZED));
      writer.addDocument(doc);
      writer.commit();
      // the reason to expect i + 2 commits is because when IndexWriter is
      // created it creates a first commit. If this ever changes, then the
      // expected should be i + 1 (and this comment removed).
      assertEquals("wrong number of commits !", i + 2, IndexReader.listCommits(dir).size());
    }
    writer.close();
  }

