  @Test
  public void testRegularMerges() throws Exception {
    Random random = newRandom();
    Directory dir = newDirectory(random);
    populateDocs(random, dir, true);
    verifyPayloadExists(dir, "p", new BytesRef("p1"), NUM_DOCS);
    verifyPayloadExists(dir, "p", new BytesRef("p2"), NUM_DOCS);

    // Add two source dirs. By not adding the dest dir, we ensure its payloads
    // won't get processed.
    Map<Directory, DirPayloadProcessor> processors = new HashMap<Directory, DirPayloadProcessor>();
    processors.put(dir, new PerTermPayloadProcessor());
    IndexWriter writer = new IndexWriter(dir, getConfig(random));
    writer.setPayloadProcessorProvider(new PerDirPayloadProcessor(processors));
    writer.optimize();
    writer.close();

    verifyPayloadExists(dir, "p", new BytesRef("p1"), 0);
    verifyPayloadExists(dir, "p", new BytesRef("p2"), NUM_DOCS);
    dir.close();
  }

