  public void testExceptionsDuringCommit() throws Throwable {
    FailOnlyInCommit[] failures = new FailOnlyInCommit[] {
        // LUCENE-1214
        new FailOnlyInCommit(false, FailOnlyInCommit.PREPARE_STAGE), // fail during global field map is written
        new FailOnlyInCommit(true, FailOnlyInCommit.PREPARE_STAGE), // fail after global field map is written
        new FailOnlyInCommit(false, FailOnlyInCommit.FINISH_STAGE)  // fail while running finishCommit    
    };
    
    for (FailOnlyInCommit failure : failures) {
      MockDirectoryWrapper dir = newDirectory();
      IndexWriter w = new IndexWriter(dir, newIndexWriterConfig(
          TEST_VERSION_CURRENT, new MockAnalyzer(random)));
      Document doc = new Document();
      doc.add(newField("field", "a field", Field.Store.YES,
          Field.Index.ANALYZED));
      w.addDocument(doc);
      dir.failOn(failure);
      try {
        w.close();
        fail();
      } catch (IOException ioe) {
        fail("expected only RuntimeException");
      } catch (RuntimeException re) {
        // Expected
      }
      assertTrue(dir.fileExists("1.fnx"));
      assertTrue(failure.failOnCommit && failure.failOnDeleteFile);
      w.rollback();
      assertFalse(dir.fileExists("1.fnx"));
      // FIXME: on windows, this often fails! assertEquals(0, dir.listAll().length);
      dir.close();
    }
  }

