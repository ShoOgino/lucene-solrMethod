  @Override
  public MergeSpecification findForcedMerges(SegmentInfos infos, int maxNumSegments, Map<SegmentInfoPerCommit,Boolean> segmentsToMerge) throws IOException {
    
    assert maxNumSegments > 0;

    MergeSpecification spec = null;

    if (!isMerged(infos, maxNumSegments, segmentsToMerge)) {

      // Find the newest (rightmost) segment that needs to
      // be merged (other segments may have been flushed
      // since the merge started):
      int last = infos.size();
      while(last > 0) {

        final SegmentInfoPerCommit info = infos.info(--last);
        if (segmentsToMerge.containsKey(info)) {
          last++;
          break;
        }
      }

      if (last > 0) {

        if (maxNumSegments == 1) {

          // Since we must merge down to 1 segment, the
          // choice is simple:
          if (last > 1 || !isMerged(infos.info(0))) {

            spec = new MergeSpecification();
            spec.add(new OneMerge(infos.asList().subList(0, last)));
          }
        } else if (last > maxNumSegments) {

          // find most balanced merges
          spec = findBalancedMerges(infos, last, maxNumSegments, _partialExpunge);
        }
      }
    }
    return spec;
  }

