  // LUCENE-5307
  // don't reuse the scorer of filters since they have been created with bulkScorer=false
  public void testQueryWrapperFilter() throws IOException {
    Directory d = newDirectory();
    RandomIndexWriter w = new RandomIndexWriter(random(), d);
    Document doc = new Document();
    doc.add(newStringField("field", "a", Field.Store.NO));
    w.addDocument(doc);
    IndexReader r = w.getReader();
    w.close();

    final Query wrapped = AssertingQuery.wrap(random(), new TermQuery(new Term("field", "a")));
    Filter filter = new QueryWrapperFilter(wrapped);
    IndexSearcher s = newSearcher(r);
    assert s instanceof AssertingIndexSearcher;
    // this used to fail
    s.search(new ConstantScoreQuery(filter), new TotalHitCountCollector());
    
    // check the rewrite
    Query rewritten = filter;
    for (Query q = rewritten.rewrite(r); q != rewritten; q = rewritten.rewrite(r)) {
      rewritten = q;
    }
    assertEquals(new BoostQuery(new ConstantScoreQuery(wrapped), 0), rewritten);
    
    r.close();
    d.close();
  }

