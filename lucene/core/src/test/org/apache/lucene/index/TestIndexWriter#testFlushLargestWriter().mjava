  public void testFlushLargestWriter() throws IOException, InterruptedException {
    Directory dir = newDirectory();
    IndexWriter w = new IndexWriter(dir, new IndexWriterConfig());
    int numDocs = indexDocsForMultipleThreadStates(w);
    DocumentsWriterPerThreadPool.ThreadState largestNonPendingWriter
        = w.docWriter.flushControl.findLargestNonPendingWriter();
    assertFalse(largestNonPendingWriter.flushPending);
    assertNotNull(largestNonPendingWriter.dwpt);

    int numRamDocs = w.numRamDocs();
    int numDocsInDWPT = largestNonPendingWriter.dwpt.getNumDocsInRAM();
    assertTrue(w.flushNextBuffer());
    assertNull(largestNonPendingWriter.dwpt);
    assertEquals(numRamDocs-numDocsInDWPT, w.numRamDocs());

    // make sure it's not locked
    largestNonPendingWriter.lock();
    largestNonPendingWriter.unlock();
    if (random().nextBoolean()) {
      w.commit();
    }
    DirectoryReader reader = DirectoryReader.open(w, true, true);
    assertEquals(numDocs, reader.numDocs());
    reader.close();
    w.close();
    dir.close();
  }

