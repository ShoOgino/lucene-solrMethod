  private static void waitForDocsInBuffers(IndexWriter w, int buffersWithDocs) {
    // wait until at least N threadstates have a doc in order to observe
    // who flushes the segments.
    while(true) {
      int numStatesWithDocs = 0;
      DocumentsWriterPerThreadPool perThreadPool = w.docWriter.perThreadPool;
      for (int i = 0; i < perThreadPool.getActiveThreadStateCount(); i++) {
        DocumentsWriterPerThreadPool.ThreadState threadState = perThreadPool.getThreadState(i);
        threadState.lock();
        try {
          DocumentsWriterPerThread dwpt = threadState.dwpt;
          if (dwpt != null && dwpt.getNumDocsInRAM() > 1) {
            numStatesWithDocs++;
          }
        } finally {
          threadState.unlock();
        }
      }
      if (numStatesWithDocs >= buffersWithDocs) {
        return;
      }
    }
  }

