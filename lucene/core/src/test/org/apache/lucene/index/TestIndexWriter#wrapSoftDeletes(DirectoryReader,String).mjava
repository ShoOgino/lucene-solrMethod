  private static DirectoryReader wrapSoftDeletes(DirectoryReader reader, String field) throws IOException {
    return new FilterDirectoryReader(reader, new FilterDirectoryReader.SubReaderWrapper() {
      @Override
      public LeafReader wrap(LeafReader reader) {
        Bits softDeletesLiveDocs = getSoftDeletesLiveDocs(reader, field);
        int numDocs = getNumDocs(reader, softDeletesLiveDocs);
        return new FilterLeafReader(reader) {

          @Override
          public Bits getLiveDocs() {
            return softDeletesLiveDocs;
          }

          @Override
          public CacheHelper getReaderCacheHelper() {
            return in.getReaderCacheHelper();
          }

          @Override
          public CacheHelper getCoreCacheHelper() {
            return in.getCoreCacheHelper();
          }

          @Override
          public int numDocs() {
            return numDocs;
          }
        };
      }
    }) {
      @Override
      protected DirectoryReader doWrapDirectoryReader(DirectoryReader in) throws IOException {
        return wrapSoftDeletes(in, field);
      }

      @Override
      public CacheHelper getReaderCacheHelper() {
        return in.getReaderCacheHelper();
      }
    };
  }

