  @Test
  public void testReuse() throws Exception {
    Directory dir = newDirectory();
    // test that IWC cannot be reused across two IWs
    IndexWriterConfig conf = newIndexWriterConfig(TEST_VERSION_CURRENT, null);
    new RandomIndexWriter(random(), dir, conf).close();

    // this should fail
    try {
      assertNotNull(new RandomIndexWriter(random(), dir, conf));
      fail("should have hit AlreadySetException");
    } catch (AlreadySetException e) {
      // expected
    }

    // also cloning it won't help, after it has been used already
    try {
      assertNotNull(new RandomIndexWriter(random(), dir, conf.clone()));
      fail("should have hit AlreadySetException");
    } catch (AlreadySetException e) {
      // expected
    }
    
    // if it's cloned in advance, it should be ok
    conf = newIndexWriterConfig(TEST_VERSION_CURRENT, null);
    new RandomIndexWriter(random(), dir, conf.clone()).close();
    new RandomIndexWriter(random(), dir, conf.clone()).close();
    
    dir.close();
  }

