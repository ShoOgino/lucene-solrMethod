  public void testVirusScannerDoesntCorruptIndex() throws IOException {
    Path path = createTempDir();
    VirusCheckingFS fs = new VirusCheckingFS(path.getFileSystem(), random());
    FileSystem filesystem = fs.getFileSystem(URI.create("file:///"));
    fs.disable();

    Path path2 = new FilterPath(path, filesystem);

    Directory dir = newFSDirectory(path2);
    
    // add empty commit
    new IndexWriter(dir, new IndexWriterConfig(null)).close();
    // add a trash unreferenced file
    dir.createOutput("_0.si", IOContext.DEFAULT).close();

    // start virus scanner
    fs.enable();
    
    IndexWriter iw = new IndexWriter(dir, new IndexWriterConfig(null));
    iw.addDocument(new Document());
    // stop virus scanner
    fs.disable();
    iw.commit();
    iw.close();
    dir.close();
  }

