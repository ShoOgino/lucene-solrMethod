  @Test
  public void testDeleteUnusedUpdatesFiles() throws Exception {
    Directory dir = newDirectory();
    IndexWriterConfig conf = newIndexWriterConfig(TEST_VERSION_CURRENT, new MockAnalyzer(random()));
    IndexWriter writer = new IndexWriter(dir, conf);
    
    Document doc = new Document();
    doc.add(new StringField("id", "d0", Store.NO));
    doc.add(new NumericDocValuesField("f", 1L));
    writer.addDocument(doc);

    // create first gen of update files
    writer.updateNumericDocValue(new Term("id", "d0"), "f", 2L);
    writer.commit();
    int numFiles = dir.listAll().length;

    DirectoryReader r = DirectoryReader.open(dir);
    assertEquals(2L, r.leaves().get(0).reader().getNumericDocValues("f").get(0));
    r.close();
    
    // create second gen of update files, first gen should be deleted
    writer.updateNumericDocValue(new Term("id", "d0"), "f", 5L);
    writer.commit();
    assertEquals(numFiles, dir.listAll().length);

    r = DirectoryReader.open(dir);
    assertEquals(5L, r.leaves().get(0).reader().getNumericDocValues("f").get(0));
    r.close();

    writer.close();
    dir.close();
  }

