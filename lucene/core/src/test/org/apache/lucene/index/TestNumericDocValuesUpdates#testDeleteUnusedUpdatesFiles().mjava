  @Test
  public void testDeleteUnusedUpdatesFiles() throws Exception {
    Directory dir = newDirectory();
    IndexWriterConfig conf = newIndexWriterConfig(TEST_VERSION_CURRENT, new MockAnalyzer(random()));
    IndexWriter writer = new IndexWriter(dir, conf);
    
    Document doc = new Document();
    doc.add(new StringField("id", "d0", Store.NO));
    doc.add(new NumericDocValuesField("f", 1L));
    writer.addDocument(doc);

    // create _0_1.fnm
    writer.updateNumericDocValue(new Term("id", "d0"), "f", 2L);
    writer.commit();

    // create _0_2.fnm, and _0_1.fnm should be deleted
    writer.updateNumericDocValue(new Term("id", "d0"), "f", 2L);
    writer.commit();

    assertTrue(dir.fileExists("_0_2.fnm"));
    assertFalse("old generation field infos file should not exist in the directory: _0_1.fnm", dir.fileExists("_0_1.fnm"));
    
    writer.close();
    dir.close();
  }

