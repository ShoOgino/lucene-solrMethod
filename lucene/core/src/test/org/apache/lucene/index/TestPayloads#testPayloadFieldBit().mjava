    // Tests whether the DocumentWriter and SegmentMerger correctly enable the
    // payload bit in the FieldInfo
    public void testPayloadFieldBit() throws Exception {
        Directory ram = newDirectory();
        PayloadAnalyzer analyzer = new PayloadAnalyzer();
        IndexWriter writer = new IndexWriter(ram, newIndexWriterConfig( TEST_VERSION_CURRENT, analyzer));
        Document d = new Document();
        // this field won't have any payloads
        d.add(newField("f1", "This field has no payloads", TextField.TYPE_UNSTORED));
        // this field will have payloads in all docs, however not for all term positions,
        // so this field is used to check if the DocumentWriter correctly enables the payloads bit
        // even if only some term positions have payloads
        d.add(newField("f2", "This field has payloads in all docs", TextField.TYPE_UNSTORED));
        d.add(newField("f2", "This field has payloads in all docs NO PAYLOAD", TextField.TYPE_UNSTORED));
        // this field is used to verify if the SegmentMerger enables payloads for a field if it has payloads 
        // enabled in only some documents
        d.add(newField("f3", "This field has payloads in some docs", TextField.TYPE_UNSTORED));
        // only add payload data for field f2
        analyzer.setPayloadData("f2", "somedata".getBytes(), 0, 1);
        writer.addDocument(d);
        // flush
        writer.close();

      SegmentReader reader = getOnlySegmentReader(IndexReader.open(ram));
        FieldInfos fi = reader.getFieldInfos();
        assertFalse("Payload field bit should not be set.", fi.fieldInfo("f1").hasPayloads());
        assertTrue("Payload field bit should be set.", fi.fieldInfo("f2").hasPayloads());
        assertFalse("Payload field bit should not be set.", fi.fieldInfo("f3").hasPayloads());
        reader.close();
        
        // now we add another document which has payloads for field f3 and verify if the SegmentMerger
        // enabled payloads for that field
        analyzer = new PayloadAnalyzer(); // Clear payload state for each field
        writer = new IndexWriter(ram, newIndexWriterConfig( TEST_VERSION_CURRENT,
            analyzer).setOpenMode(OpenMode.CREATE));
        d = new Document();
        d.add(newField("f1", "This field has no payloads", TextField.TYPE_UNSTORED));
        d.add(newField("f2", "This field has payloads in all docs", TextField.TYPE_UNSTORED));
        d.add(newField("f2", "This field has payloads in all docs", TextField.TYPE_UNSTORED));
        d.add(newField("f3", "This field has payloads in some docs", TextField.TYPE_UNSTORED));
        // add payload data for field f2 and f3
        analyzer.setPayloadData("f2", "somedata".getBytes(), 0, 1);
        analyzer.setPayloadData("f3", "somedata".getBytes(), 0, 3);
        writer.addDocument(d);

        // force merge
        writer.forceMerge(1);
        // flush
        writer.close();

      reader = getOnlySegmentReader(IndexReader.open(ram));
        fi = reader.getFieldInfos();
        assertFalse("Payload field bit should not be set.", fi.fieldInfo("f1").hasPayloads());
        assertTrue("Payload field bit should be set.", fi.fieldInfo("f2").hasPayloads());
        assertTrue("Payload field bit should be set.", fi.fieldInfo("f3").hasPayloads());
        reader.close();
        ram.close();
    }

