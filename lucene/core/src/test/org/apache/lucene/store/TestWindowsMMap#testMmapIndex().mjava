  public void testMmapIndex() throws Exception {
    // sometimes the directory is not cleaned by rmDir, because on Windows it
    // may take some time until the files are finally dereferenced. So clean the
    // directory up front, or otherwise new IndexWriter will fail.
    File dirPath = createTempDir("testLuceneMmap");
    rmDir(dirPath);
    MMapDirectory dir = new MMapDirectory(dirPath, null);
    
    // plan to add a set of useful stopwords, consider changing some of the
    // interior filters.
    MockAnalyzer analyzer = new MockAnalyzer(random());
    // TODO: something about lock timeouts and leftover locks.
    IndexWriter writer = new IndexWriter(dir, new IndexWriterConfig(
        TEST_VERSION_CURRENT, analyzer)
        .setOpenMode(OpenMode.CREATE));
    writer.commit();
    IndexReader reader = DirectoryReader.open(dir);
    IndexSearcher searcher = newSearcher(reader);
    
    int num = atLeast(1000);
    for(int dx = 0; dx < num; dx ++) {
      String f = randomField();
      Document doc = new Document();
      doc.add(newTextField("data", f, Field.Store.YES));  
      writer.addDocument(doc);
    }
    
    reader.close();
    writer.shutdown();
    rmDir(dirPath);
  }

