  public void testCreateOutputWithPendingDeletes() throws IOException {
    Path path = createTempDir();
    // Use WindowsFS to prevent open files from being deleted:
    FileSystem fs = new WindowsFS(path.getFileSystem()).getFileSystem(URI.create("file:///"));
    Path root = new FilterPath(path, fs);
    Directory directory = getDirectory(root);
    IndexOutput output = directory.createOutput("file.txt", IOContext.DEFAULT);
    output.writeInt(1);
    output.close();
    IndexInput input = directory.openInput("file.txt", IOContext.DEFAULT);
    directory.deleteFile("file.txt");
    expectThrows(IOException.class, () -> {
      directory.createOutput("file.txt", IOContext.DEFAULT);
    });
    assertTrue(directory.getPendingDeletions().isEmpty());
    assertEquals(1, input.readInt());
    IOUtils.close(input, directory);
  }

