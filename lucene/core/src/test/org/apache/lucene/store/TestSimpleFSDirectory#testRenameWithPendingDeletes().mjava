  public void testRenameWithPendingDeletes() throws IOException {
    Path path = createTempDir();
    // Use WindowsFS to prevent open files from being deleted:
    FileSystem fs = new WindowsFS(path.getFileSystem()).getFileSystem(URI.create("file:///"));
    Path root = new FilterPath(path, fs);
    Directory directory = getDirectory(root);
    IndexOutput output = directory.createOutput("target.txt", IOContext.DEFAULT);
    output.writeInt(1);
    output.close();
    IndexOutput output1 = directory.createOutput("source.txt", IOContext.DEFAULT);
    output1.writeInt(2);
    output1.close();

    IndexInput input = directory.openInput("target.txt", IOContext.DEFAULT);
    directory.deleteFile("target.txt");
    directory.rename("source.txt", "target.txt");
    IndexInput input1 = directory.openInput("target.txt", IOContext.DEFAULT);
    assertTrue(directory.getPendingDeletions().isEmpty());
    assertEquals(1, input.readInt());
    assertEquals(2, input1.readInt());
    IOUtils.close(input1, input, directory);
  }

