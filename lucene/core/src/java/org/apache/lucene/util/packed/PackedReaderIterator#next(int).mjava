  @Override
  public LongsRef next(int count) throws IOException {
    assert nextValues.length >= 0;
    assert count > 0;
    assert nextValues.offset + nextValues.length <= nextValues.longs.length;

    final long[] nextBlocks = this.nextBlocks.array();

    nextValues.offset += nextValues.length;

    final int remaining = valueCount - position - 1;
    if (remaining <= 0) {
      throw new EOFException();
    }
    count = Math.min(remaining, count);

    if (nextValues.offset == nextValues.longs.length) {
      final int remainingBlocks = format.nblocks(bitsPerValue, remaining);
      final int blocksToRead = Math.min(remainingBlocks, nextBlocks.length);
      for (int i = 0; i < blocksToRead; ++i) {
        nextBlocks[i] = in.readLong();
      }
      for (int i = blocksToRead; i < nextBlocks.length; ++i) {
        nextBlocks[i] = 0L;
      }

      this.nextBlocks.rewind();
      nextValuesBuffer.clear();
      bulkOperation.decode(this.nextBlocks, nextValuesBuffer, iterations);
      nextValues.offset = 0;
    }

    nextValues.length = Math.min(nextValues.longs.length - nextValues.offset, count);
    position += nextValues.length;
    return nextValues;
  }

