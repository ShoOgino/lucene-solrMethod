  @Override
  public int set(int index, long[] arr, int off, int len) {
    assert len > 0 : "len must be > 0 (got " + len + ")";
    assert index >= 0 && index < valueCount;
    len = Math.min(len, valueCount - index);
    assert off + len <= arr.length;

    final int originalIndex = index;

    // go to the next block boundary
    final int offsetInBlock = offsetInBlock(index);
    if (offsetInBlock != 0) {
      for (int i = offsetInBlock; i < valuesPerBlock && len > 0; ++i) {
        set(index++, arr[off++]);
        --len;
      }
      if (len == 0) {
        return index - originalIndex;
      }
    }

    // bulk set
    assert offsetInBlock(index) == 0;
    final int startBlock = blockOffset(index);
    final int endBlock = blockOffset(index + len);
    final int diff = (endBlock - startBlock) * valuesPerBlock;
    index += diff; len -= diff;
    for (int block = startBlock; block < endBlock; ++block) {
      long next = 0L;
      for (int i = 0; i < valuesPerBlock; ++i) {
        next |= (arr[off++] << shifts[i]);
      }
      blocks[block] = next;
    }

    if (index > originalIndex) {
      // stay at the block boundary
      return index - originalIndex;
    } else {
      // no progress so far => already at a block boundary but no full block to
      // set
      assert index == originalIndex;
      return super.set(index, arr, off, len);
    }
  }

