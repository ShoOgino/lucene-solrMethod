  /**
   * Creates a span query from the tokenstream.  In the case of a single token, a simple <code>SpanTermQuery</code> is
   * returned.  When multiple tokens, an ordered <code>SpanNearQuery</code> with slop 0 is returned.
   */
  protected SpanQuery createSpanQuery(TokenStream in, String field) throws IOException {
    TermToBytesRefAttribute termAtt = in.getAttribute(TermToBytesRefAttribute.class);
    BoostAttribute boostAtt = in.addAttribute(BoostAttribute.class);

    SpanQuery result;
    float boost = DEFAULT_BOOST;
    if (termAtt == null) {
      return null;
    }

    List<SpanTermQuery> terms = new ArrayList<>();
    while (in.incrementToken()) {
      boost *= boostAtt.getBoost();
      terms.add(new SpanTermQuery(new Term(field, termAtt.getBytesRef())));
    }

    if (terms.isEmpty()) {
      return null;
    } else if (terms.size() == 1) {
      result = terms.get(0);
    } else {
      result = new SpanNearQuery(terms.toArray(new SpanQuery[0]), 0, true);
    }

    if (boost != DEFAULT_BOOST) {
      result = new SpanBoostQuery(result, boost);
    }
    return result;
  }

