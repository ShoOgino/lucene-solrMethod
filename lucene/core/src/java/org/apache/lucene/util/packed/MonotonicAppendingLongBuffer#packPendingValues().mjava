  @Override
  void packPendingValues() {
    assert pendingOff > 0;
    final float average = pendingOff == 1 ? 0 : (float) (pending[pendingOff - 1] - pending[0]) / (pendingOff - 1);
    long minValue = pending[0];
    // adjust minValue so that all deltas will be positive
    for (int i = 1; i < pendingOff; ++i) {
      final long actual = pending[i];
      final long expected = expected(minValue, average, i);
      if (expected > actual) {
        minValue -= (expected - actual);
      }
    }

    minValues[valuesOff] = minValue;
    averages[valuesOff] = average;

    for (int i = 0; i < pendingOff; ++i) {
      pending[i] = pending[i] - expected(minValue, average, i);
    }
    long maxDelta = 0;
    for (int i = 0; i < pendingOff; ++i) {
      if (pending[i] < 0) {
        maxDelta = -1;
        break;
      } else {
        maxDelta = Math.max(maxDelta, pending[i]);
      }
    }
    if (maxDelta == 0) {
      values[valuesOff] = new PackedInts.NullReader(pendingOff);
    } else {
      final int bitsRequired = PackedInts.unsignedBitsRequired(maxDelta);
      final PackedInts.Mutable mutable = PackedInts.getMutable(pendingOff, bitsRequired, acceptableOverheadRatio);
      for (int i = 0; i < pendingOff; ) {
        i += mutable.set(i, pending, i, pendingOff - i);
      }
      values[valuesOff] = mutable;
    }
  }

