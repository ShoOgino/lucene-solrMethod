  @Override
  public void copyBytes(IndexOutput out, long numBytes) throws IOException {
    assert numBytes >= 0: "numBytes=" + numBytes;
    
    long left = numBytes;
    while (left > 0) {
      if (bufferPosition == bufferLength) {
        ++currentBufferIndex;
        switchCurrentBuffer(true);
      }
      
      final int bytesInBuffer = bufferLength - bufferPosition;
      final int toCopy = (int) (bytesInBuffer < left ? bytesInBuffer : left);
      out.writeBytes(currentBuffer, bufferPosition, toCopy);
      bufferPosition += toCopy;
      left -= toCopy;
    }
    
    assert left == 0: "Insufficient bytes to copy: numBytes=" + numBytes + " copied=" + (numBytes - left);
  }

