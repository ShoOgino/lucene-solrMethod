    public static DocMap build(AtomicReader reader) {
      final int maxDoc = reader.maxDoc();
      final int numDeletes = reader.numDeletedDocs();
      final int numDocs = maxDoc - numDeletes;
      assert reader.getLiveDocs() != null || numDeletes == 0;
      if (numDeletes == 0) {
        return new NoDelDocMap(maxDoc);
      } else if (numDeletes < numDocs) {
        return buildDelCountDocmap(maxDoc, numDeletes, reader.getLiveDocs(), PackedInts.COMPACT);
      } else {
        return buildDirectDocMap(maxDoc, numDocs, reader.getLiveDocs(), PackedInts.COMPACT);
      }
    }

