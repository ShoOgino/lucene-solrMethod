  /** Decrefs all provided files, even on exception; throws first exception hit, if any. */
  void decRef(Collection<String> files) throws IOException {
    assert locked();
    Set<String> toDelete = new HashSet<>();
    Throwable firstThrowable = null;
    for(final String file : files) {
      try {
        if (decRef(file)) {
          toDelete.add(file);
        }
      } catch (Throwable t) {
        if (firstThrowable == null) {
          // Save first exception and throw it in the end, but be sure to finish decRef all files
          firstThrowable = t;
        }
      }
    }

    try {
      deleteFiles(toDelete);
    } catch (Throwable t) {
      if (firstThrowable == null) {
        // Save first exception and throw it in the end, but be sure to finish decRef all files
        firstThrowable = t;
      }
    }

    // NOTE: does nothing if firstThrowable is null
    IOUtils.reThrow(firstThrowable);
  }

