  /** Returns null when done */
  public T next() {
    // Loop until we find a non-deleted document
    if (queue != null) {
      T top = queue.top();
      if (top == null) {
        // NOTE: it's annoying that caller is allowed to call us again even after we returned null before
        return null;
      }

      if (first == false) {
        while (true) {
          int docID = top.nextDoc();
          if (docID == NO_MORE_DOCS) {
            queue.pop();
            top = queue.top();
            break;
          } else if (top.liveDocs != null && top.liveDocs.get(docID) == false) {
            continue;
          } else {
            top.mappedDocID = top.docMap.get(docID);
            top = queue.updateTop();
            break;
          }
        }
      }

      first = false;

      return top;

    } else {
      while (true) {
        if (current == null) {
          // NOTE: it's annoying that caller is allowed to call us again even after we returned null before
          return null;
        }
        int docID = current.nextDoc();
        if (docID == NO_MORE_DOCS) {
          if (nextIndex == subs.size()) {
            current = null;
            return null;
          }
          current = subs.get(nextIndex);
          nextIndex++;
          continue;
        } else if (current.liveDocs != null && current.liveDocs.get(docID) == false) {
          // Document is deleted
          continue;
        }

        current.mappedDocID = current.docMap.get(docID);
        return current;
      }
    }
  }

