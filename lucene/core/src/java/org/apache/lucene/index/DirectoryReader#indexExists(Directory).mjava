  /**
   * Returns <code>true</code> if an index exists at the specified directory.
   * @param  directory the directory to check for an index
   * @return <code>true</code> if an index exists; <code>false</code> otherwise
   */
  public static boolean indexExists(Directory directory) {
    try {
      new FindSegmentsFile(directory) {
        @Override
        protected Object doBody(String segmentFileName) throws IOException {
          try {
            new SegmentInfos().read(directory, segmentFileName);
          } catch (FileNotFoundException ex) {
            if (!directory.fileExists(segmentFileName)) {
              throw ex;
            }
            /* this is ok - we might have run into a access exception here.
             * or even worse like on LUCENE-4870 this is triggered due to
             * too many open files on the system. In that case we rather report
             * a false positive here since wrongly returning false from indexExist
             * can cause data loss since IW relies on this.*/
          }
          return null;
        }
      }.run();
      return true;
    } catch (IOException ioe) {
      return false;
    }
  }

