  /** Copies the segment files as-is into the IndexWriter's directory. */
  private SegmentInfo copySegmentAsIs(SegmentInfo info, String segName,
                                      Map<String, String> dsNames, Set<String> dsFilesCopied, IOContext context,
                                      Set<String> copiedFiles)
      throws IOException {
    // Determine if the doc store of this segment needs to be copied. It's
    // only relevant for segments that share doc store with others,
    // because the DS might have been copied already, in which case we
    // just want to update the DS name of this SegmentInfo.
    String dsName = info.getDocStoreSegment();
    assert dsName != null;
    final String newDsName;
    if (dsNames.containsKey(dsName)) {
      newDsName = dsNames.get(dsName);
    } else {
      dsNames.put(dsName, segName);
      newDsName = segName;
    }
    
    Set<String> codecDocStoreFiles = new HashSet<String>();
    if (info.getDocStoreOffset() != -1) {
      // only violate the codec this way if its preflex
      info.getCodec().storedFieldsFormat().files(info, codecDocStoreFiles);
      info.getCodec().termVectorsFormat().files(info, codecDocStoreFiles);
    }

    //System.out.println("copy seg=" + info.name + " version=" + info.getVersion());
    
    // Copy the segment files
    for (String file: info.files()) {

      // nocommit messy: insteda we should pull .files()
      // from the codec's SIFormat and check if it's in
      // there...
      if (file.endsWith(".si")) {
        continue;
      }

      final String newFileName;
      if (codecDocStoreFiles.contains(file)) {
        newFileName = newDsName + IndexFileNames.stripSegmentName(file);
        if (dsFilesCopied.contains(newFileName)) {
          continue;
        }
        dsFilesCopied.add(newFileName);
      } else {
        newFileName = segName + IndexFileNames.stripSegmentName(file);
      }

      assert !directory.fileExists(newFileName): "file \"" + newFileName + "\" already exists";
      assert !copiedFiles.contains(file): "file \"" + file + "\" is being copied more than once";
      copiedFiles.add(file);
      //System.out.println("COPY " + file + " -> " + newFileName);
      info.dir.copy(directory, file, newFileName, context);
    }
    
    // Same SI as before but we change directory and name:
    SegmentInfo newInfo = new SegmentInfo(directory, info.getVersion(), segName, info.docCount, info.getDocStoreOffset(),
                                          newDsName, info.getDocStoreIsCompoundFile(), info.getNormGen(), info.getUseCompoundFile(),
                                          info.getDelCount(), info.getCodec(), info.getDiagnostics());
    newInfo.setDelGen(info.getDelGen());

    // nocommit need to pass real FIS...
    // nocommit maybe we don't pass FIS......?
    // nocommit messy....
    //if (!newInfo.getCodec().getName().equals("Lucene3x")) {
    if (!newInfo.getVersion().startsWith("3.")) {
      //System.out.println("  now write si for seg=" + newInfo.name + " codec=" + newInfo.getCodec());
      newInfo.getCodec().segmentInfosFormat().getSegmentInfosWriter().write(newInfo, null);
    }
    
    return newInfo;
  }

