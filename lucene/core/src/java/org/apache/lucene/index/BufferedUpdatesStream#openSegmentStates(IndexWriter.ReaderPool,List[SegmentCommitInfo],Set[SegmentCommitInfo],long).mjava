  /** Opens SegmentReader and inits SegmentState for each segment. */
  public SegmentState[] openSegmentStates(IndexWriter.ReaderPool pool, List<SegmentCommitInfo> infos,
                                          Set<SegmentCommitInfo> alreadySeenSegments, long delGen) throws IOException {
    ensureOpen();

    List<SegmentState> segStates = new ArrayList<>();
    try {
      for (SegmentCommitInfo info : infos) {
        if (info.getBufferedDeletesGen() <= delGen && alreadySeenSegments.contains(info) == false) {
          segStates.add(new SegmentState(pool, info));
          alreadySeenSegments.add(info);
        }
      }
    } catch (Throwable t) {
      for(SegmentState segState : segStates) {
        try {
          segState.finish(pool);
        } catch (Throwable th) {
          t.addSuppressed(th);
        }
      }
      throw t;
    }
    
    return segStates.toArray(new SegmentState[0]);
  }

