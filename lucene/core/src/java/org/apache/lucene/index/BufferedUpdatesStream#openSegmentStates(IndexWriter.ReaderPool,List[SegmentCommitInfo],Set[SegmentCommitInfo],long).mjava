  /** Opens SegmentReader and inits SegmentState for each segment. */
  public SegmentState[] openSegmentStates(IndexWriter.ReaderPool pool, List<SegmentCommitInfo> infos,
                                          Set<SegmentCommitInfo> alreadySeenSegments, long delGen) throws IOException {
    ensureOpen();

    List<SegmentState> segStates = new ArrayList<>();
    boolean success = false;
    try {
      for (SegmentCommitInfo info : infos) {
        if (info.getBufferedDeletesGen() <= delGen && alreadySeenSegments.contains(info) == false) {
          segStates.add(new SegmentState(pool, info));
          alreadySeenSegments.add(info);
        }
      }
      success = true;
    } finally {
      if (success == false) {
        for(SegmentState segState : segStates) {
            try {
              segState.finish(pool);
            } catch (Throwable th) {
              // suppress so we keep throwing original exc
            }
        }
      }
    }
    
    return segStates.toArray(new SegmentState[0]);
  }

