  /** Returns how many documents were aborted. */
  private final int abortThreadState(final ThreadState perThread) {
    assert perThread.isHeldByCurrentThread();
    if (perThread.isActive()) { // we might be closed
      if (perThread.isInitialized()) { 
        try {
          int abortedDocCount = perThread.dwpt.getNumDocsInRAM();
          subtractFlushedNumDocs(abortedDocCount);
          perThread.dwpt.abort();
          return abortedDocCount;
        } finally {
          flushControl.doOnAbort(perThread);
        }
      } else {
        flushControl.doOnAbort(perThread);
        // This DWPT was never initialized so it has no indexed documents:
        return 0;
      }
    } else {
      assert closed;
      return 0;
    }
  }

