  @Override
  public void add(int doc, Object value) {
    // TODO: if the Sorter interface changes to take long indexes, we can remove that limitation
    if (size == Integer.MAX_VALUE) {
      throw new IllegalStateException("cannot support more than Integer.MAX_VALUE doc/value entries");
    }

    BytesRef val = (BytesRef) value;
    if (val == null) {
      val = BinaryDocValuesUpdate.MISSING;
    }
    
    // grow the structures to have room for more elements
    if (docs.size() == size) {
      docs = docs.grow(size + 1);
      offsets = offsets.grow(size + 1);
      lengths = lengths.grow(size + 1);
      docsWithField = FixedBitSet.ensureCapacity(docsWithField, (int) docs.size());
    }
    
    if (val != BinaryDocValuesUpdate.MISSING) {
      // only mark the document as having a value in that field if the value wasn't set to null (MISSING)
      docsWithField.set(size);
    }
    
    docs.set(size, doc);
    offsets.set(size, values.length);
    lengths.set(size, val.length);
    values.append(val);
    ++size;
  }

