  @Override
  Sorter.DocComparator getDocComparator(int maxDoc, SortField sortField) throws IOException {
    assert sortField.getType().equals(SortField.Type.STRING);
    assert finalSortedValues == null && finalOrdMap == null &&finalOrds == null;
    int valueCount = hash.size();
    finalSortedValues = hash.sort();
    finalOrds = pending.build();
    finalOrdMap = new int[valueCount];
    for (int ord = 0; ord < valueCount; ord++) {
      finalOrdMap[finalSortedValues[ord]] = ord;
    }
    final SortedDocValues docValues =
        new BufferedSortedDocValues(hash, valueCount, finalOrds, finalSortedValues, finalOrdMap,
            docsWithField.iterator());
    return Sorter.getDocComparator(maxDoc, sortField, () -> docValues, () -> null);
  }

