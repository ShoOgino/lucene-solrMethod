  @Override
  public void flush(SegmentWriteState state, SimpleDVConsumer dvConsumer) throws IOException {
    final int maxDoc = state.segmentInfo.getDocCount();

    dvConsumer.addBinaryField(fieldInfo,
                              new Iterable<BytesRef>() {

                                @Override
                                public Iterator<BytesRef> iterator() {
                                   return new Iterator<BytesRef>() {
                                     BytesRef value = new BytesRef();
                                     int upto;

                                     @Override
                                     public boolean hasNext() {
                                       return upto < maxDoc;
                                     }

                                     @Override
                                     public void remove() {
                                       throw new UnsupportedOperationException();
                                     }

                                     @Override
                                     public BytesRef next() {
                                       // nocommit make
                                       // mutable Number:
                                       if (upto < bytesRefArray.size()) {
                                         bytesRefArray.get(value, upto);
                                       } else {
                                         value.length = 0;
                                       }
                                       upto++;
                                       return value;
                                     }
                                   };
                                 }
                               });

    reset();
  }

