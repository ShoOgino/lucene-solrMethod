  /**
   * Implementation for {@link #close()} when {@link IndexWriterConfig#commitOnClose} is true.
   */
  private void shutdown() throws IOException {
    if (pendingCommit != null) {
      throw new IllegalStateException("cannot close: prepareCommit was already called with no corresponding call to commit");
    }
    if (infoStream.isEnabled("IW")) {
      infoStream.message("IW", "now flush at close");
    }
    boolean success = false;
    try {
      flush(true, true);
      finishMerges(true);
      commit();
      rollback(); // ie close, since we just committed
      success = true;
    } finally {
      if (success == false) {
        // Be certain to close the index on any exception
        try {
          rollback();
        } catch (Throwable t) {
          // Suppress so we keep throwing original exception
        }
      }
    }
  }

