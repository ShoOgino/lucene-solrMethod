  @Override
  public FieldsProducer fieldsProducer(SegmentReadState state) throws IOException {
    PostingsReaderBase postingsReader = new Lucene50PostingsReader(state);
    String fstLoadModeKey = state.segmentInfo.getAttribute(MODE_KEY);
    FSTLoadMode fstLoadMode = FSTLoadMode.AUTO;
    if (fstLoadModeKey != null) {
      fstLoadMode = FSTLoadMode.valueOf(fstLoadModeKey);
    }
    boolean success = false;
    try {
      FieldsProducer ret = new BlockTreeTermsReader(postingsReader, state, fstLoadMode);
      success = true;
      return ret;
    } finally {
      if (!success) {
        IOUtils.closeWhileHandlingException(postingsReader);
      }
    }
  }

