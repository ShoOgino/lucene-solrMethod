  @Override
  public void addPosition(int position, int startOffset, int endOffset, BytesRef payload) throws IOException {
    if (positions && (offsets || payloads)) {
      // write position delta
      writePosition(position - lastPosition, payload);
      lastPosition = position;
      
      // buffer offsets
      if (offsets) {
        offsetStartBuffer[bufferedIndex] = startOffset;
        offsetEndBuffer[bufferedIndex] = endOffset;
      }
      
      bufferedIndex++;
      
      // dump buffer if we are done
      if (bufferedIndex == bufferedFreq) {
        if (payloads) {
          tvf.writeBytes(payloadData.bytes, payloadData.offset, payloadData.length);
        }
        for (int i = 0; i < bufferedIndex; i++) {
          if (offsets) {
            tvf.writeVInt(offsetStartBuffer[i] - lastOffset);
            tvf.writeVInt(offsetEndBuffer[i] - offsetStartBuffer[i]);
            lastOffset = offsetEndBuffer[i];
          }
        }
      }
    } else if (positions) {
      // write position delta
      writePosition(position - lastPosition, payload);
      lastPosition = position;
    } else if (offsets) {
      // write offset deltas
      tvf.writeVInt(startOffset - lastOffset);
      tvf.writeVInt(endOffset - startOffset);
      lastOffset = endOffset;
    }
  }

