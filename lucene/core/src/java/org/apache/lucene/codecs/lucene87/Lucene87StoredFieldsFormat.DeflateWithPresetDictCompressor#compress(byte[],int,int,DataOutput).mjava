    @Override
    public void compress(byte[] bytes, int off, int len, DataOutput out) throws IOException {
      final int dictLength = Math.min(dictBytes.length, len);
      System.arraycopy(bytes, off, dictBytes, 0, dictLength);
      out.writeVInt(dictLength);
      out.writeVInt(blockLength);
      final int end = off + len;

      // Compress the dictionary first
      compressor.reset();
      doCompress(bytes, off, dictLength, out);

      // And then sub blocks
      for (int start = off + dictLength; start < end; start += blockLength) {
        compressor.reset();
        // NOTE: offset MUST be 0 when setting the dictionary in order to work around JDK-8252739
        compressor.setDictionary(dictBytes, 0, dictLength);
        doCompress(bytes, start, Math.min(blockLength, off + len - start), out);
      }
    }

