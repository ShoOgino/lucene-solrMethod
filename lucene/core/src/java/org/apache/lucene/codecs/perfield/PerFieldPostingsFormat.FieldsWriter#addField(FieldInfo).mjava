    @Override
    public TermsConsumer addField(FieldInfo field) throws IOException {
      final PostingsFormat format = getPostingsFormatForField(field.name);
      if (format == null) {
        throw new IllegalStateException("invalid null PostingsFormat for field=\"" + field.name + "\"");
      }
      
      String previousValue = field.putAttribute(PER_FIELD_FORMAT_KEY, format.getName());
      assert previousValue == null;

      FieldsConsumer consumer = formats.get(format);
      if (consumer == null) {
        // First time we are seeing this format; create a new instance
        final String segmentSuffix = getFullSegmentSuffix(field.name,
                                                          segmentWriteState.segmentSuffix,
                                                          format.getName());
        consumer = format.fieldsConsumer(new SegmentWriteState(segmentWriteState, segmentSuffix));
        formats.put(format, consumer);
      }

      // TODO: we should only provide the "slice" of FIS
      // that this PF actually sees ... then stuff like
      // .hasProx could work correctly?
      // NOTE: .hasProx is already broken in the same way for the non-perfield case,
      // if there is a fieldinfo with prox that has no postings, you get a 0 byte file.
      return consumer.addField(field);
    }

