  /**
   * Write a block of data (<code>For</code> format).
   *
   * @param data     the data to write
   * @param encoded  a buffer to use to encode data
   * @param out      the destination output
   * @throws IOException
   */
  void writeBlock(long[] data, byte[] encoded, IndexOutput out) throws IOException {
    if (isAllEqual(data)) {
      out.writeVInt(ALL_VALUES_EQUAL);
      out.writeInt((int) data[0]);
      return;
    }

    final int numBits = bitsRequired(data);
    assert numBits > 0 && numBits <= 32 : numBits;
    final PackedInts.Encoder encoder = encoders[numBits];
    final int iters = iterations[numBits];
    assert iters * encoder.valueCount() >= BLOCK_SIZE;
    final int encodedSize = encodedSize(numBits);
    assert (iters * encoder.blockCount()) << 3 >= encodedSize;

    out.writeVInt(numBits);

    encoder.encode(data, 0, encoded, 0, iters);
    out.writeBytes(encoded, encodedSize);
  }

