  @Override
  public Query rewrite(IndexReader reader) throws IOException {
    if (filter instanceof QueryWrapperFilter) {
      // In that case the filter does not implement random-access anyway so
      // we want to take advantage of approximations
      BooleanQuery rewritten = new BooleanQuery();
      rewritten.add(query, Occur.MUST);
      rewritten.add(((QueryWrapperFilter) filter).getQuery(), Occur.FILTER);
      rewritten.setBoost(getBoost());
      return rewritten;
    }

    final Query queryRewritten = query.rewrite(reader);
    
    if (queryRewritten != query) {
      // rewrite to a new FilteredQuery wrapping the rewritten query
      final Query rewritten = new FilteredQuery(queryRewritten, filter, strategy);
      rewritten.setBoost(this.getBoost());
      return rewritten;
    } else {
      // nothing to rewrite, we are done!
      return this;
    }
  }

