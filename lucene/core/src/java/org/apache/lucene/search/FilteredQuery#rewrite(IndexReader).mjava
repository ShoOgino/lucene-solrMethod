  @Override
  public Query rewrite(IndexReader reader) throws IOException {
    final Query queryRewritten = query.rewrite(reader);
    final Query filterRewritten = filter.rewrite(reader);
    
    if (queryRewritten != query || filterRewritten != filter) {
      // rewrite to a new FilteredQuery wrapping the rewritten query/filter
      if (filterRewritten instanceof Filter) {
        final Query rewritten = new FilteredQuery(queryRewritten, (Filter) filterRewritten, strategy);
        rewritten.setBoost(this.getBoost());
        return rewritten;
      } else {
        // In that case the filter does not implement random-access anyway so
        // we want to take advantage of approximations
        BooleanQuery rewritten = new BooleanQuery();
        rewritten.add(queryRewritten, Occur.MUST);
        rewritten.add(filterRewritten, Occur.FILTER);
        rewritten.setBoost(getBoost());
        return rewritten;
      }
    }
    // nothing to rewrite, we are done!
    return this;
  }

