    @SuppressWarnings("fallthrough")
    protected int toNextDocWithAllowedPosition() throws IOException {
      startPos = in.nextStartPosition();
      assert startPos != NO_MORE_POSITIONS;
      for (;;) {
        switch(acceptPosition(in)) {
          case YES:
            atFirstInCurrentDoc = true;
            return in.docID();
          case NO:
            startPos = in.nextStartPosition();
            if (startPos != NO_MORE_POSITIONS) {
              break;
            }
            // else fallthrough
          case NO_MORE_IN_CURRENT_DOC:
            if (in.nextDoc() == NO_MORE_DOCS) {
              startPos = -1;
              return NO_MORE_DOCS;
            }
            startPos = in.nextStartPosition();
            assert startPos != NO_MORE_POSITIONS : "no start position at doc="+in.docID();
            break;
        }
      }
    }

