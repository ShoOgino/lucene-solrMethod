  @Override
  public BitSet getBitSet(LeafReaderContext context) throws IOException {
    final LeafReader reader = context.reader();
    final Object key = reader.getCoreCacheKey();

    DocIdSet docIdSet = cache.get(key);
    if (docIdSet == null) {
      final IndexReaderContext topLevelContext = ReaderUtil.getTopLevelContext(context);
      final IndexSearcher searcher = new IndexSearcher(topLevelContext);
      searcher.setQueryCache(null);
      final Weight weight = searcher.createNormalizedWeight(query, false);
      final DocIdSetIterator it = weight.scorer(context);

      BitDocIdSet.Builder builder = new BitDocIdSet.Builder(context.reader().maxDoc());
      if (it != null) {
        builder.or(it);
      }
      docIdSet = builder.build();
      if (docIdSet == null) {
        // We use EMPTY as a sentinel for the empty set, which is cacheable
        docIdSet = DocIdSet.EMPTY;
      }
      cache.put(key, docIdSet);
    }
    return docIdSet == DocIdSet.EMPTY ? null : ((BitDocIdSet) docIdSet).bits();
  }

