    @Override
    public int nextDoc() throws IOException {
      //System.out.println("Q.nextDoc() nextChildDoc=" + nextChildDoc);

      // Loop until we hit a parentDoc that's accepted
      while (true) {
        if (nextChildDoc == NO_MORE_DOCS) {
          //System.out.println("  end");
          return parentDoc = NO_MORE_DOCS;
        }

        // Gather all children sharing the same parent as
        // nextChildDoc

        parentDoc = parentBits.nextSetBit(nextChildDoc);

        //System.out.println("  parentDoc=" + parentDoc);
        assert parentDoc != -1;

        //System.out.println("  nextChildDoc=" + nextChildDoc);
        if (acceptDocs != null && !acceptDocs.get(parentDoc)) {
          // Parent doc not accepted; skip child docs until
          // we hit a new parent doc:
          do {
            nextChildDoc = childScorer.nextDoc();
          } while (nextChildDoc < parentDoc);
          continue;
        }

        float totalScore = 0;
        float totalFreq = 0;
        float maxScore = Float.NEGATIVE_INFINITY;
        float maxFreq = 0;

        childDocUpto = 0;
        do {

          //System.out.println("  c=" + nextChildDoc);
          if (pendingChildDocs.length == childDocUpto) {
            pendingChildDocs = ArrayUtil.grow(pendingChildDocs);
          }
          if (scoreMode != ScoreMode.None && pendingChildScores.length == childDocUpto) {
            pendingChildScores = ArrayUtil.grow(pendingChildScores);
          }
          pendingChildDocs[childDocUpto] = nextChildDoc;
          if (scoreMode != ScoreMode.None) {
            // TODO: specialize this into dedicated classes per-scoreMode
            final float childScore = childScorer.score();
            final float childFreq = childScorer.freq();
            pendingChildScores[childDocUpto] = childScore;
            maxScore = Math.max(childScore, maxScore);
            maxFreq = Math.max(childFreq, maxFreq);
            totalScore += childScore;
            totalFreq += childFreq;
          }
          childDocUpto++;
          nextChildDoc = childScorer.nextDoc();
        } while (nextChildDoc < parentDoc);

        // Parent & child docs are supposed to be orthogonal:
        assert nextChildDoc != parentDoc;

        switch(scoreMode) {
        case Avg:
          parentScore = totalScore / childDocUpto;
          parentFreq = totalFreq / childDocUpto;
          break;
        case Max:
          parentScore = maxScore;
          parentFreq = maxFreq;
          break;
        case Total:
          parentScore = totalScore;
          parentFreq = totalFreq;
          break;
        case None:
          break;
        }

        //System.out.println("  return parentDoc=" + parentDoc);
        return parentDoc;
      }
    }

