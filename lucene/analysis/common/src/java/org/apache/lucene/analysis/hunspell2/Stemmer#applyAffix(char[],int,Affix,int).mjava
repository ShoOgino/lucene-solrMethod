  /**
   * Applies the affix rule to the given word, producing a list of stems if any are found
   *
   * @param strippedWord Word the affix has been removed and the strip added
   * @param affix HunspellAffix representing the affix rule itself
   * @param recursionDepth Level of recursion this stemming step is at
   * @return List of stems for the word, or an empty list if none are found
   */
  public List<CharsRef> applyAffix(char strippedWord[], int length, Affix affix, int recursionDepth) {
    segment.setLength(0);
    segment.append(strippedWord, 0, length);
    
    Pattern pattern = dictionary.patterns.get(affix.getCondition());
    if (!pattern.matcher(segment).matches()) {
      return Collections.emptyList();
    }

    List<CharsRef> stems = new ArrayList<CharsRef>();

    char wordFlags[] = dictionary.lookupWord(strippedWord, 0, length, scratch);
    if (wordFlags != null && Dictionary.hasFlag(wordFlags, affix.getFlag())) {
      stems.add(new CharsRef(strippedWord, 0, length));
    }

    if (affix.isCrossProduct() && recursionDepth < recursionCap) {
      BytesRef scratch = new BytesRef();
      dictionary.flagLookup.get(affix.getAppendFlags(), scratch);
      char appendFlags[] = Dictionary.decodeFlags(scratch);
      stems.addAll(stem(strippedWord, length, appendFlags, ++recursionDepth));
    }

    return stems;
  }

