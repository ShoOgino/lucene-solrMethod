  @Override
  public final boolean incrementToken() throws IOException {
    while (true) {
      if (state == TokenState.READING) {
        if (bufferedState != null) {
          restoreState(bufferedState);
          bufferedState = null;
          lastTokenFiltered = false;
          return true;
        }
        if (exhausted == true) {
          return false;
        }
        if (input.incrementToken() == false) {
          exhausted = true;
          return false;
        }
        if (shouldFilter()) {
          // we're chopping the underlying Tokenstream up into fragments, and presenting
          // only those parts of it that pass the filter to the delegate, so the delegate is
          // in effect seeing multiple tokenstream snippets.  Tokenstreams can't have an initial
          // position increment of 0, so if the snippet starts on a stacked token we need to
          // offset it here and then correct the increment back again after delegation
          boolean adjustPosition = false;
          if (posIncAtt.getPositionIncrement() == 0) {
            posIncAtt.setPositionIncrement(1);
            adjustPosition = true;
          }
          lastTokenFiltered = true;
          state = TokenState.PREBUFFERING;
          // we determine that the delegate has emitted all the tokens it can at the current
          // position when OneTimeWrapper.incrementToken() is called in DELEGATING state.  To
          // signal this back to the delegate, we return false, so we now need to reset it
          // to ensure that it can continue to emit more tokens
          delegate.reset();
          boolean more = delegate.incrementToken();
          if (more) {
            state = TokenState.DELEGATING;
            if (adjustPosition) {
              int posInc = posIncAtt.getPositionIncrement();
              posIncAtt.setPositionIncrement(posInc - 1);
            }
          }
          else {
            lastTokenFiltered = false;
            state = TokenState.READING;
            if (bufferedState != null) {
              delegate.end();
              int posInc = posIncAtt.getPositionIncrement();
              restoreState(bufferedState);
              posIncAtt.setPositionIncrement(posIncAtt.getPositionIncrement() + posInc);
              bufferedState = null;
              return true;
            }
          }
          return more || bufferedState != null;
        }
        lastTokenFiltered = false;
        return true;
      }
      if (state == TokenState.DELEGATING) {
        if (delegate.incrementToken()) {
          return true;
        }
        // no more cached tokens
        state = TokenState.READING;
      }
    }
  }

