  @Override
  public final boolean incrementToken() throws IOException {
    while (true) {
      if (state == TokenState.READING) {
        if (bufferedState != null) {
          restoreState(bufferedState);
          bufferedState = null;
          lastTokenFiltered = false;
          return true;
        }
        if (exhausted == true) {
          return false;
        }
        if (input.incrementToken() == false) {
          exhausted = true;
          return false;
        }
        if (shouldFilter()) {
          lastTokenFiltered = true;
          state = TokenState.PREBUFFERING;
          // we determine that the delegate has emitted all the tokens it can at the current
          // position when OneTimeWrapper.incrementToken() is called in DELEGATING state.  To
          // signal this back to the delegate, we return false, so we now need to reset it
          // to ensure that it can continue to emit more tokens
          delegate.reset();
          boolean more = delegate.incrementToken();
          if (more) {
            state = TokenState.DELEGATING;
          }
          else {
            lastTokenFiltered = false;
            state = TokenState.READING;
            if (bufferedState != null) {
              delegate.end();
              int posInc = posIncAtt.getPositionIncrement();
              restoreState(bufferedState);
              posIncAtt.setPositionIncrement(posIncAtt.getPositionIncrement() + posInc);
              bufferedState = null;
              return true;
            }
          }
          return more || bufferedState != null;
        }
        lastTokenFiltered = false;
        return true;
      }
      if (state == TokenState.DELEGATING) {
        if (delegate.incrementToken()) {
          return true;
        }
        // no more cached tokens
        state = TokenState.READING;
      }
    }
  }

