    /**
     * Sets up the request, creating the list of headers to send and creating
     * instances of the modules. This may be invoked by subclasses which add
     * further methods (such as those from DAV and IPP).
     *
     * @param method               GET, POST, etc.
     * @param resource             the resource
     * @param headers              an array of headers to be used
     * @param entity               the entity (or null)
     * @param stream               the output stream (or null) - only one of
     *      stream and entity may be non-null
     * @return                     the response.
     * @exception ModuleException  if an exception is encountered in any module.
     * @exception IOException      Description of the Exception
     */
    protected final HTTPResponse setupRequest(String method, String resource,
            NVPair[] headers, byte[] entity,
            HttpOutputStream stream)
        throws IOException, ModuleException
    {
        Request req = new Request(this, method, resource,
                mergedHeaders(headers), entity, stream,
                allowUI);
        RequestList.addToEnd(req);

        try
        {
            HTTPResponse resp = new HTTPResponse(gen_mod_insts(), Timeout, req, defaultIncrement);
            handleRequest(req, resp, null, true);
            return resp;
        }
        finally
        {
            RequestList.remove(req);
        }
    }

