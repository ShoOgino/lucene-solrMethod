  /**
   * Read all input from an InputStream and return as a byte array.
   * This method will not return before the end of the stream is reached.
   * @return    contents of the stream
   */
  public static byte[] readAll(InputStream in) throws IOException {
    byte[] buf = new byte[1024];
    int nread, ntotal = 0;

    while ((nread = in.read(buf, ntotal, buf.length - ntotal)) > -1) {
      ntotal += nread;
      if (ntotal == buf.length) {
        // extend buffer
        byte[] newbuf = new byte[buf.length * 2];
        System.arraycopy(buf, 0, newbuf, 0, buf.length);
        buf = newbuf;
      }
    }
    if (ntotal < buf.length) {
      // we cannot have excess space
      byte[] newbuf = new byte[ntotal];
      System.arraycopy(buf, 0, newbuf, 0, ntotal);
      buf = newbuf;
    }
    return buf;
  }

