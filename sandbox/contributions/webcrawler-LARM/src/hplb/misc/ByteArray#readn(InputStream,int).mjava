  /**
   * Reads n bytes from the specified input stream. It will return
   * fewer bytes if fewer bytes are available on the stream.
   * Hence the application should check the resulting arrays length.
   */
  public static byte[] readn(InputStream in, int n) throws IOException {
    byte[] buf = new byte[n];
    int ntotal = 0;
    int nread;

    while (ntotal < n) {
      nread = in.read(buf, ntotal, n - ntotal);
      if (nread < 0) {
        // we got less than expected - return what we got
        byte[] newbuf = new byte[ntotal];
        System.arraycopy(buf, 0, newbuf, 0, ntotal);
        return newbuf;
      }
      ntotal += nread;
    }
    return buf;
  }

