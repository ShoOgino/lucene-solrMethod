    public ShardState(IndexSearcher s) {
      IndexReader[] subReaders = s.getIndexReader().getSequentialSubReaders();
      if (subReaders == null) {
        subReaders = new IndexReader[] {s.getIndexReader()};
      }
      subSearchers = new ShardSearcher[subReaders.length];
      final IndexReader.ReaderContext ctx = s.getTopReaderContext();
      if (ctx instanceof IndexReader.AtomicReaderContext) {
        assert subSearchers.length == 1;
        subSearchers[0] = new ShardSearcher((IndexReader.AtomicReaderContext) ctx, ctx);
      } else {
        final IndexReader.CompositeReaderContext compCTX = (IndexReader.CompositeReaderContext) ctx;
        for(int searcherIDX=0;searcherIDX<subSearchers.length;searcherIDX++) {
          subSearchers[searcherIDX] = new ShardSearcher(compCTX.leaves[searcherIDX], compCTX);
        }
      }

      docStarts = new int[subSearchers.length];
      int docBase = 0;
      for(int subIDX=0;subIDX<docStarts.length;subIDX++) {
        docStarts[subIDX] = docBase;
        docBase += subReaders[subIDX].maxDoc();
        //System.out.println("docStarts[" + subIDX + "]=" + docStarts[subIDX]);
      }
    }

