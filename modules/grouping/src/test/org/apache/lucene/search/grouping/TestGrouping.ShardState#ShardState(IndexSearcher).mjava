    public ShardState(IndexSearcher s) {
      List<AtomicIndexReader> subReaders = new ArrayList<AtomicIndexReader>();
      ReaderUtil.gatherSubReaders(subReaders, s.getIndexReader());
      subSearchers = new ShardSearcher[subReaders.size()];
      final IndexReader.ReaderContext ctx = s.getTopReaderContext();
      if (ctx instanceof AtomicReaderContext) {
        assert subSearchers.length == 1;
        subSearchers[0] = new ShardSearcher((AtomicReaderContext) ctx, ctx);
      } else {
        final CompositeIndexReader.CompositeReaderContext compCTX = (CompositeIndexReader.CompositeReaderContext) ctx;
        for(int searcherIDX=0;searcherIDX<subSearchers.length;searcherIDX++) {
          subSearchers[searcherIDX] = new ShardSearcher(compCTX.leaves()[searcherIDX], compCTX);
        }
      }

      docStarts = new int[subSearchers.length];
      int docBase = 0;
      for(int subIDX=0;subIDX<docStarts.length;subIDX++) {
        docStarts[subIDX] = docBase;
        docBase += subReaders.get(subIDX).maxDoc();
        //System.out.println("docStarts[" + subIDX + "]=" + docStarts[subIDX]);
      }
    }

