  @Override
  public int doLogic() throws Exception {
    IndexReader r = getRunData().getIndexReader();
    int maxDoc = r.maxDoc();
    int numDeleted = 0;
    // percent is an absolute target:
    int numToDelete = ((int) (maxDoc * percent)) - r.numDeletedDocs();
    if (numToDelete < 0) {
      r.undeleteAll();
      numToDelete = (int) (maxDoc * percent);
    }
    while (numDeleted < numToDelete) {
      double delRate = ((double) (numToDelete-numDeleted))/r.numDocs();
      Bits liveDocs = MultiFields.getLiveDocs(r);
      int doc = 0;
      while (doc < maxDoc && numDeleted < numToDelete) {
        if ((liveDocs == null || liveDocs.get(doc)) && random.nextDouble() <= delRate) {
          r.deleteDocument(doc);
          numDeleted++;
          if (liveDocs == null) {
            liveDocs = MultiFields.getLiveDocs(r);
            assert liveDocs != null;
          }
        }
        doc++;
      }
    }
    System.out.println("--> processed (delete) " + numDeleted + " docs");
    r.decRef();
    return numDeleted;
  }

