  /**
   * Try out faceted search with sampling enabled and complements either disabled or enforced
   * Lots of randomly generated data is being indexed, and later on a "90% docs" faceted search
   * is performed. The results are compared to non-sampled ones.
   */
  public void testCountUsingSamping() throws Exception, IOException {
    for (int partitionSize : partitionSizes) {
      initIndex(partitionSize);
      
      // Get all of the documents and run the query, then do different
      // facet counts and compare to control
      Query q = new TermQuery(new Term(CONTENT_FIELD, BETA)); // 90% of the docs
      ScoredDocIdCollector docCollector = ScoredDocIdCollector.create(searcher.maxDoc(), false);
      
      FacetSearchParams expectedSearchParams = searchParamsWithRequests(K, partitionSize); 
      FacetsCollector fc = new FacetsCollector(expectedSearchParams, indexReader, taxoReader);
      
      searcher.search(q, MultiCollector.wrap(docCollector, fc));
      
      List<FacetResult> expectedResults = fc.getFacetResults();
      
      // complement with sampling!
      final Sampler sampler = createSampler(docCollector.getScoredDocIDs());
      
      FacetSearchParams samplingSearchParams = searchParamsWithRequests(K, partitionSize); 

      assertSampling(expectedResults, q, sampler, samplingSearchParams, false);
      assertSampling(expectedResults, q, sampler, samplingSearchParams, true);

      closeAll();
    }
  }

