  /**
   * Try out faceted search with sampling enabled and complements either disabled or enforced
   * Lots of randomly generated data is being indexed, and later on a "90% docs" faceted search
   * is performed. The results are compared to non-sampled ones.
   */
  private void doTestWithSamping(boolean complement) throws Exception, IOException {
    for (int partitionSize : partitionSizes) {
      initIndex(partitionSize);
      
      // Get all of the documents and run the query, then do different
      // facet counts and compare to control
      Query q = new TermQuery(new Term(CONTENT_FIELD, BETA)); // 90% of the docs
      ScoredDocIdCollector docCollector = ScoredDocIdCollector.create(searcher.maxDoc(), false);
      
      FacetSearchParams expectedSearchParams = searchParamsWithRequests(K, partitionSize); 
      FacetsCollector fc = new FacetsCollector(expectedSearchParams, indexReader, taxoReader);
      
      searcher.search(q, MultiCollector.wrap(docCollector, fc));
      
      List<FacetResult> expectedResults = fc.getFacetResults();
      
      // complement with sampling!
      final Sampler sampler = createSampler(docCollector.getScoredDocIDs());
      
      FacetSearchParams samplingSearchParams = searchParamsWithRequests(K, partitionSize); 

      // try several times in case of failure, because the test has a chance to fail 
      // if the top K facets are not sufficiently common with the sample set
      for (int n=RETRIES; n>0; n--) {
        FacetsCollector samplingFC = samplingCollector(complement, sampler,  samplingSearchParams);
        
        searcher.search(q, samplingFC);
        List<FacetResult> sampledResults = samplingFC.getFacetResults();
        
        try {
          assertSameResults(expectedResults, sampledResults);
          break; // succeeded
        } catch (Exception e) {
          if (n<=1) { // otherwise try again
            throw e; 
          }
        }
      }
    }
  }

