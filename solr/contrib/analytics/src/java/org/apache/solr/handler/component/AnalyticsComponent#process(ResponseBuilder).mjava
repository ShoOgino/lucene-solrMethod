  @Override
  public void process(ResponseBuilder rb) throws IOException {
    if (!rb.doAnalytics) {
      return;
    }
    AnalyticsRequestManager reqManager = (AnalyticsRequestManager)rb._analyticsRequestManager;
    // Collect the data and generate a response
    AnalyticsDriver.drive(reqManager, rb.req.getSearcher(), rb.getResults().docSet.getTopFilter(), rb.req);

    if (rb._isOlapAnalytics) {
      rb.rsp.add(AnalyticsResponseHeadings.COMPLETED_OLD_HEADER, reqManager.createOldResponse());
    } else {
      rb.rsp.add(AnalyticsResponseHeadings.COMPLETED_HEADER, reqManager.createResponse());
    }

    rb.doAnalytics = false;
  }

