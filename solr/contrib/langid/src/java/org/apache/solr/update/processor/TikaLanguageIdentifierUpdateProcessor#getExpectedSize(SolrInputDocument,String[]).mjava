  /**
   * Calculate expected string size.
   *
   * @param doc           solr input document
   * @param fields        fields to select
   * @return expected size of string value
   */
  private int getExpectedSize(SolrInputDocument doc, String[] fields) {
    int docSize = 0;
    for (String field : fields) {
      Collection<Object> contents = doc.getFieldValues(field);
      for (Object content : contents) {
        if (content instanceof String) {
          docSize += Math.min(((String) content).length(), maxFieldValueChars);
        }
      }
      docSize = Math.min(docSize, maxTotalChars);
    }
    return docSize;
  }

