  @Test
  public void testClosesConnectionWhenExceptionThrownOnSetAutocommit() throws Exception {
    MockInitialContextFactory.bind("java:comp/env/jdbc/JndiDB", dataSource);

    props.put(JdbcDataSource.JNDI_NAME, "java:comp/env/jdbc/JndiDB");

    SQLException sqlException = new SQLException("fake");
    when(dataSource.getConnection()).thenReturn(connection);
    doThrow(sqlException).when(connection).setAutoCommit(false);

    DataImportHandlerException ex = expectThrows(DataImportHandlerException.class,
        () -> jdbcDataSource.createConnectionFactory(context, props).call());
    assertSame(sqlException, ex.getCause());

    verify(dataSource).getConnection();
    verify(connection).setAutoCommit(false);
    verify(connection).close();
  }

