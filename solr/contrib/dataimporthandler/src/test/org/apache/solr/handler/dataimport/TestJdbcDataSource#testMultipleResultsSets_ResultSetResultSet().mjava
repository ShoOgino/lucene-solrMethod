  @Test
  public void testMultipleResultsSets_ResultSetResultSet() throws Exception {
    MockInitialContextFactory.bind("java:comp/env/jdbc/JndiDB", dataSource);
    props.put(JdbcDataSource.JNDI_NAME, "java:comp/env/jdbc/JndiDB");
    when(dataSource.getConnection()).thenReturn(connection);
    jdbcDataSource.init(context, props);
    connection.setAutoCommit(false);

    Statement statement = mock(Statement.class);
    when(connection.createStatement(ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY))
        .thenReturn(statement);
    when(statement.execute("query")).thenReturn(true);
    ResultSet resultSet1 = mock(ResultSet.class);
    ResultSet resultSet2 = mock(ResultSet.class);
    when(statement.getResultSet()).thenReturn(resultSet1).thenReturn(resultSet2).thenReturn(null);
    when(statement.getMoreResults()).thenReturn(true).thenReturn(false);
    ResultSetMetaData metaData1 = mock(ResultSetMetaData.class);
    when(resultSet1.getMetaData()).thenReturn(metaData1);
    when(metaData1.getColumnCount()).thenReturn(0);
    when(resultSet1.next()).thenReturn(false);
    ResultSetMetaData metaData2 = mock(ResultSetMetaData.class);
    when(resultSet2.getMetaData()).thenReturn(metaData2);
    when(metaData2.getColumnCount()).thenReturn(0);
    when(resultSet2.next()).thenReturn(true).thenReturn(false);
    when(statement.getUpdateCount()).thenReturn(-1);

    final ResultSetIterator resultSetIterator = jdbcDataSource.new ResultSetIterator("query");
    assertSame(resultSet1, resultSetIterator.getResultSet());
    assertTrue(resultSetIterator.hasnext());
    assertSame(resultSet2, resultSetIterator.getResultSet());
    assertFalse(resultSetIterator.hasnext());

    verify(dataSource).getConnection();
    verify(connection, times(2)).setAutoCommit(false);
    verify(connection).createStatement(ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);
    verify(statement).setFetchSize(500);
    verify(statement).setMaxRows(0);
    verify(statement).execute("query");
    verify(statement, times(2)).getResultSet();
    verify(resultSet1).getMetaData();
    verify(metaData1).getColumnCount();
    verify(resultSet1).next();
    verify(resultSet1).close();
    verify(resultSet2).getMetaData();
    verify(metaData2).getColumnCount();
    verify(resultSet2, times(2)).next();
    verify(resultSet2).close();
    verify(statement, times(2)).getMoreResults();
    verify(statement).getUpdateCount();
    verify(statement).close();
  }

