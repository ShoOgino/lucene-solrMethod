    protected QueryResponse doQuery() {
      SolrEntityProcessor.this.queryString = context.getResolvedEntityAttribute(QUERY);
      if (SolrEntityProcessor.this.queryString == null) {
        throw new DataImportHandlerException(
            DataImportHandlerException.SEVERE,
            "SolrEntityProcessor: parameter 'query' is required"
        );
      }

      String rowsP = context.getResolvedEntityAttribute(CommonParams.ROWS);
      if (rowsP != null) {
        rows = Integer.parseInt(rowsP);
      }

      String sortParam = context.getResolvedEntityAttribute(CommonParams.SORT);
      
      String fqAsString = context.getResolvedEntityAttribute(CommonParams.FQ);
      if (fqAsString != null) {
        SolrEntityProcessor.this.filterQueries = fqAsString.split(",");
      }

      String fieldsAsString = context.getResolvedEntityAttribute(CommonParams.FL);
      if (fieldsAsString != null) {
        SolrEntityProcessor.this.fields = fieldsAsString.split(",");
      }
      SolrEntityProcessor.this.requestHandler = context.getResolvedEntityAttribute(CommonParams.QT);
     

      SolrQuery solrQuery = new SolrQuery(queryString);
      solrQuery.setRows(rows);
      
      if (sortParam!=null) {
        solrQuery.setParam(CommonParams.SORT, sortParam);
      }
      
      passNextPage(solrQuery);
      
      if (fields != null) {
        for (String field : fields) {
          solrQuery.addField(field);
        }
      }
      solrQuery.setRequestHandler(requestHandler);
      solrQuery.setFilterQueries(filterQueries);
      
      
      QueryResponse response = null;
      try {
        response = solrClient.query(solrQuery);
      } catch (SolrServerException | IOException | SolrException e) {
        if (ABORT.equals(onError)) {
          wrapAndThrow(SEVERE, e);
        } else if (SKIP.equals(onError)) {
          wrapAndThrow(DataImportHandlerException.SKIP_ROW, e);
        }
      }
      
      if (response != null) {
        SolrEntityProcessor.this.rowIterator = createNextPageIterator(response);
      }
      return response;
    }

