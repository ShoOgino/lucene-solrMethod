  private int findAvailablePort(int min, int max) {
    for (int port = min; port < max; port++) {
      try {
        new ServerSocket(port).close();
        return port;
      } catch (IOException e) {
        // Port is in use
      }
    }
    throw new IllegalStateException("Could not find available port in range " + min + " to " + max);
  }  

