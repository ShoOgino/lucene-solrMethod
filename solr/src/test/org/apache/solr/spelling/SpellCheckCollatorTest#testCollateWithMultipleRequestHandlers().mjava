	@Test
	public void testCollateWithMultipleRequestHandlers() throws Exception
	{
		SolrCore core = h.getCore();
		SearchComponent speller = core.getSearchComponent("spellcheck");
		assertTrue("speller is null and it shouldn't be", speller != null);
		
		ModifiableSolrParams params = new ModifiableSolrParams();		
		params.add(SpellCheckComponent.COMPONENT_NAME, "true");
		params.add(SpellCheckComponent.SPELLCHECK_DICT, "multipleFields");
		params.add(SpellCheckComponent.SPELLCHECK_BUILD, "true");
		params.add(SpellCheckComponent.SPELLCHECK_COUNT, "10");		
		params.add(SpellCheckComponent.SPELLCHECK_COLLATE, "true");
		params.add(SpellCheckComponent.SPELLCHECK_MAX_COLLATION_TRIES, "1");
		params.add(SpellCheckComponent.SPELLCHECK_MAX_COLLATIONS, "1");
		params.add(CommonParams.Q, "peac");	
		
		//SpellCheckCompRH has no "qf" defined.  It will not find "peace" from "peac" despite it being in the dictionary
		//because requrying against this Request Handler results in 0 hits.	
		SolrRequestHandler handler = core.getRequestHandler("spellCheckCompRH");
		SolrQueryResponse rsp = new SolrQueryResponse();
		rsp.add("responseHeader", new SimpleOrderedMap());
		SolrQueryRequest req = new LocalSolrQueryRequest(core, params);
		handler.handleRequest(req, rsp);
		req.close();
		NamedList values = rsp.getValues();
		NamedList spellCheck = (NamedList) values.get("spellcheck");
		NamedList suggestions = (NamedList) spellCheck.get("suggestions");
		String singleCollation = (String) suggestions.get("collation");
		assertNull(singleCollation);
		
		//SpellCheckCompRH1 has "lowerfilt1" defined in the "qf" param.  It will find "peace" from "peac" because
		//requrying field "lowerfilt1" returns the hit.
		params.remove(SpellCheckComponent.SPELLCHECK_BUILD);
		handler = core.getRequestHandler("spellCheckCompRH1");
		rsp = new SolrQueryResponse();
		rsp.add("responseHeader", new SimpleOrderedMap());
		req = new LocalSolrQueryRequest(core, params);
		handler.handleRequest(req, rsp);
		req.close();
		values = rsp.getValues();
		spellCheck = (NamedList) values.get("spellcheck");
		suggestions = (NamedList) spellCheck.get("suggestions");
		singleCollation = (String) suggestions.get("collation");
		assertEquals(singleCollation, "peace");		
	}

