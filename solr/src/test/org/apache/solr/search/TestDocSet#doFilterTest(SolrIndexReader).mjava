  public void doFilterTest(SolrIndexReader reader) throws IOException {
    ReaderContext topLevelContext = reader.getTopReaderContext();
    OpenBitSet bs = getRandomSet(reader.maxDoc(), rand.nextInt(reader.maxDoc()+1));
    DocSet a = new BitDocSet(bs);
    DocSet b = getIntDocSet(bs);

    Filter fa = a.getTopFilter();
    Filter fb = b.getTopFilter();

    // test top-level
    DocIdSet da = fa.getDocIdSet(topLevelContext);
    DocIdSet db = fb.getDocIdSet(topLevelContext);
    doTestIteratorEqual(da, db);

    // first test in-sequence sub readers
    for (ReaderContext readerInfo : topLevelContext.leaves()) {
      da = fa.getDocIdSet(readerInfo);
      db = fb.getDocIdSet(readerInfo);
      doTestIteratorEqual(da, db);
    }  

    int nReaders = topLevelContext.leaves().length;
    // now test out-of-sequence sub readers
    for (int i=0; i<nReaders; i++) {
      ReaderContext readerInfo = topLevelContext.leaves()[rand.nextInt(nReaders)];
      da = fa.getDocIdSet(readerInfo);
      db = fb.getDocIdSet(readerInfo);
      doTestIteratorEqual(da, db);
    }
  }

