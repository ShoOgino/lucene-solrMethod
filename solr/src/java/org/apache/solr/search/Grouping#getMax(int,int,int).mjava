  static int getMax(int offset, int len, int max) {
    int v = len<0 ? max : offset + len;
    if (v < 0 || v > max) v = max;
    return v;
  }

