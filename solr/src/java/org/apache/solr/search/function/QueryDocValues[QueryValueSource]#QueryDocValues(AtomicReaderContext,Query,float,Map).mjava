  public QueryDocValues(AtomicReaderContext readerContext, Query q, float defVal, Map fcontext) throws IOException {
    IndexReader reader = readerContext.reader;
    this.readerContext = readerContext;
    this.q = q;
    this.defVal = defVal;
    this.fcontext = fcontext;

    Weight w = fcontext==null ? null : (Weight)fcontext.get(q);
    // TODO: sort by function doesn't weight (SOLR-1297 is open because of this bug)... so weightSearcher will currently be null
    if (w == null) {
      IndexSearcher weightSearcher;
      if(fcontext == null) {
        weightSearcher = new IndexSearcher(ReaderUtil.getTopLevelContext(readerContext));
      } else {
        weightSearcher = (IndexSearcher)fcontext.get("searcher");
        if (weightSearcher == null) {
          weightSearcher = new IndexSearcher(ReaderUtil.getTopLevelContext(readerContext));
        }
      }
      w = q.weight(weightSearcher);
    }
    weight = w;
  }

