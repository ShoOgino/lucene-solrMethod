  @Override
  public void writeDoc(String name, Document doc, Set<String> returnFields, float score, boolean includeScore) throws IOException {
    pass++;

    for (Fieldable field: doc.getFields()) {
      CSVField csvField = csvFields.get(field.name());
      if (csvField == null) continue;
      if (csvField.tmp != pass) {
        csvField.tmp = pass;
        csvField.values.clear();
      }
      csvField.values.add(field);
    }

    for (CSVField csvField : csvFields.values()) {
      if (csvField.name.equals("score")) {
        writeFloat("score", score);
        continue;
      }
      if (csvField.tmp != pass) {
        writeNull(csvField.name);
        continue;
      }

      if (csvField.sf.multiValued() || csvField.values.size() > 1) {
        mvWriter.reset();
        csvField.mvPrinter.reset();
        // switch the printer to use the multi-valued one
        CSVPrinter tmp = printer;
        printer = csvField.mvPrinter;
        for (Fieldable fval : csvField.values) {
          csvField.sf.getType().write(this, csvField.name, fval);
        }
        printer = tmp;  // restore the original printer

        mvWriter.freeze();
        printer.print(mvWriter.getFrozenBuf(), 0, mvWriter.getFrozenSize(), true);
      } else {
        assert csvField.values.size() == 1;
        csvField.sf.getType().write(this,csvField.name,csvField.values.get(0));
      }
    }

    printer.println();
  }

