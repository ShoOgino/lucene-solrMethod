  /**
   * Analyzes the given text using the given analyzer and returns the produced tokens.
   *
   * @param query    The query to analyze.
   * @param analyzer The analyzer to use.
   */
  protected Set<BytesRef> getQueryTokenSet(String query, Analyzer analyzer) {
    final Set<BytesRef> tokens = new HashSet<BytesRef>();
    final TokenStream tokenStream = analyzer.tokenStream("", new StringReader(query));
    final TermToBytesRefAttribute bytesAtt = tokenStream.getAttribute(TermToBytesRefAttribute.class);
    try {
      tokenStream.reset();
      while (tokenStream.incrementToken()) {
        final BytesRef bytes = new BytesRef();
        bytesAtt.toBytesRef(bytes);
        tokens.add(bytes);
      }
    } catch (IOException ioe) {
      throw new RuntimeException("Error occured while iterating over tokenstream", ioe);
    }
    return tokens;
  }

