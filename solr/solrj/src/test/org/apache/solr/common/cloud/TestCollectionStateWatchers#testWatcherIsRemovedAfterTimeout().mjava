  @Test
  public void testWatcherIsRemovedAfterTimeout() {
    CloudSolrClient client = cluster.getSolrClient();
    assertTrue("There should be no watchers for a non-existent collection!",
        client.getZkStateReader().getStateWatchers("no-such-collection") == null);

    expectThrows(TimeoutException.class, () -> {
      client.waitForState("no-such-collection", 10, TimeUnit.MILLISECONDS, (n, c) -> DocCollection.isFullyActive(n, c, 1, 1));
    });

    Set<CollectionStateWatcher> watchers = client.getZkStateReader().getStateWatchers("no-such-collection");
    assertTrue("Watchers for collection should be removed after timeout",
        watchers == null || watchers.size() == 0);

  }

