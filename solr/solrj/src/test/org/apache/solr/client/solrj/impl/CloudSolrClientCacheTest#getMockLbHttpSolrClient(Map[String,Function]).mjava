  private LBHttpSolrClient getMockLbHttpSolrClient(Map<String, Function> responses) throws Exception {
    LBHttpSolrClient mockLbclient = EasyMock.createMock(LBHttpSolrClient.class);
    EasyMock.reset(mockLbclient);

    mockLbclient.request(EasyMock.anyObject(LBHttpSolrClient.Req.class));
    EasyMock.expectLastCall().andAnswer(() -> {
      LBHttpSolrClient.Req req = (LBHttpSolrClient.Req) EasyMock.getCurrentArguments()[0];
      Function f = responses.get("request");
      if (f == null) return null;
      Object res = f.apply(null);
      if (res instanceof Exception) throw (Throwable) res;
      LBHttpSolrClient.Rsp rsp = new LBHttpSolrClient.Rsp();
      rsp.rsp = (NamedList<Object>) res;
      rsp.server = req.servers.get(0);
      return rsp;
    }).anyTimes();

    mockLbclient.getHttpClient();
    EasyMock.expectLastCall().andAnswer(() -> null).anyTimes();

    EasyMock.replay(mockLbclient);
    return mockLbclient;
  }

