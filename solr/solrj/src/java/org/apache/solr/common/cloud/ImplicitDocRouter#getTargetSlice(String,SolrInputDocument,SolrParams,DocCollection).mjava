  @Override
  public Slice getTargetSlice(String id, SolrInputDocument sdoc, SolrParams params, DocCollection collection) {
    String shard = null;
    if (sdoc != null) {
      String f = collection.getStr(ROUTE_FIELD);
      if(f !=null) {
        Object o = sdoc.getFieldValue(f);
        if (o != null) shard = o.toString();
        else throw new SolrException(SolrException.ErrorCode.BAD_REQUEST, "No value for field "+f +" in " + sdoc);
      }
      if(shard == null) {
        Object o = sdoc.getFieldValue(_ROUTE_);
        if (o == null) o = sdoc.getFieldValue("_shard_");//deprecated . for backcompat remove later
        if (o != null) {
          shard = o.toString();
        }
      }
    }

    if (shard == null) {
      shard = params.get(_ROUTE_);
      if(shard == null) shard =params.get("_shard_"); //deperecated for back compat
    }

    if (shard != null) {

      Slice slice = collection.getSlice(shard);
      if (slice == null) {
        throw new SolrException(SolrException.ErrorCode.BAD_REQUEST, "No shard called =" + shard + " in " + collection);
      }
      return slice;
    }

    return null;  // no shard specified... use default.
  }

