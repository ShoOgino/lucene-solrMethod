  /**
   * Wrap the response's output stream with a close shield, as if by a {@link CloseShieldOutputStream}. If this is a
   * retry, we will assume that the stream has already been wrapped and do nothing.
   *
   * @param response The response to wrap.
   * @param retry If this response corresponds to an original request or a retry.
   * @return A response object with an {@link OutputStream} that will ignore calls to close.
   */
  private ServletResponse closeShield(ServletResponse response, boolean retry) {
    if (testMode && !retry) {
      return new HttpServletResponseWrapper((HttpServletResponse) response) {
        ServletOutputStream stream;
        
        @Override
        public ServletOutputStream getOutputStream() throws IOException {
          // Lazy stream creation
          if (stream == null) {
            stream = new ServletOutputStreamWrapper(super.getOutputStream()) {
              @Override
              public void close() {
                assert false : "Attempted close of response output stream.";
              }
            };
          }
          return stream;
        }
      };
    } else {
      return response;
    }
  }

