    @Override
    public SolrParams parseParamsAndFillStreams( 
        final HttpServletRequest req, ArrayList<ContentStream> streams ) throws Exception
    {
      if( !ServletFileUpload.isMultipartContent(req) ) {
        throw new SolrException( ErrorCode.BAD_REQUEST, "Not multipart content! "+req.getContentType() );
      }
      
      MultiMapSolrParams params = parseQueryString( req.getQueryString() );
      
      // Create a factory for disk-based file items
      DiskFileItemFactory factory = new DiskFileItemFactory();

      // Set factory constraints
      // TODO - configure factory.setSizeThreshold(yourMaxMemorySize);
      // TODO - configure factory.setRepository(yourTempDirectory);

      // Create a new file upload handler
      ServletFileUpload upload = new ServletFileUpload(factory);
      upload.setSizeMax( ((long) uploadLimitKB) * 1024L );

      // Parse the request
      List<FileItem> items = upload.parseRequest(req);
      for (FileItem item : items) {
        // If it's a form field, put it in our parameter map
        if (item.isFormField()) {
          MultiMapSolrParams.addParam(
            item.getFieldName().trim(),
            item.getString(), params.getMap() );
        }
        // Add the stream
        else {
          streams.add( new FileItemContentStream( item ) );
        }
      }
      return params;
    }

