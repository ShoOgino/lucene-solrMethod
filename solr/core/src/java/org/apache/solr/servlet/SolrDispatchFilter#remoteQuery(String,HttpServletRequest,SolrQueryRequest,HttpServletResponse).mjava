  private void remoteQuery(String coreUrl, HttpServletRequest req,
      SolrQueryRequest solrReq, HttpServletResponse resp) throws IOException {
    try {
      String urlstr = coreUrl;
      
      String queryString = req.getQueryString();
      
      urlstr += queryString == null ? "" : "?" + queryString;
      
      URL url = new URL(urlstr);
      HttpURLConnection con = (HttpURLConnection) url.openConnection();
      con.setRequestMethod(req.getMethod());
      con.setUseCaches(false);
      
      con.setDoOutput(true);
      con.setDoInput(true);
      for (Enumeration e = req.getHeaderNames(); e.hasMoreElements();) {
        String headerName = e.nextElement().toString();
        con.setRequestProperty(headerName, req.getHeader(headerName));
      }
      try {
        con.connect();

        InputStream is;
        OutputStream os;
        if ("POST".equals(req.getMethod())) {
          is = req.getInputStream();
          os = con.getOutputStream(); // side effect: method is switched to POST
          try {
            IOUtils.copyLarge(is, os);
          } finally {
            IOUtils.closeQuietly(os);
            IOUtils.closeQuietly(is);  // TODO: I thought we weren't supposed to explicitly close servlet streams
          }
        }
        
        resp.setStatus(con.getResponseCode());
        
        for (Iterator i = con.getHeaderFields().entrySet().iterator(); i
            .hasNext();) {
          Map.Entry mapEntry = (Map.Entry) i.next();
          if (mapEntry.getKey() != null) resp.setHeader(mapEntry.getKey()
              .toString(), ((List) mapEntry.getValue()).get(0).toString());
        }
        
        resp.setCharacterEncoding(con.getContentEncoding());
        resp.setContentType(con.getContentType());
        
        is = con.getInputStream();
        os = resp.getOutputStream();
        try {
          IOUtils.copyLarge(is, os);
        } finally {
          IOUtils.closeQuietly(os);   // TODO: I thought we weren't supposed to explicitly close servlet streams
          IOUtils.closeQuietly(is);
        }
      } finally {
        con.disconnect();
      }
    } catch (IOException e) {
      sendError(null, solrReq, req, resp, new SolrException(
          SolrException.ErrorCode.SERVER_ERROR,
          "Error trying to proxy request for url: " + coreUrl, e));
    }
    
  }

