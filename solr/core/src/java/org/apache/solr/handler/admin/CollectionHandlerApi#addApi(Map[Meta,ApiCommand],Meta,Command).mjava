  private static void addApi(Map<Meta, ApiCommand> mapping, Meta metaInfo, Command fun) {
    mapping.put(metaInfo, new ApiCommand() {

      @Override
      public CommandMeta meta() {
        return metaInfo;
      }

      @Override
      public void invoke(SolrQueryRequest req, SolrQueryResponse rsp, BaseHandlerApiSupport apiHandler) throws Exception {
        CommandOperation op = null;
        if (metaInfo.method == SolrRequest.METHOD.POST) {
          List<CommandOperation> commands = req.getCommands(true);
          if (commands == null || commands.size() != 1)
            throw new SolrException(ErrorCode.BAD_REQUEST, "should have exactly one command");
          op = commands.get(0);
        }

        fun.call(new ApiInfo(req, rsp, apiHandler, op));
        if (op != null && op.hasError()) {
          throw new ApiBag.ExceptionWithErrObject(ErrorCode.BAD_REQUEST, "error processing commands", captureErrors(singletonList(op)));
        }
      }
    });
  }

