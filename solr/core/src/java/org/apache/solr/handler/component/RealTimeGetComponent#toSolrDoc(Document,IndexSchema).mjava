  private static SolrDocument toSolrDoc(Document doc, IndexSchema schema) {
    SolrDocument out = new SolrDocument();
    for( IndexableField f : doc.getFields() ) {
      // Make sure multivalued fields are represented as lists

      SchemaField sf = schema.getFieldOrNull(f.name());
      if (sf == null) {
        // This is unexpected!
        log.warn("schema.getFieldOrNull returned null {}, this is unexpected! ", f.name());
        out.setField(f.name(), f.stringValue());
        continue;
      }

      // don't return copyField targets
      if (schema.isCopyFieldTarget(sf)) continue;
      
      if (out.get(f.name()) != null) {
        out.addField(f.name(), sf.getType().toObject(f));
        continue;
      }

      if (sf.multiValued()) {
        List<Object> vals = new ArrayList<>();
        vals.add(sf.getType().toObject(f));
        out.setField(f.name(), vals);
      } else {
        out.setField(f.name(), sf.getType().toObject(f));
      }
    }
    return out;
  }

