  /** this must be MT safe... may be called concurrently from multiple threads. */
  void doAdd(int line, String[] vals, SolrInputDocument doc, AddUpdateCommand template) throws IOException {
    // the line number is passed for error reporting in MT mode as well as for optional rowId.
    // first, create the lucene document
    for (int i=0; i<vals.length; i++) {
      if (fields[i]==null) continue;  // ignore this field
      String val = vals[i];
      adders[i].add(doc, line, i, val);
    }

    // add any literals
    for (SchemaField sf : literals.keySet()) {
      String fn = sf.getName();
      String val = literals.get(sf);
      doc.addField(fn, val);
    }
    if (rowId != null){
      doc.addField(rowId, line);
    }
    template.solrDoc = doc;
    processor.processAdd(template);
  }

