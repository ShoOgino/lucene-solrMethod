  CdcrBufferStateManager(final SolrCore core, SolrParams bufferConfiguration) {
    this.core = core;

    // Ensure that the state znode exists
    this.createStateNode();

    // set default state
    if (bufferConfiguration != null) {
      byte[] defaultState = bufferConfiguration.get(
          CdcrParams.DEFAULT_STATE_PARAM, DEFAULT_STATE.toLower()).getBytes(Charset.forName("UTF-8"));
      state = CdcrParams.BufferState.get(defaultState);
    }
    this.setState(state); // notify observers

    // Startup and register the watcher at startup
    try {
      SolrZkClient zkClient = core.getCoreDescriptor().getCoreContainer().getZkController().getZkClient();
      watcher = this.initWatcher(zkClient);
      this.setState(CdcrParams.BufferState.get(zkClient.getData(this.getZnodePath(), watcher, null, true)));
    } catch (KeeperException | InterruptedException e) {
      log.warn("Failed fetching initial state", e);
    }
  }

