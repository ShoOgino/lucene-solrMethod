    private AggregateMetric getOrRegister(MetricRegistry registry, String name, AggregateMetric add) {
      AggregateMetric existing = (AggregateMetric)registry.getMetrics().get(name);
      if (existing != null) {
        return existing;
      }
      try {
        registry.register(name, add);
        return add;
      } catch (IllegalArgumentException e) {
        // someone added before us
        existing = (AggregateMetric)registry.getMetrics().get(name);
        if (existing == null) { // now, that is weird...
          throw new IllegalArgumentException("Inconsistent metric status, " + name);
        }
        return existing;
      }
    }

