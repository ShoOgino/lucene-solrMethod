  @Override
  public void writeMap(MapWriter val)
      throws IOException {
    writeMapOpener(-1);
    incLevel();

    val.writeMap(new MapWriter.EntryWriter() {
      boolean isFirst = true;

      @Override
      public MapWriter.EntryWriter put(String k, Object v) throws IOException {
        if (isFirst) {
          isFirst = false;
        } else {
          JSONWriter.this.writeMapSeparator();
        }
        if (doIndent) JSONWriter.this.indent();
        JSONWriter.this.writeKey(k, true);
        JSONWriter.this.writeVal(k, v);
        return this;
      }
    });
    decLevel();
    writeMapCloser();
  }

