  // IndexWriterCloser interface method - called from solrCoreState.decref(this)
  @Override
  public void closeWriter(IndexWriter writer) throws IOException {
    commitLock.lock();
    try {
      if (!commitOnClose) {
        if (writer != null) {
          writer.rollback();
        }

        // we shouldn't close the transaction logs either, but leaving them open
        // means we can't delete them on windows.
        if (ulog != null) ulog.close(false);

        return;
      }

      // if we are later going to mark everything in the tlog as committed, then we
      // need to block all updates from coming in so we can be sure that the close
      // will contain all of the updates.

      VersionInfo vinfo = ulog == null ? null : ulog.getVersionInfo();
      if (vinfo != null) {
        // TODO: move the RW update lock somewhere else?
        vinfo.blockUpdates();
      }
      try {

        boolean succeeded = false;
        try {
          if (writer != null) {
            writer.close();
          }
          succeeded = true;
        } finally {
          if (ulog != null) ulog.close(succeeded);
        }

      } finally {
        if (vinfo != null) {
          vinfo.unblockUpdates();
        }
      }

    } finally {
      commitLock.unlock();
    }
  }

