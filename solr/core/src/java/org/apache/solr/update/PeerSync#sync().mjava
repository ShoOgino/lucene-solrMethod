  /** Returns true if peer sync was successful, meaning that this core may not be considered to have the latest updates.
   *  A commit is not performed.
   */
  public boolean sync() {
    if (ulog == null) {
      return false;
    }

    // fire off the requests before getting our own recent updates (for better concurrency)
    for (String replica : replicas) {
      requestVersions(replica);
    }

    recentUpdates = ulog.getRecentUpdates();
    try {
      ourUpdates = recentUpdates.getVersions(nUpdates);
    } finally {
      recentUpdates.close();
    }
    
    
    Collections.sort(ourUpdates, absComparator);

    if (ourUpdates.size() > 0) {
      ourLowThreshold = percentile(ourUpdates, 0.8f);
      ourHighThreshold = percentile(ourUpdates, 0.2f);
    }  else {
      // we have no versions and hence no frame of reference to tell if we can use a peers
      // updates to bring us into sync
      return false;
    }

    ourUpdateSet = new HashSet<Long>(ourUpdates);
    requestedUpdateSet = new HashSet<Long>(ourUpdates);

    for(;;) {
      ShardResponse srsp = shardHandler.takeCompletedOrError();
      if (srsp == null) break;
      boolean success = handleResponse(srsp);
      if (!success) {
        shardHandler.cancelAll();
        return false;
      }
    }

    return true;
  }

