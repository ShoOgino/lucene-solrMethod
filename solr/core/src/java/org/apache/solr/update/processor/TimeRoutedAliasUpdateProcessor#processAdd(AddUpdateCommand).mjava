  @Override
  public void processAdd(AddUpdateCommand cmd) throws IOException {
    final Instant docTimestamp =
        parseRouteKey(cmd.getSolrInputDocument().getFieldValue(timeRoutedAlias.getRouteField()));

    // TODO: maybe in some cases the user would want to ignore/warn instead?
    if (docTimestamp.isAfter(Instant.now().plusMillis(timeRoutedAlias.getMaxFutureMs()))) {
      throw new SolrException(SolrException.ErrorCode.BAD_REQUEST,
          "The document's time routed key of " + docTimestamp + " is too far in the future given " +
              TimeRoutedAlias.ROUTER_MAX_FUTURE + "=" + timeRoutedAlias.getMaxFutureMs());
    }

    // to avoid potential for race conditions, this next method should not get called again unless
    // we have created a collection synchronously
    updateParsedCollectionAliases();

    String targetCollection = createCollectionsIfRequired(docTimestamp, cmd);

    if (thisCollection.equals(targetCollection)) {
      // pass on through; we've reached the right collection
      super.processAdd(cmd);
    } else {
      // send to the right collection
      SolrCmdDistributor.Node targetLeaderNode = routeDocToSlice(targetCollection, cmd.getSolrInputDocument());
      cmdDistrib.distribAdd(cmd, Collections.singletonList(targetLeaderNode), new ModifiableSolrParams(outParamsToLeader));
    }
  }

