  @Override
  public void initializeMetrics(SolrMetricManager manager, String registry, String scope) {
    bufferedOpsGauge = () -> {
      if (tlog == null) {
        return 0;
      } else if (state == State.APPLYING_BUFFERED) {
        // numRecords counts header as a record
        return tlog.numRecords() - 1 - recoveryInfo.adds - recoveryInfo.deleteByQuery - recoveryInfo.deletes - recoveryInfo.errors;
      } else if (state == State.BUFFERING) {
        // numRecords counts header as a record
        return tlog.numRecords() - 1;
      } else {
        return 0;
      }
    };
    replayLogsCountGauge = () -> logs.size();
    replayBytesGauge = () -> getTotalLogsSize();

    manager.register(registry, bufferedOpsGauge, true, "ops", scope, "buffered");
    manager.register(registry, replayLogsCountGauge, true, "logs", scope, "replay", "remaining");
    manager.register(registry, replayBytesGauge, true, "bytes", scope, "replay", "remaining");
    applyingBufferedOpsMeter = manager.meter(registry, "ops", scope, "applyingBuffered");
    replayOpsMeter = manager.meter(registry, "ops", scope, "replay");
    stateGauge = () -> state.getValue();
    manager.register(registry, stateGauge, true, "state", scope);
  }

