  /** Add a document execute the deletes as atomically as possible */
  private void addAndDelete(AddUpdateCommand cmd, List<Query> dbqList) throws IOException {
    Document luceneDocument = cmd.getLuceneDocument();
    Term idTerm = new Term(idField.getName(), cmd.getIndexedId());

    // see comment in deleteByQuery
    synchronized (this) {
      IndexWriter writer = solrCoreState.getIndexWriter(core);

      writer.updateDocument(idTerm, luceneDocument);

      for (Query q : dbqList) {
        writer.deleteDocuments(q);
      }

      if (ulog != null) ulog.add(cmd, true);
    }

  }

