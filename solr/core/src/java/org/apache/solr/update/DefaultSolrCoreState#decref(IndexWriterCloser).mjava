  @Override
  public  void decref(IndexWriterCloser closer) {
    synchronized (this) {
      refCnt--;
      if (refCnt == 0) {
        try {
          if (closer != null) {
            closer.closeWriter(indexWriter);
          } else if (indexWriter != null) {
            indexWriter.close();
          }
        } catch (Throwable t) {          
          log.error("Error during shutdown of writer.", t);
        }
        try {
          directoryFactory.close();
        } catch (Throwable t) {
          log.error("Error during shutdown of directory factory.", t);
        }
        
        // TODO: we cannot cancel recovery here if its a CoreContainer shutdown
        // it can cause deadlock - but perhaps we want to if we are stopping early
        // and CoreContainer is not being shutdown?

        closed = true;
      }
    }
  }

