  // Irrepressably ugly bit of the transition in SOLR-4196, but there as at least one test case that follows
  // this path, presumably it's there for a reason.
  // This is really perverse, but all we need the here is to call a couple of static methods that for back-compat
  // purposes
  public void persistCores(ConfigSolr cfg, Properties containerProperties, Map<String, String> rootSolrAttribs,
                           Map<String, String> coresAttribs, File file, File configFile, SolrResourceLoader loader) {
    // This is expensive in the maximal case, but I think necessary. It should keep a reference open to all of the
    // current cores while they are saved. Remember that especially the transient core can come and go.
    //
    // TODO: 5.0. remove the possibility of storing core descirptors in solr.xml?
    //
    synchronized (locker) {
      if (cfg == null) {
        ConfigSolrXml.initPersistStatic();
        persistCores(cfg, cores, loader);
        persistCores(cfg, transientCores, loader);
        // add back all the cores that aren't loaded, either in cores or transient cores
        for (Map.Entry<String, CoreDescriptor> ent : dynamicDescriptors.entrySet()) {
          if (! cores.containsKey(ent.getKey()) && ! transientCores.containsKey(ent.getKey())) {
            addPersistOneCore(cfg, loader, ent.getValue(), null);
          }
        }
        for (Map.Entry<String, SolrCore> ent : createdCores.entrySet()) {
          if (! cores.containsKey(ent.getKey()) && ! transientCores.containsKey(ent.getKey())
              && ! dynamicDescriptors.containsKey(ent.getKey())) {
            addPersistOneCore(cfg, loader, ent.getValue().getCoreDescriptor(), null);
          }
        }
        ConfigSolrXml.addPersistAllCoresStatic(containerProperties, rootSolrAttribs, coresAttribs,
            (file == null ? configFile : file));
      } else {
        cfg.initPersist();
        persistCores(cfg, cores, loader);
        persistCores(cfg, transientCores, loader);
        // add back all the cores that aren't loaded, either in cores or transient cores
        for (Map.Entry<String, CoreDescriptor> ent : dynamicDescriptors.entrySet()) {
          if (! cores.containsKey(ent.getKey()) && ! transientCores.containsKey(ent.getKey())) {
            addPersistOneCore(cfg, loader, ent.getValue(), null);
          }
        }
        for (Map.Entry<String, SolrCore> ent : createdCores.entrySet()) {
          if (! cores.containsKey(ent.getKey()) && ! transientCores.containsKey(ent.getKey())
              && ! dynamicDescriptors.containsKey(ent.getKey())) {
            addPersistOneCore(cfg, loader, ent.getValue().getCoreDescriptor(), null);
          }
        }
        cfg.addPersistAllCores(containerProperties, rootSolrAttribs, coresAttribs, (file == null ? configFile : file));
      }
    }
  }

