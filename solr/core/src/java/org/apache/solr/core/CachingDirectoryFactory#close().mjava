  /*
   * (non-Javadoc)
   * 
   * @see org.apache.solr.core.DirectoryFactory#close()
   */
  @Override
  public void close() throws IOException {
    synchronized (this) {
      this.closed = true;
      Collection<CacheValue> values = new ArrayList<CacheValue>();
      values.addAll(byDirectoryCache.values());
      for (CacheValue val : values) {
        try {
          // if there are still refs out, we have to wait for them
          int cnt = 0;
          while(val.refCnt != 0) {
            wait(100);
            
            if (cnt++ >= 1200) {
              log.error("Timeout waiting for all directory ref counts to be released");
              break;
            }
          }
          assert val.refCnt == 0 : val.refCnt;
        } catch (Throwable t) {
          SolrException.log(log, "Error closing directory", t);
        }
      }
      
      values = byDirectoryCache.values();
      for (CacheValue val : values) {
        try {
          assert val.refCnt == 0 : val.refCnt;
          log.info("Closing directory when closing factory: " + val.path);
          closeDirectory(val);
        } catch (Throwable t) {
          SolrException.log(log, "Error closing directory", t);
        }
      }
      
      byDirectoryCache.clear();
      byPathCache.clear();
      
      for (CacheValue val : removeEntries) {
        log.info("Removing directory: " + val.path);
        removeDirectory(val);
      }
    }
  }

