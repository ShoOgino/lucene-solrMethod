  /**
   * This method deletes all files not corresponding to a configured snapshot in the specified index directory.
   *
   * @param dir The index directory to search for.
   * @throws IOException in case of I/O errors.
   */
  public static void deleteNonSnapshotIndexFiles (Directory dir, Collection<SnapshotMetaData> snapshots) throws IOException {
    List<IndexCommit> commits = DirectoryReader.listCommits(dir);
    Map<String, Integer> refCounts = buildRefCounts(snapshots, commits);
    Set<Long> snapshotGenNumbers = snapshots.stream()
                                            .map(SnapshotMetaData::getGenerationNumber)
                                            .collect(Collectors.toSet());
    for (IndexCommit ic : commits) {
      if (!snapshotGenNumbers.contains(ic.getGeneration())) {
        deleteIndexFiles(dir,refCounts, ic);
      }
    }
  }

