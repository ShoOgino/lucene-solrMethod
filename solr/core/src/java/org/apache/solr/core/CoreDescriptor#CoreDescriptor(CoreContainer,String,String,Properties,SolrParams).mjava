  /**
   * Create a new CoreDescriptor.
   * @param container       the CoreDescriptor's container
   * @param name            the CoreDescriptor's name
   * @param instanceDir     a String containing the instanceDir
   * @param coreProps       a Properties object of the properties for this core
   * @param params          additional params
   */
  public CoreDescriptor(CoreContainer container, String name, String instanceDir,
                        Properties coreProps, SolrParams params) {

    this.coreContainer = container;

    originalCoreProperties.setProperty(CORE_NAME, name);
    originalCoreProperties.setProperty(CORE_INSTDIR, instanceDir);

    Properties containerProperties = container.getContainerProperties();
    name = PropertiesUtil.substituteProperty(checkPropertyIsNotEmpty(name, CORE_NAME),
                                             containerProperties);
    instanceDir = PropertiesUtil.substituteProperty(checkPropertyIsNotEmpty(instanceDir, CORE_INSTDIR),
                                                    containerProperties);

    coreProperties.putAll(defaultProperties);
    coreProperties.put(CORE_NAME, name);
    coreProperties.put(CORE_INSTDIR, instanceDir);
    coreProperties.put(CORE_ABS_INSTDIR, convertToAbsolute(instanceDir, container.getCoreRootDirectory()));

    for (String propname : coreProps.stringPropertyNames()) {

      String propvalue = coreProps.getProperty(propname);

      if (isUserDefinedProperty(propname))
        originalExtraProperties.put(propname, propvalue);
      else
        originalCoreProperties.put(propname, propvalue);

      if (!requiredProperties.contains(propname))   // Required props are already dealt with
        coreProperties.setProperty(propname,
            PropertiesUtil.substituteProperty(propvalue, containerProperties));
    }

    loadExtraProperties();
    buildSubstitutableProperties();

    // TODO maybe make this a CloudCoreDescriptor subclass?
    if (container.isZooKeeperAware()) {
      cloudDesc = new CloudDescriptor(name, coreProperties, this);
      if (params != null) {
        cloudDesc.setParams(params);
      }
    }
    else {
      cloudDesc = null;
    }

    SolrCore.log.info("CORE DESCRIPTOR: " + coreProperties);
  }

