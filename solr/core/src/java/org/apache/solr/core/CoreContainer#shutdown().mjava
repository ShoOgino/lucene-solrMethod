  /**
   * Stops all cores.
   */
  public void shutdown() {
    log.info("Shutting down CoreContainer instance="+System.identityHashCode(this));    
    synchronized(cores) {
      try {
        for (SolrCore core : cores.values()) {
          try {
             core.close();
             // make sure we wait for any recoveries to stop
             core.getUpdateHandler().getSolrCoreState().cancelRecovery();
          } catch (Throwable t) {
            SolrException.log(log, "Error shutting down core", t);
          }
        }
        cores.clear();
      } finally {
        if(zkController != null) {
          zkController.close();
        }
        if (zkServer != null) {
          zkServer.stop();
        }
        if (shardHandlerFactory != null) {
          shardHandlerFactory.close();
        }
        isShutDown = true;
      }
    }
  }

