  /**
   * Stops all cores.
   */
  public void shutdown() {
    log.info("Shutting down CoreContainer instance="+System.identityHashCode(this));
    isShutDown = true;
    
    if (isZooKeeperAware()) {
      cancelCoreRecoveries();
    }
    
    synchronized(cores) {
      try {
        for (SolrCore core : cores.values()) {
          try {
             core.close();
          } catch (Throwable t) {
            SolrException.log(log, "Error shutting down core", t);
          }
        }
        cores.clear();
      } finally {
        if (shardHandlerFactory != null) {
          shardHandlerFactory.close();
        }
        // we want to close zk stuff last
        if(zkController != null) {
          zkController.close();
        }
        if (zkServer != null) {
          zkServer.stop();
        }
      }
    }
  }

