    private void persistToFile(ByteBuffer data, ByteBuffer meta) throws IOException {
      synchronized (DistribPackageStore.this) {
        this.metaData = meta;
        this.fileData = data;
        Path realpath = getRealpath(path);
        File file = realpath.toFile();
        File parent = file.getParentFile();
        if (!parent.exists()) {
          parent.mkdirs();
        }
        Map m = (Map) Utils.fromJSON(meta.array(), meta.arrayOffset(), meta.limit());
        if (m == null || m.isEmpty()) {
          throw new SolrException(SERVER_ERROR, "invalid metadata , discarding : " + path);
        }


        File metdataFile = getRealpath(getMetaPath()).toFile();

        try (FileOutputStream fos = new FileOutputStream(metdataFile)) {
          fos.write(meta.array(), 0, meta.limit());
        }
        IOUtils.fsync(metdataFile.toPath(), false);

        try (FileOutputStream fos = new FileOutputStream(file)) {
          fos.write(data.array(), 0, data.limit());
        }
        log.info("persisted a file {} and metadata. sizes {} {}", path, data.limit(), meta.limit());
        IOUtils.fsync(file.toPath(), false);
      }
    }

