  public void preRegister(CoreDescriptor cd) throws KeeperException, InterruptedException {
    // before becoming available, make sure we are not live and active
    // this also gets us our assigned shard id if it was not specified
    publish(cd, ZkStateReader.DOWN, false);
    // shardState and shardRange are for one-time use only, thereafter the actual values in the Slice should be used
    cd.getCloudDescriptor().setShardState(null);
    cd.getCloudDescriptor().setShardRange(null);
    String coreNodeName = getCoreNodeName(cd);
    
    // make sure the node name is set on the descriptor
    if (cd.getCloudDescriptor().getCoreNodeName() == null) {
      cd.getCloudDescriptor().setCoreNodeName(coreNodeName);
    }
    
    if (cd.getCloudDescriptor().getShardId() == null && needsToBeAssignedShardId(cd, zkStateReader.getClusterState(), coreNodeName)) {
      String shardId;
      shardId = doGetShardIdProcess(cd.getName(), cd);
      cd.getCloudDescriptor().setShardId(shardId);
    } else {
      // still wait till we see us in local state
      doGetShardIdProcess(cd.getName(), cd);
    }

  }

