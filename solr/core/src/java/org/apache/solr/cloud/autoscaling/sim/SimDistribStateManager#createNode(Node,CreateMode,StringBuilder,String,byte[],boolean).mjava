  private Node createNode(Node parentNode, CreateMode mode, StringBuilder fullChildPath, String baseChildName, byte[] data, boolean attachToParent) throws IOException {
    String nodeName = baseChildName;
    if ((parentNode.mode == CreateMode.EPHEMERAL || parentNode.mode == CreateMode.EPHEMERAL_SEQUENTIAL) &&
        (mode == CreateMode.EPHEMERAL || mode == CreateMode.EPHEMERAL_SEQUENTIAL)) {
      throw new IOException("NoChildrenEphemerals for " + parentNode.path);
    }
    if (CreateMode.PERSISTENT_SEQUENTIAL == mode || CreateMode.EPHEMERAL_SEQUENTIAL == mode) {
      nodeName = nodeName + String.format(Locale.ROOT, "%010d", parentNode.seq);
      parentNode.seq++;
    }

    fullChildPath.append(nodeName);
    String owner = mode == CreateMode.EPHEMERAL || mode == CreateMode.EPHEMERAL_SEQUENTIAL ? id : "0";
    Node child = new Node(parentNode, nodeName, fullChildPath.toString(), data, mode, owner);

    if (attachToParent) {
      parentNode.setChild(nodeName, child);
    }
    return child;
  }

