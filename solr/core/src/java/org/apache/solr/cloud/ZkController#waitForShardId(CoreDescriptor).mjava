  private void waitForShardId(CoreDescriptor cd) throws InterruptedException {
    log.info("waiting to find shard id in clusterstate for " + cd.getName());
    final String thisNode = getNodeName();
    try {
      zkStateReader.waitForState(cd.getCollectionName(), 320, TimeUnit.SECONDS, (n, c) -> {
        if (c == null)
          return false;
        String shardId = c.getShardId(thisNode, cd.getName());
        if (shardId != null) {
          cd.getCloudDescriptor().setShardId(shardId);
          return true;
        }
        return false;
      });
    }
    catch (TimeoutException e) {
      throw new SolrException(ErrorCode.SERVER_ERROR, "Timed out getting shard id for core: " + cd.getName());
    }
  }

