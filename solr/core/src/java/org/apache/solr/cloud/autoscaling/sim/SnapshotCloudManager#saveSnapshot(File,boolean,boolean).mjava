  public void saveSnapshot(File targetDir, boolean withAutoscaling, boolean redact) throws Exception {
    Map<String, Object> snapshot = getSnapshot(withAutoscaling, redact);
    ClusterState clusterState = getClusterStateProvider().getClusterState();
    RedactionUtils.RedactionContext ctx = SimUtils.getRedactionContext(clusterState);
    targetDir.mkdirs();
    for (Map.Entry<String, Object> e : snapshot.entrySet()) {
      FileOutputStream out = new FileOutputStream(new File(targetDir, e.getKey() + ".json"));
      if (redact) {
        String data = Utils.toJSONString(e.getValue());
        data = RedactionUtils.redactNames(ctx.getRedactions(), data);
        IOUtils.write(data.getBytes("UTF-8"), out);
      } else {
        IOUtils.write(Utils.toJSON(e.getValue()), out);
      }
      out.flush();
      out.close();
    }
  }

