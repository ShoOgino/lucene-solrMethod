  @Override
  public boolean onStateChanged(Set<String> liveNodes, DocCollection collectionState) {
    log.debug("-- onStateChanged: " + collectionState);
    if (collectionState == null) { // collection has been deleted - don't wait
      if (countDownLatch != null) {
        for (int i = 0; i < replicaIds.size() + solrCoreNames.size(); i++) {
          countDownLatch.countDown();
        }
      }
      replicaIds.clear();
      solrCoreNames.clear();
      return true;
    }
    for (Slice slice : collectionState.getSlices()) {
      for (Replica replica : slice.getReplicas()) {
        if (replicaIds.contains(replica.getName())) {
          if (replica.isActive(liveNodes)) {
            activeReplicas.add(replica);
            replicaIds.remove(replica.getName());
            if (countDownLatch != null) {
              countDownLatch.countDown();
            }
          }
        } else if (solrCoreNames.contains(replica.getStr(ZkStateReader.CORE_NAME_PROP))) {
          if (replica.isActive(liveNodes)) {
            activeReplicas.add(replica);
            solrCoreNames.remove(replica.getStr(ZkStateReader.CORE_NAME_PROP));
            if (countDownLatch != null) {
              countDownLatch.countDown();
            }
          }
        }
      }
    }
    if (replicaIds.isEmpty() && solrCoreNames.isEmpty()) {
      return true;
    } else {
      return false;
    }
  }

