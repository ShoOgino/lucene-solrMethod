  private AutoScalingConfig handleSetListener(SolrQueryRequest req, SolrQueryResponse rsp, CommandOperation op,
                                 AutoScalingConfig currentConfig) throws KeeperException, InterruptedException {
    String listenerName = op.getStr(NAME);
    String triggerName = op.getStr(TRIGGER);
    List<String> stageNames = op.getStrs(STAGE, Collections.emptyList());
    String listenerClass = op.getStr(CLASS);
    List<String> beforeActions = op.getStrs(BEFORE_ACTION, Collections.emptyList());
    List<String> afterActions = op.getStrs(AFTER_ACTION, Collections.emptyList());

    if (op.hasError()) return currentConfig;

    Map<String, AutoScalingConfig.TriggerConfig> triggers = currentConfig.getTriggerConfigs();
    if (triggers == null || !triggers.containsKey(triggerName)) {
      op.addError("A trigger with the name " + triggerName + " does not exist");
      return currentConfig;
    }
    AutoScalingConfig.TriggerConfig triggerConfig = triggers.get(triggerName);

    if (stageNames.isEmpty() && beforeActions.isEmpty() && afterActions.isEmpty()) {
      op.addError("Either 'stage' or 'beforeAction' or 'afterAction' must be specified");
      return currentConfig;
    }

    for (String stage : stageNames) {
      try {
        TriggerEventProcessorStage.valueOf(stage);
      } catch (IllegalArgumentException e) {
        op.addError("Invalid stage name: " + stage);
      }
    }
    if (op.hasError()) return currentConfig;

    // validate that we can load the listener class
    // todo allow creation from blobstore
    try {
      container.getResourceLoader().findClass(listenerClass, TriggerListener.class);
    } catch (Exception e) {
      log.warn("error loading listener class ", e);
      op.addError("Listener not found: " + listenerClass + ". error message:" + e.getMessage());
      return currentConfig;
    }

    Set<String> actionNames = new HashSet<>();
    actionNames.addAll(beforeActions);
    actionNames.addAll(afterActions);
    for (AutoScalingConfig.ActionConfig action : triggerConfig.actions) {
      actionNames.remove(action.name);
    }
    if (!actionNames.isEmpty()) {
      op.addError("The trigger '" + triggerName + "' does not have actions named: " + actionNames);
      return currentConfig;
    }
    AutoScalingConfig.TriggerListenerConfig listener = new AutoScalingConfig.TriggerListenerConfig(listenerName, op.getValuesExcluding("name"));
    // todo - handle races between competing set-trigger and set-listener invocations
    currentConfig = currentConfig.withTriggerListenerConfig(listener);
    return currentConfig;
  }

