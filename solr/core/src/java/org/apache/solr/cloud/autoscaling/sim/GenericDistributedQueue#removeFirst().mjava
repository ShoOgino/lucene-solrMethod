  private byte[] removeFirst() throws Exception {
    while (true) {
      String firstChild = firstChild(true, false);
      if (firstChild == null) {
        return null;
      }
      try {
        String path = dir + "/" + firstChild;
        VersionedData result = stateManager.getData(path);
        stateManager.removeData(path, -1);
        stats.setQueueLength(knownChildren.size());
        return result.getData();
      } catch (NoSuchElementException e) {
        // Another client deleted the node first, remove the in-memory and retry.
        updateLock.lockInterruptibly();
        try {
          // Efficient only for single-consumer
          knownChildren.clear();
          isDirty = true;
        } finally {
          updateLock.unlock();
        }
      }
    }
  }

