      private ClusterState updateSlice(ClusterState state, String collection, Slice slice) {
        // System.out.println("###!!!### OLD CLUSTERSTATE: " + JSONUtil.toJSON(state.getCollectionStates()));
        // System.out.println("Updating slice:" + slice);

        Map<String, Map<String, Slice>> newCollections = new LinkedHashMap<String,Map<String,Slice>>(state.getCollectionStates());  // make a shallow copy
        Map<String, Slice> slices = newCollections.get(collection);
        if (slices == null) {
          slices = new HashMap<String, Slice>(1);
        } else {
          slices = new LinkedHashMap<String, Slice>(slices); // make a shallow copy
        }
        slices.put(slice.getName(),  slice);
        newCollections.put(collection, slices);

        // System.out.println("###!!!### NEW CLUSTERSTATE: " + JSONUtil.toJSON(newCollections));

        return new ClusterState(state.getLiveNodes(), newCollections);
      }

