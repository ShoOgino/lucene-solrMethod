  public void publishAndWaitForDownStates() throws KeeperException,
      InterruptedException {

    publishNodeAsDown(getNodeName());

    Set<String> collections = cc.getLocalCollections();
    CountDownLatch latch = new CountDownLatch(collections.size());

    for (String collection : collections) {
      zkStateReader.registerCollectionStateWatcher(collection, (nodes, state) -> {
        for (Replica replica : state.getReplicasOnNode(getNodeName())) {
          if (replica.getState() != Replica.State.DOWN)
            return false;
        }
        latch.countDown();
        return true;
      });
    }

    if (latch.await(WAIT_DOWN_STATES_TIMEOUT_SECONDS, TimeUnit.SECONDS) == false) {
      // TODO should we abort here?
      log.warn("Timed out waiting to see all nodes published as DOWN in our cluster state.");
    }

  }

