  @Override
  public void prepare(ResponseBuilder rb) throws IOException {

    if (getChildFacetFields(rb.req) != null) {
      validateQuery(rb.getQuery());
      // we count facets only when searching
      rb.setFieldFlags(rb.getFieldFlags() | SolrIndexSearcher.NO_CHECK_QCACHE);
      if (rb.getFilters() == null) {
        rb.setFilters(new LinkedList<Query>());
      }
      DelegatingCollector blockJoinFacetCollector = new BlockJoinFacetCollector(rb.req);
      rb.req.getContext().put(COLLECTOR_CONTEXT_PARAM, blockJoinFacetCollector);
      rb.getFilters().add(new BlockJoinFacetFilter(blockJoinFacetCollector));
    }
  }

