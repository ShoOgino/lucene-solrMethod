    @Override
    public Query rewrite(IndexReader reader) throws IOException {
      if(this.finalContexts == null) {
        //This query has not been re-written yet.
        //Rewriting the query does not effect the cache key as this query is not designed to be cached.
        this.finalContexts = new ArrayList();
        this.finalTerms = new ArrayList();
        List<LeafReaderContext> contexts = reader.leaves();
        TermContext[] termContexts = new TermContext[this.queryTerms.length];
        collectTermContext(reader, contexts, termContexts, this.queryTerms);
        for(int i=0; i<termContexts.length; i++) {
          TermContext termContext = termContexts[i];
          if(termContext != null && termContext.docFreq() <= this.maxDocFreq) {
            this.finalContexts.add(termContext);
            this.finalTerms.add(queryTerms[i]);
          }
        }
      }

      return this;
    }

