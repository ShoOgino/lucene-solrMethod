  @Test
  public void testShutdownDuringBuild() throws Exception {
    ExecutorService executor = ExecutorUtil.newMDCAwareCachedThreadPool("AnalyzingInfixSuggesterTest");
    try {
      // Build the suggester in the background with a long dictionary
      Future job = executor.submit(() -> 
          expectThrows(RuntimeException.class, SolrCoreState.CoreIsClosedException.class,
              () -> assertQ(req("qt", rh_analyzing_long,
                  SuggesterParams.SUGGEST_BUILD_ALL, "true"),
                  "//str[@name='command'][.='buildAll']")));
      Thread.sleep(100); // TODO: is there a better way to ensure that the build has begun?
      h.close();
      // Stop the dictionary's input iterator
      System.clearProperty(RandomTestDictionaryFactory.RandomTestDictionary
          .getEnabledSysProp("longRandomAnalyzingInfixSuggester"));
      job.get();
    } finally {
      ExecutorUtil.shutdownAndAwaitTermination(executor);
      initCore("solrconfig-infixsuggesters.xml","schema.xml"); // put the core back for other tests
    }
  }

