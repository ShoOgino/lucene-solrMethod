  @Test
  public void testMetricsSnapshot() throws Exception {
    final CountDownLatch counter = new CountDownLatch(500);
    MetricRegistry registry = new MetricRegistry();
    Set<String> names = ConcurrentHashMap.newKeySet();
    SolrInfoBean bean = new SolrInfoBean() {
      @Override
      public String getName() {
        return "foo";
      }

      @Override
      public String getDescription() {
        return "foo";
      }

      @Override
      public Category getCategory() {
        return Category.ADMIN;
      }

      @Override
      public Set<String> getMetricNames() {
        return names;
      }

      @Override
      public MetricRegistry getMetricRegistry() {
        return registry;
      }
    };
    runSnapshots = true;
    Thread modifier = new Thread(() -> {
      int i = 0;
      while (runSnapshots) {
        bean.registerMetricName("name-" + i++);
        try {
          Thread.sleep(31);
        } catch (InterruptedException e) {
          runSnapshots = false;
          break;
        }
      }
    });
    Thread reader = new Thread(() -> {
      while (runSnapshots) {
        try {
          bean.getMetricsSnapshot();
        } catch (Exception e) {
          runSnapshots = false;
          e.printStackTrace();
          fail("Exception getting metrics snapshot: " + e.toString());
        }
        try {
          Thread.sleep(53);
        } catch (InterruptedException e) {
          runSnapshots = false;
          break;
        }
        counter.countDown();
      }
    });
    modifier.start();
    reader.start();
    counter.await(30, TimeUnit.SECONDS);
    runSnapshots = false;
  }

