  @Test
  public void testMergeIndexesCoreAdminHandler() throws Exception {
    final File workDir = createTempDir().toFile();

    final CoreContainer cores = h.getCoreContainer();

    final CoreAdminHandler admin = new CoreAdminHandler(cores);

    try (SolrCore core = cores.getCore("collection1")) {
      DirectoryFactory df = core.getDirectoryFactory();
      FailingDirectoryFactory dirFactory = (FailingDirectoryFactory) df;

      try {
        dirFactory.fail = true;
        ignoreException(WRAPPED_FAILING_MSG);

        SolrQueryResponse resp = new SolrQueryResponse();
        admin.handleRequestBody
            (req(CoreAdminParams.ACTION,
                CoreAdminParams.CoreAdminAction.MERGEINDEXES.toString(),
                CoreAdminParams.CORE, "collection1",
                CoreAdminParams.INDEX_DIR, workDir.getAbsolutePath()),
                resp);
        fail("exception expected");
      } catch (SolrException e) {
        // expected if error handling properly
        assertEquals(FailingDirectoryFactory.FailingDirectoryFactoryException.class, e.getCause().getClass());
      } finally {
        unIgnoreException(WRAPPED_FAILING_MSG);
      }
      dirFactory.fail = false;
    }
  }

