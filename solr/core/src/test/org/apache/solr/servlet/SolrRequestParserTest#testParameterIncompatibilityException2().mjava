  @Test
  public void testParameterIncompatibilityException2() throws Exception
  {
    HttpServletRequest request = getMock("/solr/select", "application/x-www-form-urlencoded", 100);
    when(request.getMethod()).thenReturn("POST");
    // we emulate Tomcat that throws IllegalStateException when parameters were parsed before:
    when(request.getInputStream()).thenThrow(new IllegalStateException());

    FormDataRequestParser formdata = new FormDataRequestParser( 2048 );    
    try {
      formdata.parseParamsAndFillStreams(request, new ArrayList<ContentStream>());
      fail("should throw SolrException");
    } catch (SolrException solre) {
      assertTrue(solre.getMessage().startsWith("Solr requires that request parameters"));
      assertEquals(500, solre.code());
    }
    verify(request).getInputStream();
  }

