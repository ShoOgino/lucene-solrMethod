  @Test
  public void testParameterIncompatibilityException1() throws Exception
  {
    HttpServletRequest request = createMock(HttpServletRequest.class);
    expect(request.getMethod()).andReturn("POST").anyTimes();
    expect(request.getContentType()).andReturn("application/x-www-form-urlencoded").anyTimes();
    expect(request.getContentLength()).andReturn(100).anyTimes();
    expect(request.getQueryString()).andReturn(null).anyTimes();
    // we emulate Jetty that returns empty stream when parameters were parsed before:
    expect(request.getInputStream()).andReturn(new ServletInputStream() {
      @Override public int read() { return -1; }

      @Override
      public boolean isFinished() {
        return true;
      }

      @Override
      public boolean isReady() {
        return true;
      }

      @Override
      public void setReadListener(ReadListener readListener) {

      }
    });
    replay(request);
    
    FormDataRequestParser formdata = new FormDataRequestParser( 2048 );    
    try {
      formdata.parseParamsAndFillStreams(request, new ArrayList<ContentStream>());
      fail("should throw SolrException");
    } catch (SolrException solre) {
      assertTrue(solre.getMessage().startsWith("Solr requires that request parameters"));
      assertEquals(500, solre.code());
    }
  }

