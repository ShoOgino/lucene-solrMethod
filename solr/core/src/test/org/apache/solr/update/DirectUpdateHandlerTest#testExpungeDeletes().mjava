  @Test
  public void testExpungeDeletes() throws Exception {
    assertU(adoc("id","1"));
    assertU(adoc("id","2"));
    assertU(commit());

    assertU(adoc("id","3"));
    assertU(adoc("id","2"));
    assertU(adoc("id","4"));
    assertU(commit());

    SolrQueryRequest sr = req("q","foo");
    IndexReader r = sr.getSearcher().getTopReaderContext().reader;
    assertTrue(r.maxDoc() > r.numDocs());   // should have deletions
    assertFalse(r.getTopReaderContext().isAtomic);  // more than 1 segment
    sr.close();

    assertU(commit("expungeDeletes","true"));

    sr = req("q","foo");
    r = sr.getSearcher().getTopReaderContext().reader;
    assertEquals(r.maxDoc(), r.numDocs());  // no deletions
    assertEquals(4,r.maxDoc());             // no dups
    assertFalse(r.getTopReaderContext().isAtomic);  //still more than 1 segment
    sr.close();
  }

