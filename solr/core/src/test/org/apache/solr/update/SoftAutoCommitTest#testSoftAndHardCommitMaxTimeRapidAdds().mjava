  public void testSoftAndHardCommitMaxTimeRapidAdds() throws Exception {
 
    final int softCommitWaitMillis = 500;
    final int hardCommitWaitMillis = 1200;

    CommitTracker hardTracker = updater.commitTracker;
    CommitTracker softTracker = updater.softCommitTracker;
    
    softTracker.setTimeUpperBound(softCommitWaitMillis);
    softTracker.setDocsUpperBound(-1);
    hardTracker.setTimeUpperBound(hardCommitWaitMillis);
    hardTracker.setDocsUpperBound(-1);
    // we don't want to overlap soft and hard opening searchers - this now blocks commits and we
    // are looking for prompt timings
    hardTracker.setOpenSearcher(false);
    
    // try to add 5 docs really fast
    long fast5start = System.nanoTime();
    for( int i=0;i<5; i++ ) {
      assertU(adoc("id", ""+500 + i, "subject", "five fast docs"));
    }
    long fast5end = System.nanoTime() - TimeUnit.NANOSECONDS.convert(300, TimeUnit.MILLISECONDS); // minus a tad of slop
    long fast5time = 1 + TimeUnit.MILLISECONDS.convert(fast5end - fast5start, TimeUnit.NANOSECONDS);

    // total time for all 5 adds determines the number of soft to expect
    long expectedSoft = (long)Math.ceil((double) fast5time / softCommitWaitMillis);
    long expectedHard = (long)Math.ceil((double) fast5time / hardCommitWaitMillis);
    
    expectedSoft = Math.max(1, expectedSoft);
    expectedHard = Math.max(1, expectedHard);

    // note: counting from 1 for multiplication
    for (int i = 1; i <= expectedSoft; i++) {
      // Wait for the soft commit with plenty of fudge to survive nasty envs
      Long soft = monitor.soft.poll(softCommitWaitMillis * 2, MILLISECONDS);
      if (soft != null || i == 1) {
        assertNotNull(i + ": soft wasn't fast enough", soft);
        monitor.assertSaneOffers();

        // have to assume none of the docs were added until
        // very end of the add window
        long softMs = TimeUnit.MILLISECONDS.convert(soft - fast5end, TimeUnit.NANOSECONDS);
        assertTrue(i + ": soft occurred too fast: " +
            softMs + " < (" + softCommitWaitMillis + " * " + i + ")",
            softMs >= (softCommitWaitMillis * i));
      } else {
        // we may have guessed wrong and there were fewer commits
        assertNull("Got a soft commit we weren't expecting", monitor.soft.poll(2000, MILLISECONDS));
      }
    }

    // note: counting from 1 for multiplication
    for (int i = 1; i <= expectedHard; i++) {
      // wait for the hard commit, shouldn't need any fudge given 
      // other actions already taken
      Long hard = monitor.hard.poll(hardCommitWaitMillis, MILLISECONDS);
      assertNotNull(i + ": hard wasn't fast enough", hard);
      monitor.assertSaneOffers();
      
      // have to assume none of the docs were added until
      // very end of the add window
      long hardMs = TimeUnit.MILLISECONDS.convert(hard - fast5end, TimeUnit.NANOSECONDS);
      assertTrue(i + ": hard occurred too fast: " +
              hardMs + " < (" + hardCommitWaitMillis + " * " + i + ")",
          hardMs >= (hardCommitWaitMillis * i));
    }
    
    // we are only guessing how many commits we may see, allow one extra of each
    monitor.soft.poll(softCommitWaitMillis + 200, MILLISECONDS);
    monitor.hard.poll(hardCommitWaitMillis + 200, MILLISECONDS);
 
    // clear commits
    monitor.hard.clear();
    monitor.soft.clear();

    // wait a bit, w/o other action we shouldn't see any
    // new hard/soft commits
    assertNull("Got a hard commit we weren't expecting",
        monitor.hard.poll(1000, MILLISECONDS));
    assertNull("Got a soft commit we weren't expecting",
        monitor.soft.poll(0, MILLISECONDS));

    monitor.assertSaneOffers();
    
  }

