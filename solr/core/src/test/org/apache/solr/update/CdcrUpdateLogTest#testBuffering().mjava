  /**
   * Check the buffering of the old tlogs
   */
  @Test
  public void testBuffering() throws Exception {
    this.clearCore();

    CdcrUpdateLog ulog = (CdcrUpdateLog) h.getCore().getUpdateHandler().getUpdateLog();
    File logDir = new File(h.getCore().getUpdateHandler().getUpdateLog().getLogDir());

    int start = 0;

    LinkedList<Long> versions = new LinkedList<>();
    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    addDocs(105, start, versions);
    start += 105;
    assertU(commit());

    // the first two tlogs should have been removed
    assertEquals(1, ulog.getLogList(logDir).length);

    // enable buffer
    ulog.enableBuffer();

    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    addDocs(105, start, versions);
    start += 105;
    assertU(commit());

    // no tlog should have been removed
    assertEquals(4, ulog.getLogList(logDir).length);

    // disable buffer
    ulog.disableBuffer();

    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    // old tlogs should have been removed
    assertEquals(2, ulog.getLogList(logDir).length);
  }

