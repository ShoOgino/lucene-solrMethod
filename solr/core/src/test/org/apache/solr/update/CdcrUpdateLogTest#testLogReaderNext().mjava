  @Test
  public void testLogReaderNext() throws Exception {
    this.clearCore();

    int start = 0;

    UpdateLog ulog = h.getCore().getUpdateHandler().getUpdateLog();
    CdcrUpdateLog.CdcrLogReader reader = ((CdcrUpdateLog) ulog).newLogReader(); // test reader on empty updates log

    LinkedList<Long> versions = new LinkedList<>();
    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    addDocs(11, start, versions);
    start += 11;
    assertU(commit());

    for (int i = 0; i < 10; i++) { // 10 adds
      assertNotNull(reader.next());
    }
    Object o = reader.next();
    assertNotNull(o);

    @SuppressWarnings({"rawtypes"})
    List entry = (List) o;
    int opAndFlags = (Integer) entry.get(0);
    assertEquals(UpdateLog.COMMIT, opAndFlags & UpdateLog.OPERATION_MASK);

    for (int i = 0; i < 11; i++) { // 11 adds
      assertNotNull(reader.next());
    }
    o = reader.next();
    assertNotNull(o);

    entry = (List) o;
    opAndFlags = (Integer) entry.get(0);
    assertEquals(UpdateLog.COMMIT, opAndFlags & UpdateLog.OPERATION_MASK);

    assertNull(reader.next());

    // add a new tlog after having exhausted the reader

    addDocs(10, start, versions);
    start += 10;
    assertU(commit());

    // the reader should pick up the new tlog

    for (int i = 0; i < 11; i++) { // 10 adds + 1 commit
      assertNotNull(reader.next());
    }
    assertNull(reader.next());
  }

