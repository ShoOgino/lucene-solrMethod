    /**
     * Given a set of (possibly nested) facets, generates a suitable <code>json.facet</code> param value to 
     * use for testing them against in a solr request.
     */
    public static CharSequence toJSONFacetParamValue(final Map<String,TermFacet> facets,
                                                     final String extraJson) {
      assert null != facets;
      if (0 == facets.size() && null == extraJson) {
        return "";
      }

      StringBuilder sb = new StringBuilder("{ processEmpty: true, ");
      for (String key : facets.keySet()) {
        sb.append(key).append(" : ").append(facets.get(key).toJSONFacetParamValue());
        sb.append(" ,");
      }
      if (null == extraJson) {
        sb.setLength(sb.length() - 1);
      } else {
        sb.append(extraJson);
      }
      sb.append("}");
      return sb;
    }

