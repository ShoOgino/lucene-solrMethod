  // Create several log watchers and ensure that new messages go to the new watcher.
  @Test
  public void testLog4jWatcher() {
    LogWatcher watcher;
    int lim = random().nextInt(3) + 2;
    for (int idx = 0; idx < lim; ++idx) {
      String msg = "This is a test message: " + idx;
      watcher = LogWatcher.newRegisteredLogWatcher(config, null);

      // First ensure there's nothing in the new watcher.

      // Every time you put a message in the queue, you wait for it to come out _before_ creating
      // a new watcher so it should be fine.
      if (looper(watcher, null) == false) {
        fail("There should be no messages when a new watcher finally gets registered! In loop: " + idx);
      }

      // Now log a message and ensure that the new watcher sees it.
      log.warn(msg);

      // Loop to give the logger time to process the async message and notify the new watcher.
      if (looper(watcher, msg) == false) {
        fail("Should have found message " + msg + ". In loop: " + idx);
      }
    }
  }

