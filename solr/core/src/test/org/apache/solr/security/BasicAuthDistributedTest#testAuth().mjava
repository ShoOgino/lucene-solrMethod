  private void testAuth() throws Exception {
    QueryResponse rsp = query("q","text:doc", "fl", "id,text", "sort", "id asc");
    assertEquals(10, rsp.getResults().getNumFound());

    // Enable authentication
    for (JettySolrRunner j : jettys) {
      writeSecurityJson(j.getCoreContainer());
    }

    HttpSolrClient.RemoteSolrException expected = expectThrows(HttpSolrClient.RemoteSolrException.class, () -> {
      query("q","text:doc-fail", "fl", "id,text", "sort", "id asc");
    });
    assertEquals(401, expected.code());

    // Add auth
    ModifiableSolrParams params = new ModifiableSolrParams();
    params.add("q", "text:doc").add("fl", "id,text").add("sort", "id asc");
    QueryRequest req = new QueryRequest(params);
    req.setBasicAuthCredentials("solr", "SolrRocks");
    rsp = req.process(clients.get(0), null);
    if (jettys.size() > 1) {
      assertTrue(rsp.getResults().getNumFound() < 10);
      rsp = query(true, params, "solr", "SolrRocks");
    }
    assertEquals(10, rsp.getResults().getNumFound());

    // Disable auth
    for (JettySolrRunner j : jettys) {
      deleteSecurityJson(j.getCoreContainer());
    }

  }

