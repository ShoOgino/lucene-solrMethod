  private void run(String expected, Runnable r) throws Exception {
    int failures = 0;
    for (; ; ) {
      r.run();
      if (expected == null) {
        assertTrue(wrappedRequestByFilter.get() == null || ((HttpServletRequest) wrappedRequestByFilter.get()).getUserPrincipal() == null);
      } else {
        assertNotNull(wrappedRequestByFilter.get());
        if (((HttpServletRequest) wrappedRequestByFilter.get()).getUserPrincipal() == null) {
          //may be timed out
          if (++failures < 3) continue;
          else
            fail("No principal obtained");
        }
        assertEquals(expected, ((HttpServletRequest) wrappedRequestByFilter.get()).getUserPrincipal().getName());
      }
      return;

    }
  }

