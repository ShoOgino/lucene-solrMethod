  @Test
  public void testMoveMetrics() throws Exception {
    Random r = random();

    SolrMetricManager metricManager = new SolrMetricManager();

    Map<String, Counter> metrics1 = SolrMetricTestUtils.getRandomMetrics(r, true);
    Map<String, Counter> metrics2 = SolrMetricTestUtils.getRandomMetrics(r, true);
    String fromName = TestUtil.randomSimpleString(r, 1, 10);
    String toName = TestUtil.randomSimpleString(r, 1, 10);
    // register test metrics
    for (Map.Entry<String, Counter> entry : metrics1.entrySet()) {
      metricManager.register(fromName, entry.getValue(), false, entry.getKey(), "metrics1");
    }
    for (Map.Entry<String, Counter> entry : metrics2.entrySet()) {
      metricManager.register(fromName, entry.getValue(), false, entry.getKey(), "metrics2");
    }
    assertEquals(metrics1.size() + metrics2.size(), metricManager.registry(fromName).getMetrics().size());

    // move metrics1
    metricManager.moveMetrics(fromName, toName, new SolrMetricManager.PrefixFilter("metrics1"));
    // check the remaining metrics
    Map<String, Metric> fromMetrics = metricManager.registry(fromName).getMetrics();
    assertEquals(metrics2.size(), fromMetrics.size());
    for (Map.Entry<String, Counter> entry : metrics2.entrySet()) {
      Object value = fromMetrics.get(SolrMetricManager.mkName(entry.getKey(), "metrics2"));
      assertNotNull(value);
      assertEquals(entry.getValue(), value);
    }
    // check the moved metrics
    Map<String, Metric> toMetrics = metricManager.registry(toName).getMetrics();
    assertEquals(metrics1.size(), toMetrics.size());
    for (Map.Entry<String, Counter> entry : metrics1.entrySet()) {
      Object value = toMetrics.get(SolrMetricManager.mkName(entry.getKey(), "metrics1"));
      assertNotNull(value);
      assertEquals(entry.getValue(), value);
    }

    // move all remaining metrics
    metricManager.moveMetrics(fromName, toName, null);
    fromMetrics = metricManager.registry(fromName).getMetrics();
    assertEquals(0, fromMetrics.size());
    toMetrics = metricManager.registry(toName).getMetrics();
    assertEquals(metrics1.size() + metrics2.size(), toMetrics.size());
  }

