  @Test
  public void testHttpListenerIntegration() throws Exception {
    CloudSolrClient solrClient = cluster.getSolrClient();
    String setTriggerCommand = "{" +
        "'set-trigger' : {" +
        "'name' : 'node_added_trigger'," +
        "'event' : 'nodeAdded'," +
        "'waitFor' : '0s'," +
        "'enabled' : true," +
        "'actions' : [" +
        "{'name':'test','class':'" + TestDummyAction.class.getName() + "'}" +
        "]" +
        "}}";
    SolrRequest req = AutoScalingRequest.create(SolrRequest.METHOD.POST, setTriggerCommand);
    NamedList<Object> response = solrClient.request(req);
    assertEquals(response.get("result").toString(), "success");

    String setListenerCommand = "{" +
        "'set-listener' : " +
        "{" +
        "'name' : 'foo'," +
        "'trigger' : 'node_added_trigger'," +
        "'stage' : ['STARTED','ABORTED','SUCCEEDED', 'FAILED']," +
        "'beforeAction' : 'test'," +
        "'afterAction' : ['test']," +
        "'class' : '" + HttpTriggerListener.class.getName() + "'," +
        "'url' : '" + mockService.server.getURI().toString() + "/${config.name:invalid}/${config.properties.beforeAction:invalid}/${stage}'," +
        "'payload': 'actionName=${actionName}, source=${event.source}, type=${event.eventType}'," +
        "'header.X-Foo' : '${config.name:invalid}'" +
        "}" +
        "}";
    req = AutoScalingRequest.create(SolrRequest.METHOD.POST, setListenerCommand);
    response = solrClient.request(req);
    assertEquals(response.get("result").toString(), "success");

    assertEquals(mockService.requests.toString(), 0, mockService.requests.size());

    cluster.startJettySolrRunner();
    cluster.waitForAllNodes(30);
    boolean await = triggerFiredLatch.await(20, TimeUnit.SECONDS);
    assertTrue("The trigger did not fire at all", await);

    Thread.sleep(5000);

    assertEquals(mockService.requests.toString(), 4, mockService.requests.size());
    mockService.requests.forEach(s -> assertTrue(s.contains("Content-Type: application/json")));
    mockService.requests.forEach(s -> assertTrue(s.contains("X-Foo: foo")));
    mockService.requests.forEach(s -> assertTrue(s.contains("source=node_added_trigger")));
    mockService.requests.forEach(s -> assertTrue(s.contains("type=NODEADDED")));

    String request = mockService.requests.get(0);
    assertTrue(request, request.startsWith("/foo/test/STARTED"));
    assertTrue(request, request.contains("actionName=,")); // empty actionName

    request = mockService.requests.get(1);
    assertTrue(request, request.startsWith("/foo/test/BEFORE_ACTION"));
    assertTrue(request, request.contains("actionName=test,")); // actionName

    request = mockService.requests.get(2);
    assertTrue(request, request.startsWith("/foo/test/AFTER_ACTION"));
    assertTrue(request, request.contains("actionName=test,")); // actionName

    request = mockService.requests.get(3);
    assertTrue(request, request.startsWith("/foo/test/SUCCEEDED"));
    assertTrue(request, request.contains("actionName=,")); // empty actionName
  }

