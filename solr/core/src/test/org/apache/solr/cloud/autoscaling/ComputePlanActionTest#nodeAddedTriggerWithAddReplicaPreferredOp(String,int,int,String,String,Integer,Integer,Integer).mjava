  private void nodeAddedTriggerWithAddReplicaPreferredOp(String collectionNamePrefix, int numShards, int numCollections, String setTriggerCommand, String setClusterPolicyCommand, Integer nNrtReplicas, Integer nTlogReplicas, Integer nPullReplicas) throws Exception {
    CloudSolrClient solrClient = cluster.getSolrClient();
    @SuppressWarnings({"rawtypes"})
    SolrRequest req = AutoScalingRequest.create(SolrRequest.METHOD.POST, setTriggerCommand);
    NamedList<Object> response = solrClient.request(req);
    assertEquals(response.get("result").toString(), "success");

    req = AutoScalingRequest.create(SolrRequest.METHOD.POST, setClusterPolicyCommand);
    response = solrClient.request(req);
    assertEquals(response.get("result").toString(), "success");


    CollectionAdminRequest.Create create = CollectionAdminRequest.createCollection(collectionNamePrefix + "_0",
        "conf", numShards, nNrtReplicas, nTlogReplicas, nPullReplicas);
    create.process(solrClient);

    waitForState("Timed out waiting for replicas of new collection to be active",
        collectionNamePrefix + "_0", (liveNodes, collectionState) ->
            collectionState.getReplicas().stream().allMatch(replica -> replica.isActive(liveNodes)));

    JettySolrRunner newNode = cluster.startJettySolrRunner();
    cluster.waitForAllNodes(30);
    assertTrue(triggerFiredLatch.await(30, TimeUnit.SECONDS));
    assertTrue(fired.get());
    @SuppressWarnings({"rawtypes"})
    Map actionContext = actionContextPropsRef.get();
    @SuppressWarnings({"rawtypes"})
    List operations = (List) actionContext.get("operations");
    assertNotNull(operations);
    assertEquals(numShards, operations.size());
    Set<String> affectedShards = new HashSet<>(2);
    for (Object operation : operations) {
      assertTrue(operation instanceof CollectionAdminRequest.AddReplica);
      CollectionAdminRequest.AddReplica addReplica = (CollectionAdminRequest.AddReplica) operation;
      assertEquals(newNode.getNodeName(), addReplica.getNode());
      assertEquals(collectionNamePrefix + "_0", addReplica.getCollection());
      affectedShards.add(addReplica.getShard());
    }
    assertEquals(numShards, affectedShards.size());

    for (int i = 1; i < numCollections; i++) {
      create = CollectionAdminRequest.createCollection(collectionNamePrefix + "_" + i,
          "conf", numShards, 2);
      create.process(solrClient);

      waitForState("Timed out waiting for replicas of new collection to be active",
          collectionNamePrefix + "_" + i, (liveNodes, collectionState) ->
              collectionState.getReplicas().stream().allMatch(replica -> replica.isActive(liveNodes)));
    }

    reset();

    newNode = cluster.startJettySolrRunner();
    assertTrue(triggerFiredLatch.await(30, TimeUnit.SECONDS));
    assertTrue(fired.get());
    actionContext = actionContextPropsRef.get();
    operations = (List) actionContext.get("operations");
    assertNotNull(operations);
    assertEquals(numCollections * numShards, operations.size());
    Set<String> affectedCollections = new HashSet<>(numCollections);
    affectedShards = new HashSet<>(numShards);
    Set<Pair<String, String>> affectedCollShards = new HashSet<>(numCollections * numShards);
    for (Object operation : operations) {
      assertTrue(operation instanceof CollectionAdminRequest.AddReplica);
      CollectionAdminRequest.AddReplica addReplica = (CollectionAdminRequest.AddReplica) operation;
      assertEquals(newNode.getNodeName(), addReplica.getNode());
      affectedCollections.add(addReplica.getCollection());
      affectedShards.add(addReplica.getShard());
      affectedCollShards.add(new Pair<>(addReplica.getCollection(), addReplica.getShard()));
    }
    assertEquals(numCollections, affectedCollections.size());
    assertEquals(numShards, affectedShards.size());
    assertEquals(numCollections * numShards, affectedCollShards.size());
  }

