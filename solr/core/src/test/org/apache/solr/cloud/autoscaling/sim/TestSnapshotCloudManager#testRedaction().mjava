  @Test
  public void testRedaction() throws Exception {
    Path tmpPath = createTempDir();
    File tmpDir = tmpPath.toFile();
    SnapshotCloudManager snapshotCloudManager = new SnapshotCloudManager(realManager, null);
    Set<String> redacted = new HashSet<>(realManager.getClusterStateProvider().getLiveNodes());
    redacted.addAll(realManager.getClusterStateProvider().getClusterState().getCollectionStates().keySet());
    snapshotCloudManager.saveSnapshot(tmpDir, true, true);
    for (String key : SnapshotCloudManager.REQUIRED_KEYS) {
      File src = new File(tmpDir, key + ".json");
      assertTrue(src.toString() + " doesn't exist", src.exists());
      try (FileInputStream is = new FileInputStream(src)) {
        String data = IOUtils.toString(is, Charset.forName("UTF-8"));
        assertFalse("empty data in " + src, data.trim().isEmpty());
        for (String redactedName : redacted) {
          assertFalse("redacted name " + redactedName + " found in " + src, data.contains(redactedName));
        }
      }
    }
  }

