  @Test
  public void testSuggestions() throws Exception {
    String snapshotPath = createTempDir() + "/snapshot";
    try (SimScenario scenario = SimScenario.load(testSuggestionsScenario)) {
      scenario.context.put("snapshotPath", snapshotPath);
      ByteArrayOutputStream baos = new ByteArrayOutputStream();
      PrintStream ps = new PrintStream(baos, true, Charset.forName("UTF-8"));
      scenario.console = ps;
      scenario.context.put("iterative", "0");
      scenario.context.put("justCalc", "1");
      scenario.run();
      List<Suggester.SuggestionInfo> suggestions = (List<Suggester.SuggestionInfo>)scenario.context.get(SimScenario.SUGGESTIONS_CTX_PROP);
      assertNotNull(suggestions);
      assertEquals(suggestions.toString(), 1, suggestions.size());
      // reconstruct the snapshot from the dump
      Map<String, Object> snapshot = (Map<String, Object>)Utils.fromJSON(baos.toByteArray());
      Map<String, Object> autoscalingState = (Map<String, Object>)snapshot.get(SnapshotCloudManager.AUTOSCALING_STATE_KEY);
      assertNotNull(autoscalingState);
      assertEquals(autoscalingState.toString(), 1, autoscalingState.size());
      assertTrue(autoscalingState.toString(), autoscalingState.containsKey("suggestions"));
      List<Map<String, Object>> snapSuggestions = (List<Map<String, Object>>)autoscalingState.get("suggestions");
      assertEquals(snapSuggestions.toString(), 1, snapSuggestions.size());
      // _loop_iter_ should be present and 0 (first iteration)
      assertEquals("0", scenario.context.get(SimScenario.LOOP_ITER_PROP));
    }
    // try looping more times
    try (SimScenario scenario = SimScenario.load(testSuggestionsScenario)) {
      scenario.context.put("iterative", "10");
      scenario.context.put("justCalc", "0");
      scenario.run();
      assertEquals("9", scenario.context.get(SimScenario.LOOP_ITER_PROP));
    }

  }

