  /**
   * Test the scenario where the follower is killed while the leader is still receiving updates.
   * The follower should buffer updates while in recovery, then replay them at the end of the recovery.
   * If updates were properly buffered and replayed, then the follower should have the same number of documents
   * than the leader. This checks if cdcr tlog replication interferes with buffered updates - SOLR-8263.
   */
  @Test
  @ShardsFixed(num = 2)
  public void testReplicationWithBufferedUpdates() throws Exception {
    List<CloudJettyRunner> followers = this.getShardToFollowerJetty(SOURCE_COLLECTION, SHARD1);

    AtomicInteger numDocs = new AtomicInteger(0);
    ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor(new SolrNamedThreadFactory("cdcr-test-update-scheduler"));
    executor.scheduleWithFixedDelay(new UpdateThread(numDocs), 10, 10, TimeUnit.MILLISECONDS);

    // Restart the follower node to trigger Replication strategy
    this.restartServer(followers.get(0));

    // shutdown the update thread and wait for its completion
    executor.shutdown();
    executor.awaitTermination(500, TimeUnit.MILLISECONDS);

    // check that we have the expected number of documents in the cluster
    assertNumDocs(numDocs.get(), SOURCE_COLLECTION);

    // check that we have the expected number of documents on the follower
    assertNumDocs(numDocs.get(), followers.get(0));
  }

