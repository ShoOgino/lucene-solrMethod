  public void testCreateCollectionAddShardUsingPolicy() throws Exception {
    SolrClient solrClient = cluster.simGetSolrClient();
    String nodeId = cluster.getSimClusterStateProvider().simGetRandomNode();
    int port = (Integer)cluster.getSimNodeStateProvider().simGetNodeValue(nodeId, ImplicitSnitch.PORT);

    String commands =  "{set-policy :{c1 : [{replica:1 , shard:'#EACH', port: '" + port + "'}]}}";
    solrClient.request(AutoScalingHandlerTest.createAutoScalingRequest(SolrRequest.METHOD.POST, commands));
    Map<String, Object> json = Utils.getJson(cluster.getDistribStateManager(), ZkStateReader.SOLR_AUTOSCALING_CONF_PATH);
    assertEquals("full json:"+ Utils.toJSONString(json) , "#EACH",
        Utils.getObjectByPath(json, true, "/policies/c1[0]/shard"));
    CollectionAdminRequest.createCollectionWithImplicitRouter("policiesTest", "conf", "s1,s2", 1)
        .setPolicy("c1")
        .process(solrClient);
    CloudTestUtils.waitForState(cluster, "Timeout waiting for collection to become active", "policiesTest",
        CloudTestUtils.clusterShape(2, 1));

    DocCollection coll = getCollectionState("policiesTest");
    assertEquals("c1", coll.getPolicyName());
    assertEquals(2,coll.getReplicas().size());
    coll.forEachReplica((s, replica) -> assertEquals(nodeId, replica.getNodeName()));
    CollectionAdminRequest.createShard("policiesTest", "s3").process(solrClient);
    CloudTestUtils.waitForState(cluster, "Timeout waiting for collection to become active", "policiesTest",
        CloudTestUtils.clusterShape(3, 1));

    coll = getCollectionState("policiesTest");
    assertEquals(1, coll.getSlice("s3").getReplicas().size());
    coll.getSlice("s3").forEach(replica -> assertEquals(nodeId, replica.getNodeName()));
  }

