  @Test
  public void testDistributedQueue() throws Exception {
    String dqZNode = "/distqueue/test";
    String testData = "hello world";
    long timeoutMs = 500L;

    DistributedQueue dq = new DistributedQueue(zkClient, setupDistributedQueueZNode(dqZNode));

    // basic ops
    assertTrue(dq.poll() == null);
    byte[] data = testData.getBytes(UTF8);
    dq.offer(data);
    assertEquals(new String(dq.peek(),UTF8), testData);
    assertEquals(new String(dq.take(),UTF8), testData);
    assertTrue(dq.poll() == null);
    QueueEvent qe = dq.offer(data, timeoutMs);
    assertNotNull(qe);
    assertEquals(new String(dq.remove(),UTF8), testData);

    // should block until the background thread makes the offer
    (new QueueChangerThread(dq, 1000)).start();
    qe = dq.peek(true);
    assertNotNull(qe);
    dq.remove();

    // timeout scenario ... background thread won't offer until long after the peek times out
    QueueChangerThread qct = new QueueChangerThread(dq, 1000);
    qct.start();
    qe = dq.peek(500);
    assertTrue(qe == null);

    try {
      qct.interrupt();
    } catch (Exception exc) {}
  }

