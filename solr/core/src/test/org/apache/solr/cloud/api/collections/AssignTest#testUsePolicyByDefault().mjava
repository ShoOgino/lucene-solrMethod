  @Test
  public void testUsePolicyByDefault() throws Exception {
    assumeWorkingMockito();

    SolrCloudManager solrCloudManager = mock(SolrCloudManager.class);
    ClusterStateProvider clusterStateProvider = mock(ClusterStateProvider.class);
    when(solrCloudManager.getClusterStateProvider()).thenReturn(clusterStateProvider);
    // first we set useLegacyReplicaAssignment=false, so autoscaling should always be used
    when(clusterStateProvider.getClusterProperties()).thenReturn(Utils.makeMap("defaults", Utils.makeMap("cluster", Utils.makeMap("useLegacyReplicaAssignment", false))));
    // verify
    boolean usePolicyFramework = Assign.usePolicyFramework(solrCloudManager);
    assertTrue(usePolicyFramework);

    // now we set useLegacyReplicaAssignment=true, so autoscaling can only be used if an explicit policy or preference exists
    when(clusterStateProvider.getClusterProperties()).thenReturn(Utils.makeMap("defaults", Utils.makeMap("cluster", Utils.makeMap("useLegacyReplicaAssignment", true))));
    DistribStateManager distribStateManager = mock(DistribStateManager.class);
    when(solrCloudManager.getDistribStateManager()).thenReturn(distribStateManager);
    when(distribStateManager.getAutoScalingConfig()).thenReturn(new AutoScalingConfig(Collections.emptyMap()));
    assertFalse(Assign.usePolicyFramework(solrCloudManager));

    // lets provide a custom preference and assert that autoscaling is used even if useLegacyReplicaAssignment=false
    // our custom preferences are exactly the same as the default ones
    // but because we are providing them explicitly, they must cause autoscaling to turn on
    List<Map> customPreferences = Policy.DEFAULT_PREFERENCES
        .stream().map(preference -> preference.getOriginal()).collect(Collectors.toList());

    when(distribStateManager.getAutoScalingConfig()).thenReturn(new AutoScalingConfig(Utils.makeMap("cluster-preferences", customPreferences)));
    assertTrue(Assign.usePolicyFramework(solrCloudManager));
  }

