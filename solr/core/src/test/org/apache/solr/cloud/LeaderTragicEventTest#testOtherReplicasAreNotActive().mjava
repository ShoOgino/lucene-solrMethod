  @Test
  public void testOtherReplicasAreNotActive() throws Exception {
    int numReplicas = random().nextInt(2) + 1;
    // won't do anything if leader is the only one active replica in the shard
    CollectionAdminRequest
        .createCollection(COLLECTION, "config", 1, numReplicas)
        .process(cluster.getSolrClient());
    ClusterStateUtil.waitForAllActiveAndLiveReplicas(cluster.getSolrClient().getZkStateReader(), COLLECTION, 120000);

    JettySolrRunner otherReplicaJetty = null;
    if (numReplicas == 2) {
      Slice shard = getCollectionState(COLLECTION).getSlice("shard1");
      otherReplicaJetty = cluster.getReplicaJetty(getNonLeader(shard));
      otherReplicaJetty.stop();
      waitForState("Timeout waiting for replica get down", COLLECTION, (liveNodes, collectionState) -> getNonLeader(collectionState.getSlice("shard1")).getState() != Replica.State.ACTIVE);
    }

    Replica oldLeader = corruptLeader(new ArrayList<>());

    //TODO better way to test this
    Thread.sleep(5000);
    Replica leader = getCollectionState(COLLECTION).getSlice("shard1").getLeader();
    assertEquals(leader.getName(), oldLeader.getName());

    if (otherReplicaJetty != null) {
      // won't be able to do anything here, since this replica can't recovery from the leader
      otherReplicaJetty.start();
    }

    CollectionAdminRequest.deleteCollection(COLLECTION).process(cluster.getSolrClient());
  }

