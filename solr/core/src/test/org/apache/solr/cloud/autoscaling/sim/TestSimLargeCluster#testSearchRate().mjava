  @Test
  public void testSearchRate() throws Exception {
    SolrClient solrClient = cluster.simGetSolrClient();
    String collectionName = "testSearchRate";
    CollectionAdminRequest.Create create = CollectionAdminRequest.createCollection(collectionName,
        "conf", 2, 10);
    create.process(solrClient);

    log.info("Ready after " + CloudTestUtils.waitForState(cluster, collectionName, 300, TimeUnit.SECONDS,
        CloudTestUtils.clusterShape(2, 10, false, true)) + " ms");

    // collect the node names for shard1
    Set<String> nodes = new HashSet<>();
    cluster.getSimClusterStateProvider().getClusterState().getCollection(collectionName)
        .getSlice("shard1")
        .getReplicas()
        .forEach(r -> nodes.add(r.getNodeName()));

    String metricName = "QUERY./select.requestTimes:1minRate";
    // simulate search traffic
    cluster.getSimClusterStateProvider().simSetShardValue(collectionName, "shard1", metricName, 40, false, true);

    // now define the trigger. doing it earlier may cause partial events to be generated (where only some
    // nodes / replicas exceeded the threshold).
    assertAutoScalingRequest
      ( "{" +
        "'set-trigger' : {" +
        "'name' : 'search_rate_trigger'," +
        "'event' : 'searchRate'," +
        "'waitFor' : '" + waitForSeconds + "s'," +
        "'aboveRate' : 1.0," +
        "'aboveNodeRate' : 1.0," +
        "'enabled' : true," +
        "'actions' : [" +
        "{'name':'compute','class':'" + ComputePlanAction.class.getName() + "'}," +
        "{'name':'execute','class':'" + ExecutePlanAction.class.getName() + "'}," +
        "{'name':'test','class':'" + FinishTriggerAction.class.getName() + "'}" +
        "]" +
        "}}");


    // we're going to expect our trigger listener to process exactly one captured event
    listenerEventLatch = new CountDownLatch(1);
    assertAutoScalingRequest
      ( "{" +
        "'set-listener' : " +
        "{" +
        "'name' : 'srt'," +
        "'trigger' : 'search_rate_trigger'," +
        "'stage' : ['FAILED','SUCCEEDED']," +
        "'class' : '" + TestTriggerListener.class.getName() + "'" +
        "}" +
        "}");

    assertAutoscalingUpdateComplete();

    assertTrue("Trigger did not finish even after await()ing an excessive amount of time",
               triggerFinishedLatch.await(60, TimeUnit.SECONDS));
    
    assertTrue("The listener didn't record the event even after await()ing an excessive amount of time",
               listenerEventLatch.await(60, TimeUnit.SECONDS));
    List<CapturedEvent> events = listenerEvents.get("srt");
    assertNotNull("no srt events: " + listenerEvents.toString(), events);
    assertEquals(events.toString(), 1, events.size());

    CapturedEvent ev = events.get(0);
    assertEquals(TriggerEventType.SEARCHRATE, ev.event.getEventType());
    Map<String, Number> m = (Map<String, Number>)ev.event.getProperty(SearchRateTrigger.HOT_NODES);
    assertNotNull(m);
    assertEquals(nodes.size(), m.size());
    assertEquals(nodes, m.keySet());
    m.forEach((k, v) -> assertEquals(4.0, v.doubleValue(), 0.01));
    List<TriggerEvent.Op> ops = (List<TriggerEvent.Op>)ev.event.getProperty(TriggerEvent.REQUESTED_OPS);
    assertNotNull(ops);
    assertEquals(ops.toString(), 1, ops.size());
    ops.forEach(op -> {
      assertEquals(CollectionParams.CollectionAction.ADDREPLICA, op.getAction());
      assertEquals(1, op.getHints().size());
      Object o = op.getHints().get(Suggester.Hint.COLL_SHARD);
      // this may be a pair or a HashSet of pairs with size 1
      Pair<String, String> hint = null;
      if (o instanceof Pair) {
        hint = (Pair<String, String>)o;
      } else if (o instanceof Set) {
        assertEquals("unexpected number of hints: " + o, 1, ((Set)o).size());
        o = ((Set)o).iterator().next();
        assertTrue("unexpected hint: " + o, o instanceof Pair);
        hint = (Pair<String, String>)o;
      } else {
        fail("unexpected hints: " + o);
      }
      assertNotNull(hint);
      assertEquals(collectionName, hint.first());
      assertEquals("shard1", hint.second());
    });
  }

