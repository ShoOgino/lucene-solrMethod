  @Test
  public void deleteCollectionWithDownNodes() throws Exception {

    CollectionAdminRequest.createCollection("halfdeletedcollection2", "conf", 4, 2)
        .setMaxShardsPerNode(3)
        .process(cluster.getSolrClient());

    // stop a couple nodes
    cluster.stopJettySolrRunner(cluster.getRandomJetty(random()));
    cluster.stopJettySolrRunner(cluster.getRandomJetty(random()));

    // wait for leaders to settle out
    waitForState("Timed out waiting for leader elections", "halfdeletedcollection2", (n, c) -> {
      for (Slice slice : c) {
        if (slice.getLeader() == null)
          return false;
        if (slice.getLeader().isActive(n) == false)
          return false;
      }
      return true;
    });

    // delete the collection
    CollectionAdminRequest.deleteCollection("halfdeletedcollection2").process(cluster.getSolrClient());
    waitForState("Timed out waiting for collection to be deleted", "halfdeletedcollection2", (n, c) -> c == null);

    assertFalse("Still found collection that should be gone",
        cluster.getSolrClient().getZkStateReader().getClusterState().hasCollection("halfdeletedcollection2"));

  }

