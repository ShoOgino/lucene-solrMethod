  @Before
  public void setupCluster() throws Exception {
    CommonTestInjection.setAdditionalProps(ImmutableMap.of("zone", "us-west1"));
    configureCluster(2)
        .withSolrXml(TEST_PATH().resolve("solr-trackingshardhandler.xml"))
        .addConfig("config", TEST_PATH().resolve("configsets").resolve("cloud-minimal").resolve("conf"))
        .configure();

    zone1Nodes.addAll(cluster.getJettySolrRunners().stream().map(JettySolrRunner::getNodeName).collect(Collectors.toSet()));
    CommonTestInjection.setAdditionalProps(ImmutableMap.of("zone", "us-west2"));
    zone2Nodes.add(cluster.startJettySolrRunner().getNodeName());
    zone2Nodes.add(cluster.startJettySolrRunner().getNodeName());

    String commands =  "{set-cluster-policy :[{" +
        "    'replica':'#EQUAL'," +
        "    'shard':'#EACH'," +
        "    'sysprop.zone':'#EACH'}]}";

    SolrRequest req = CloudTestUtils.AutoScalingRequest.create(SolrRequest.METHOD.POST, commands);
    NamedList<Object> response = cluster.getSolrClient().request(req);

    CollectionAdminRequest.createCollection(COLLECTION, 2, 2)
        .process(cluster.getSolrClient());
    cluster.waitForActiveCollection(COLLECTION, 2, 4);

    // Checking putting replicas
    for (Slice slice : getCollectionState(COLLECTION).getSlices()) {
      int numReplicaInZone1 = 0;
      int numReplicaInZone2 = 0;
      for (Replica replica : slice.getReplicas()) {
        if (zone1Nodes.contains(replica.getNodeName()))
          numReplicaInZone1++;
        if (zone2Nodes.contains(replica.getNodeName()))
          numReplicaInZone2++;
      }

      assertEquals(1, numReplicaInZone1);
      assertEquals(1, numReplicaInZone2);
    }

    // check inject props
    SolrCloudManager cloudManager = new SolrClientCloudManager(new ZkDistributedQueueFactory(cluster.getZkClient()),
        cluster.getSolrClient());
    for (String zone1Node: zone1Nodes) {
      NodeStateProvider nodeStateProvider = cloudManager.getNodeStateProvider();
      Map<String, Object> map  = nodeStateProvider.getNodeValues(zone1Node, Collections.singletonList(PROP_NAME));
      assertEquals("us-west1", map.get(PROP_NAME));
    }

    for (String zone2Node: zone2Nodes) {
      NodeStateProvider nodeStateProvider = cloudManager.getNodeStateProvider();
      Map<String, Object> map = nodeStateProvider.getNodeValues(zone2Node, Collections.singletonList(PROP_NAME));
      assertEquals("us-west2", map.get(PROP_NAME));
    }

    for (JettySolrRunner jetty : cluster.getJettySolrRunners()) {
      if (zone1Nodes.contains(jetty.getNodeName())) {
        ((TrackingShardHandlerFactory)jetty.getCoreContainer().getShardHandlerFactory()).setTrackingQueue(zone1Queue);
      } else {
        ((TrackingShardHandlerFactory)jetty.getCoreContainer().getShardHandlerFactory()).setTrackingQueue(zone2Queue);
      }
    }

    for (int i = 0; i < 20; i++) {
      new UpdateRequest()
          .add("id", String.valueOf(i))
          .process(cluster.getSolrClient(), COLLECTION);
    }

    new UpdateRequest()
        .commit(cluster.getSolrClient(), COLLECTION);
  }

