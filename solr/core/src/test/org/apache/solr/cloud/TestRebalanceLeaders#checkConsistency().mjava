  // After we've called the rebalance command, we want to insure that:
  // 1> all replicas appear once and only once in the respective leader election queue
  // 2> All the replicas we _think_ are leaders are in the 0th position in the leader election queue.
  // 3> The node that ZooKeeper thinks is the leader is the one we think should be the leader.
  void checkConsistency() throws InterruptedException, KeeperException {
    TimeOut timeout = new TimeOut(timeoutMs, TimeUnit.MILLISECONDS);
    boolean checkAppearOnce = false;
    boolean checkElectionZero = false;
    boolean checkZkLeadersAgree = false;
    while (!timeout.hasTimedOut()) {
      checkAppearOnce = checkAppearOnce();
      checkElectionZero = checkElectionZero();
      checkZkLeadersAgree = checkZkLeadersAgree();
      if (checkAppearOnce && checkElectionZero && checkZkLeadersAgree) {
        return;
      }
      Thread.sleep(1000);
    }

    fail("Checking the rebalance leader command failed, checkAppearOnce=" + checkAppearOnce + " checkElectionZero="
        + checkElectionZero + " checkZkLeadersAgree=" + checkZkLeadersAgree);
  }

