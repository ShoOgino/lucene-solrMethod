  private static int refresh(ZkStateReader reader, int trackedStateVersion, boolean explicitRefresh) throws KeeperException, InterruptedException {
    if (explicitRefresh) {
      reader.updateClusterState();
      return reader.getClusterState().getZkClusterStateVersion();
    }
    for (int i = 0; i < 100; ++i) {
      // Loop until we observe the change.
      int newStateVersion = reader.getClusterState().getZkClusterStateVersion();
      if (newStateVersion > trackedStateVersion) {
        return newStateVersion;
      }
      Thread.sleep(100);
    }
    throw new AssertionError("Did not observe expected update");
  }

