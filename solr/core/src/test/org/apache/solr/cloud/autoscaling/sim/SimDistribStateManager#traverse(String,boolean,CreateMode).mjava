  // this method should always be invoked under lock
  private Node traverse(String path, boolean create, CreateMode mode) throws IOException {
    if (path == null || path.isEmpty()) {
      return null;
    }
    throttleOrError(path);
    if (path.charAt(0) == '/') {
      path = path.substring(1);
    }
    StringBuilder currentPath = new StringBuilder();
    String[] elements = path.split("/");
    Node parentNode = root;
    Node n = null;
    for (int i = 0; i < elements.length; i++) {
      String currentName = elements[i];
      currentPath.append('/');
      n = parentNode.children != null ? parentNode.children.get(currentName) : null;
      if (n == null) {
        if (create) {
          if ((parentNode.mode == CreateMode.EPHEMERAL || parentNode.mode == CreateMode.EPHEMERAL_SEQUENTIAL) &&
              (mode == CreateMode.EPHEMERAL || mode == CreateMode.EPHEMERAL_SEQUENTIAL)) {
            throw new IOException("NoChildrenEphemerals for " + parentNode.path);
          }
          if (CreateMode.PERSISTENT_SEQUENTIAL == mode || CreateMode.EPHEMERAL_SEQUENTIAL == mode) {
            currentName = currentName + String.format(Locale.ROOT, "%010d", parentNode.seq);
            parentNode.seq++;
          }
          currentPath.append(currentName);
          n = new Node(parentNode, currentName, currentPath.toString(), mode, id);
          parentNode.setChild(currentName, n);
        } else {
          break;
        }
      } else {
        currentPath.append(currentName);
      }
      parentNode = n;
    }
    return n;
  }

