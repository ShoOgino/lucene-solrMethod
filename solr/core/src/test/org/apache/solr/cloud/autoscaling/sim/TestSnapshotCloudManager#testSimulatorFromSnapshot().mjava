  @Test
  public void testSimulatorFromSnapshot() throws Exception {
    Path tmpPath = createTempDir();
    File tmpDir = tmpPath.toFile();
    SnapshotCloudManager snapshotCloudManager = new SnapshotCloudManager(realManager, null);
    snapshotCloudManager.saveSnapshot(tmpDir, true);
    SnapshotCloudManager snapshotCloudManager1 = SnapshotCloudManager.readSnapshot(tmpDir);
    try (SimCloudManager simCloudManager = SimCloudManager.createCluster(snapshotCloudManager1, null, TimeSource.get("simTime:50"))) {
      assertClusterStateEquals(snapshotCloudManager.getClusterStateProvider().getClusterState(), simCloudManager.getClusterStateProvider().getClusterState());
      assertNodeStateProvider(snapshotCloudManager, simCloudManager);
      assertDistribStateManager(snapshotCloudManager.getDistribStateManager(), simCloudManager.getDistribStateManager());
      ClusterState state = simCloudManager.getClusterStateProvider().getClusterState();
      Replica r = state.getCollection(CollectionAdminParams.SYSTEM_COLL).getReplicas().get(0);
      // get another node
      String target = null;
      for (String node : simCloudManager.getClusterStateProvider().getLiveNodes()) {
        if (!node.equals(r.getNodeName())) {
          target = node;
          break;
        }
      }
      if (target == null) {
        fail("can't find suitable target node for replica " + r + ", liveNodes=" + simCloudManager.getClusterStateProvider().getLiveNodes());
      }
      CollectionAdminRequest.MoveReplica moveReplica = CollectionAdminRequest
          .moveReplica(CollectionAdminParams.SYSTEM_COLL, r.getName(), target);
      log.info("################");
      simCloudManager.simGetSolrClient().request(moveReplica);
    }
  }

