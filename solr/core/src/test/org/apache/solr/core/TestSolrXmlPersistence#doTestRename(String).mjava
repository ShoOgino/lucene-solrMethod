  private void doTestRename(String which) throws Exception {
    CoreContainer cc = init(SOLR_XML_LOTS_SYSVARS, "SystemVars1", "SystemVars2");
    try {
      final CoreAdminHandler admin = new CoreAdminHandler(cc);
      SolrQueryResponse resp = new SolrQueryResponse();
      admin.handleRequestBody
          (req(CoreAdminParams.ACTION,
              CoreAdminParams.CoreAdminAction.RENAME.toString(),
              CoreAdminParams.CORE, which,
              CoreAdminParams.OTHER, "RenamedCore"),
              resp);
      assertNull("Exception on rename", resp.getException());

      File persistXml = new File(solrHomeDirectory, "rename.solr.xml");
      File origXml = new File(solrHomeDirectory, "solr.xml");

      // OK, Assure that if I change everything that has been renamed with the original value for the core, it matches
      // the old list
      cc.persistFile(persistXml);
      String[] persistList = getAllNodes(persistXml);
      String[] expressions = new String[persistList.length];

      for (int idx = 0; idx < persistList.length; ++idx) {
        expressions[idx] = persistList[idx].replaceAll("RenamedCore", which);
      }

      assertXmlFile(origXml, expressions);

      // Now the other way, If I replace the original name in the original XML file with "RenamedCore", does it match
      // what was persisted?
      persistList = getAllNodes(origXml);
      expressions = new String[persistList.length];
      for (int idx = 0; idx < persistList.length; ++idx) {
        // /solr/cores/core[@name='SystemVars1' and @collection='${collection:collection1}']
        expressions[idx] = persistList[idx].replace("@name='" + which + "'", "@name='RenamedCore'");
      }

      assertXmlFile(persistXml, expressions);
    } finally {
      cc.shutdown();
      if (solrHomeDirectory.exists()) {
        FileUtils.deleteDirectory(solrHomeDirectory);
      }
    }
  }

