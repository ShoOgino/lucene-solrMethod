  @Test
  public void testJmxOnCoreReload() throws Exception {

    SolrMetricManager mgr = h.getCoreContainer().getMetricManager();
    String registryName = h.getCore().getCoreMetricManager().getRegistryName();
    String coreName = h.getCore().getName();
    String coreHashCode = String.valueOf(h.getCore().hashCode());
    Map<String, SolrMetricReporter> reporters = mgr.getReporters(registryName);
    // take first JMX reporter
    SolrJmxReporter reporter = null;
    for (Map.Entry<String, SolrMetricReporter> e : reporters.entrySet()) {
      if (e.getKey().endsWith(coreHashCode) && e.getValue() instanceof SolrJmxReporter) {
        reporter = (SolrJmxReporter)e.getValue();
        break;
      }
    }
    assertNotNull("could not find JMX reporter for " + registryName, reporter);
    String tag = reporter.getInstanceTag();

    Set<ObjectInstance> oldBeans = mbeanServer.queryMBeans(null, null);
    int oldNumberOfObjects = 0;
    for (ObjectInstance bean : oldBeans) {
      try {
        if (tag.equals(mbeanServer.getAttribute(bean.getObjectName(), JmxMetricsReporter.INSTANCE_TAG))) {
          oldNumberOfObjects++;
        }
      } catch (AttributeNotFoundException e) {
        // expected
      }
    }

    int totalCoreMetrics = mgr.registry(registryName).getMetrics().size();
    log.info("Before Reload: size of all core metrics: " + totalCoreMetrics + " MBeans: " + oldNumberOfObjects);
    assertEquals("Number of registered MBeans is not the same as the number of core metrics", totalCoreMetrics, oldNumberOfObjects);
    h.getCoreContainer().reload(coreName);

    reporters = mgr.getReporters(registryName);
    coreHashCode = String.valueOf(h.getCore().hashCode());
    // take first JMX reporter
    reporter = null;
    for (Map.Entry<String, SolrMetricReporter> e : reporters.entrySet()) {
      if (e.getKey().endsWith(coreHashCode) && e.getValue() instanceof SolrJmxReporter) {
        reporter = (SolrJmxReporter)e.getValue();
        break;
      }
    }
    assertNotNull("could not find JMX reporter for " + registryName, reporter);
    tag = reporter.getInstanceTag();

    Set<ObjectInstance> newBeans = mbeanServer.queryMBeans(null, null);
    int newNumberOfObjects = 0;
    try (SolrCore core = h.getCoreContainer().getCore(coreName)) {
      totalCoreMetrics = mgr.registry(registryName).getMetrics().size();
      for (ObjectInstance bean : newBeans) {
        try {
          if (tag.equals(mbeanServer.getAttribute(bean.getObjectName(), JmxMetricsReporter.INSTANCE_TAG))) {
            newNumberOfObjects++;
          }
        } catch (AttributeNotFoundException e) {
          // expected
        }
      }
    }

    log.info("After Reload: size of all core metrics: " + totalCoreMetrics + " MBeans: " + newNumberOfObjects);
    assertEquals("Number of registered MBeans is not the same as the number of core metrics", totalCoreMetrics, newNumberOfObjects);
  }

