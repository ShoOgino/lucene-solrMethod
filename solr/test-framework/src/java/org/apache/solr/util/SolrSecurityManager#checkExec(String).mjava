  // TODO: move this stuff into a Solr (non-test) SecurityManager!
  /**
   * {@inheritDoc}
   * <p>This method implements hacks to workaround hadoop's garbage Shell and FileUtil code
   */
  @Override
  public void checkExec(String cmd) {
    // NOTE: it would be tempting to just allow anything from hadoop's Shell class, but then
    // that would just give an easy vector for RCE (use hadoop Shell instead of e.g. ProcessBuilder)
    // so we whitelist actual caller impl methods instead.
    for (StackTraceElement element : Thread.currentThread().getStackTrace()) {
      // hadoop insists on shelling out to get the user's supplementary groups?
      if ("org.apache.hadoop.security.ShellBasedUnixGroupsMapping".equals(element.getClassName()) &&
          "getGroups".equals(element.getMethodName())) {
        return;
      }
      // hadoop insists on shelling out to parse 'df' command instead of using FileStore?
      if ("org.apache.hadoop.fs.DF".equals(element.getClassName()) &&
          "getFilesystem".equals(element.getMethodName())) {
        return;
      }
      // hadoop insists on shelling out to parse 'du' command instead of using FileStore?
      if ("org.apache.hadoop.fs.DU".equals(element.getClassName()) &&
          "refresh".equals(element.getMethodName())) {
        return;
      }
      // hadoop insists on shelling out to parse 'ls' command instead of java nio apis?
      if ("org.apache.hadoop.util.DiskChecker".equals(element.getClassName()) &&
          "checkDir".equals(element.getMethodName())) {
        return;
      }
      // hadoop insists on shelling out to parse 'stat' command instead of Files.getAttributes?
      if ("org.apache.hadoop.fs.HardLink".equals(element.getClassName()) &&
          "getLinkCount".equals(element.getMethodName())) {
        return;
      }
      // hadoop "canExecute" method doesn't handle securityexception and fails completely.
      // so, lie to it, and tell it we will happily execute, so it does not crash.
      if ("org.apache.hadoop.fs.FileUtil".equals(element.getClassName()) &&
          "canExecute".equals(element.getMethodName())) {
        return;
      }
    }
    super.checkExec(cmd);
  }

