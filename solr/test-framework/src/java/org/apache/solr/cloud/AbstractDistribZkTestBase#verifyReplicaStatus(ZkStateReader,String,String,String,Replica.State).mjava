  public static void verifyReplicaStatus(ZkStateReader reader, String collection, String shard, String coreNodeName, Replica.State expectedState) throws InterruptedException {
    int maxIterations = 100;
    Replica.State coreState = null;
    while(maxIterations-->0) {
      final DocCollection docCollection = reader.getClusterState().getCollectionOrNull(collection);
      if(docCollection != null && docCollection.getSlice(shard)!=null) {
        Slice slice = docCollection.getSlice(shard);
        Replica replica = slice.getReplicasMap().get(coreNodeName);
        if (replica != null) {
          coreState = replica.getState();
          if(coreState == expectedState) {
            return;
          }
        }
      }
      Thread.sleep(50);
    }
    fail("Illegal state, was: " + coreState + " expected:" + expectedState + " clusterState:" + reader.getClusterState());
  }

