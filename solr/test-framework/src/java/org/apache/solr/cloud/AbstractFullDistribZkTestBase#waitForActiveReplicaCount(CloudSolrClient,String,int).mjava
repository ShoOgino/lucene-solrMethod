  protected void waitForActiveReplicaCount(CloudSolrClient client, String collection, int expectedNumReplicas) throws TimeoutException, NotInClusterStateException {
    AtomicInteger nReplicas = new AtomicInteger();
    try {
      client.getZkStateReader().waitForState(collection, 30, TimeUnit.SECONDS, (c) -> {
        if (c == null)
          return false;
        int numReplicas = getTotalReplicas(c, c.getName());
        nReplicas.set(numReplicas);
        if (numReplicas == expectedNumReplicas) return true;

        return false;
      });
    } catch (TimeoutException | InterruptedException e) {
      try {
        printLayout();
      } catch (Exception e1) {
        throw new RuntimeException(e1);
      }
      throw new NotInClusterStateException(ErrorCode.SERVER_ERROR,
          "Number of replicas in the state does not match what we set:" + nReplicas + " vs " + expectedNumReplicas);
    }
  }

