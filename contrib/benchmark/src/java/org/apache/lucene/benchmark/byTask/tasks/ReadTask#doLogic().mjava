  public int doLogic() throws Exception {
    int res = 0;
    boolean closeReader = false;
    
    // open reader or use existing one
    IndexReader ir = getRunData().getIndexReader();
    if (ir == null) {
      Directory dir = getRunData().getDirectory();
      ir = IndexReader.open(dir);
      closeReader = true;
      //res++; //this is confusing, comment it out
    }
    
    // optionally warm and add num docs traversed to count
    if (withWarm()) {
      Document doc = null;
      for (int m = 0; m < ir.maxDoc(); m++) {
        if (!ir.isDeleted(m)) {
          doc = ir.document(m);
          res += (doc==null ? 0 : 1);
        }
      }
    }
    
    if (withSearch()) {
      res++;
      IndexSearcher searcher = new IndexSearcher(ir);
      QueryMaker queryMaker = getQueryMaker();
      Query q = queryMaker.makeQuery();
      Hits hits = searcher.search(q);
      //System.out.println("searched: "+q);
      
      if (withTraverse() && hits!=null) {
        int traversalSize = Math.min(hits.length(), traversalSize());
        if (traversalSize > 0) {
          boolean retrieve = withRetrieve();
          for (int m = 0; m < hits.length(); m++) {
            int id = hits.id(m);
            res++;
            if (retrieve) {
              res += retrieveDoc(ir, id);
            }
          }
        }
      }
      
      searcher.close();
    }
    
    if (closeReader) {
      ir.close();
    }
    return res;
  }

