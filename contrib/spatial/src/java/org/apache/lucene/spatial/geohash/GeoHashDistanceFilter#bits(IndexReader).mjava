  @Override
  public BitSet bits(IndexReader reader) throws IOException {

    /* Create a BitSet to store the result */
    int maxdocs = reader.numDocs();
    BitSet bits = new BitSet(maxdocs);
    
    setPrecision(maxdocs);
    // create an intermediate cache to avoid recomputing
    //   distances for the same point 
    //   TODO: Why is this a WeakHashMap? 
    WeakHashMap<String,Double> cdistance = new WeakHashMap<String,Double>(maxdocs);
    
    String[] geoHashCache = FieldCache.DEFAULT.getStrings(reader, geoHashField);
    

    /* store calculated distances for reuse by other components */
    distances = new HashMap<Integer,Double>(maxdocs);
    for (int i = 0 ; i < maxdocs; i++) {
      
      String geoHash = geoHashCache[i];
      double[] coords = GeoHashUtils.decode(geoHash);
      double x = coords[0];
      double y = coords[1];
      
      // round off lat / longs if necessary
//      x = DistanceHandler.getPrecision(x, precise);
//      y = DistanceHandler.getPrecision(y, precise);
      
      
      Double cachedDistance = cdistance.get(geoHash);
      
      
      double d;
      
      if(cachedDistance != null){
        d = cachedDistance.doubleValue();
      } else {
        d = DistanceUtils.getInstance().getDistanceMi(lat, lng, x, y);
        cdistance.put(geoHash, d);
      }
      distances.put(i, d);
      
      if (d < distance){
        bits.set(i);
      }
      
    }
    
    return bits;
  }

