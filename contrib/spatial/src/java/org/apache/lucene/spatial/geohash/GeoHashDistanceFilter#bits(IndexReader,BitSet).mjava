  @Override
  public BitSet bits(IndexReader reader, BitSet bits) throws Exception {

  
    /* Create a BitSet to store the result */
    int size = bits.cardinality();
    BitSet result = new BitSet(size);
    

    /* create an intermediate cache to avoid recomputing
         distances for the same point  */
    HashMap<String,Double> cdistance = new HashMap<String,Double>(size);
    

    /* store calculated distances for reuse by other components */
    offset += reader.maxDoc();
    if (distances == null)
    	distances = new HashMap<Integer,Double>(size);
    
    long start = System.currentTimeMillis();
    String[] geoHashCache = FieldCache.DEFAULT.getStrings(reader, geoHashField);
 
    /* loop over all set bits (hits from the boundary box filters) */
    int i = bits.nextSetBit(0);
    while (i >= 0){
      
      // if we have a completed
      // filter chain, lat / lngs can be retrived from 
      // memory rather than document base.

      String geoHash = geoHashCache[i];
      double[] coords = GeoHashUtils.decode(geoHash);
      double x = coords[0];
      double y = coords[1];
      
      // round off lat / longs if necessary
//      x = DistanceHandler.getPrecision(x, precise);
//      y = DistanceHandler.getPrecision(y, precise);

      
      Double cachedDistance = cdistance.get(geoHash);
      double d;
      
      if(cachedDistance != null){
        d = cachedDistance.doubleValue();
        
      } else {
        d = DistanceUtils.getInstance().getDistanceMi(lat, lng, x, y);
        //d = DistanceUtils.getLLMDistance(lat, lng, x, y);
        cdistance.put(geoHash, d);
      }
      
      distances.put(i, d);
        
      if (d < distance){
        result.set(i);
      }
      i = bits.nextSetBit(i+1);
    }
    
    long end = System.currentTimeMillis();
    log.fine("Time taken : "+ (end - start) + 
        ", results : "+ distances.size() + 
        ", cached : "+ cdistance.size() +
        ", incoming size: "+ size);
  

    cdistance = null;
    nextOffset += offset;
    return result;
  }

